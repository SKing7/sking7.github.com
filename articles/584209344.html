<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Detecting duplicate images using Python</title>
<link rel="stylesheet" href="../css/article.css" />
</head>
<body>
<div class="m-content">
<h1>Detecting duplicate images using Python</h1>
<div itemprop="mainContentOfPage"><h2>With thousands of icons being uploaded every month, the risk of pirated content also increases. To keep out the swindlers we have been working on a new clever image duplication technique.</h2><p>One of the features that came out of our <a href="/iconfinder-hackathon-day-1/">little hackaton</a> and will be rolling out in the next couple of weeks is the ability to detect duplicate icons upon submission. So, for example if a user for example downloads an existing icon and tries to re-upload it in order to sell it and make a profit (yes, we had some of those cases) we will be able to detect it as a duplicate of an already existing icon and mark the account as fraudulent.</p><p>A frequently used solution to identify if a given file already exists in a large collection of files is to calculate a hash for each individual file in the dataset, store the hashes in a database and then when we want to locate a particular file calculate the hash for that file and look up to see if it’s hash value exists in the database.</p><h2>Picking a hashing algorithm</h2><p>A commonly used type of hash algorithms for this are the cryptographic hashing algorithms. Implementations of the most common used ones like MD5, SHA-1, SHA-256 are available in the standard library of almost any programming language and they are really easy to use and work really well for the most simple use cases.</p><p>For instance, in Python you would simply import the <tt>hashlib</tt> module and call a function to generate the hash value for a particular string or file.</p><!-- Crayon Syntax Highlighter v2.4.1 --><div id="crayon-533d532a10b46028719845" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
    &gt;&gt;&gt; import hashlib

    # Calculating the hash value of a string.
    &gt;&gt;&gt; hashlib.md5('The quick brown fox jumps over the lazy dog').hexdigest()
    '9e107d9d372bb6826bd81d3542a419d6'

    # Loading an image file into memory and calculating it's hash value.
    &gt;&gt;&gt; image_file = open('data/cat_grumpy_orig.png').read()
    &gt;&gt;&gt; hashlib.md5(image_file).hexdigest()
    '3e1f6e9f2689d59b9ed28bcdab73455f'</textarea></p><div><table>
<tr>
<td data-settings="hide">

</td>
<td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>import</span><span> </span><span>hashlib</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Calculating the hash value of a string.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>hashlib</span><span>.</span><span>md5</span><span>(</span><span>'The quick brown fox jumps over the lazy dog'</span><span>)</span><span>.</span><span>hexdigest</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>'9e107d9d372bb6826bd81d3542a419d6'</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Loading an image file into memory and calculating it's hash value.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>image_file</span><span> </span><span>=</span><span> </span><span>open</span><span>(</span><span>'data/cat_grumpy_orig.png'</span><span>)</span><span>.</span><span>read</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>hashlib</span><span>.</span><span>md5</span><span>(</span><span>image_file</span><span>)</span><span>.</span><span>hexdigest</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>'3e1f6e9f2689d59b9ed28bcdab73455f'</span></p></div></td>
</tr>
</table></div></div><!-- [Format Time: 0.0030 seconds] --><p>This would work fine and dandy if we where sure the files uploaded aren’t tampered with but due to the nature of how cryptographic hashing algorithms work even the slightest change to the input will result in an <a href="http://en.wikipedia.org/wiki/Avalanche_effect">avalanche effect</a> so the generated hash of the new file will be totally different from the one of the original file.</p><p>Let’s take an example where we add a period at the end of the sentence.</p><!-- Crayon Syntax Highlighter v2.4.1 --><div id="crayon-533d532a10b62169824336" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
    # Original text.
    &gt;&gt;&gt; hashlib.md5('The quick brown fox jumps over the lazy dog').hexdigest()
    '9e107d9d372bb6826bd81d3542a419d6'

    # Slight modification of the text.
    &gt;&gt;&gt; hashlib.md5('The quick brown fox jumps over the lazy dog.').hexdigest()
    'e4d909c290d0fb1ca068ffaddf22cbd0'</textarea></p><div><table>
<tr>
<td data-settings="hide">

</td>
<td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Original text.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>hashlib</span><span>.</span><span>md5</span><span>(</span><span>'The quick brown fox jumps over the lazy dog'</span><span>)</span><span>.</span><span>hexdigest</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>'9e107d9d372bb6826bd81d3542a419d6'</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Slight modification of the text.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>hashlib</span><span>.</span><span>md5</span><span>(</span><span>'The quick brown fox jumps over the lazy dog.'</span><span>)</span><span>.</span><span>hexdigest</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>'e4d909c290d0fb1ca068ffaddf22cbd0'</span></p></div></td>
</tr>
</table></div></div><!-- [Format Time: 0.0018 seconds] --><p>As you can see in the example above, the values <tt>9e107d9d372bb6826bd81d3542a419d6</tt> and <tt>e4d909c290d0fb1ca068ffaddf22cbd0</tt> are completely different.</p><p>In the case of images if the background color is changed, the image is cropped or rotated or if just one pixel is modified out of the original image, we won’t be able to match the hash of the image to an already existing one. This is not really practical since we want to detect similar images, even if they have been modified a little.</p><p>For example when we modify the color of the nose on the cat the computed hash value will be completely different.</p><div id="attachment_4515"><a href="/wp-content/uploads/2014/04/cat_grumpy_orig.png"><img alt="Original image" src="/wp-content/uploads/2014/04/cat_grumpy_orig.png.pagespeed.ce.DKikVpT0GC.png" width="256" height="256" /></a><p>Original image</p></div><p><div id="attachment_4512"><a href="/wp-content/uploads/2014/04/cat_grumpy_modif.png"><img alt="Modified image" src="/wp-content/uploads/2014/04/cat_grumpy_modif.png.pagespeed.ce.Ql__tmYIOK.png" width="256" height="256" /></a><p>Modified image</p></div><br /><!-- Crayon Syntax Highlighter v2.4.1 -->
<div id="crayon-533d532a10b6a077122852" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
    # Load the original image into memory and calculate it's hash value.
    &gt;&gt;&gt; image_file = open('data/cat_grumpy_orig.png').read()
    &gt;&gt;&gt; hashlib.md5(image_file).hexdigest()
    '3e1f6e9f2689d59b9ed28bcdab73455f'

    # Load the modified image into memory and calculate it's hash value.
    &gt;&gt;&gt; image_file_modified = open('data/cat_grumpy_modif.png').read()
    &gt;&gt;&gt; hashlib.md5(image_file_modified).hexdigest()
    '12d1b9409c3e8e0361c24beaee9c0ab1'</textarea></p><div><table>
<tr>
<td data-settings="hide">

</td>
<td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Load the original image into memory and calculate it's hash value.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>image_file</span><span> </span><span>=</span><span> </span><span>open</span><span>(</span><span>'data/cat_grumpy_orig.png'</span><span>)</span><span>.</span><span>read</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>hashlib</span><span>.</span><span>md5</span><span>(</span><span>image_file</span><span>)</span><span>.</span><span>hexdigest</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>'3e1f6e9f2689d59b9ed28bcdab73455f'</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Load the modified image into memory and calculate it's hash value.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>image_file_modified</span><span> </span><span>=</span><span> </span><span>open</span><span>(</span><span>'data/cat_grumpy_modif.png'</span><span>)</span><span>.</span><span>read</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>hashlib</span><span>.</span><span>md5</span><span>(</span><span>image_file_modified</span><span>)</span><span>.</span><span>hexdigest</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>'12d1b9409c3e8e0361c24beaee9c0ab1'</span></p></div></td>
</tr>
</table></div></div>
<!-- [Format Time: 0.0028 seconds] -->
<br />What we needed for our use case is a <em>perceptual</em> hashing algorithm. A perceptual hashing algorithm that takes a fingerprint of a multimedia file by deriving it from various features from its content so it can take into account transformations on a given input and yet be flexible enough to distinguish between dissimilar files.</p><p>There are a number of perceptual hashing algorithms but the one that I’m gonna present is the <a href="http://www.hackerfactor.com/blog/index.php?/archives/529-Kind-of-Like-That.html">dHash</a> (difference hashing) algorithm which computes the difference in brightness between adjacent, identifying the relative gradient direction.</p><h2>dHash</h2><p>Before we dive into the algorithm, let’s start with some basics. An color image is comprised out of red, green and blue (RGB) pixels and we can think of it as an list of sets of red, green and blue values. For example, let’s take an image, load it using Python’s imaging library (<a href="http://www.pythonware.com/products/pil/">PIL</a>) and print the pixel values.</p><p><div id="attachment_4518"><a href="/wp-content/uploads/2014/04/test_image.jpg"><img alt="Test image" src="/wp-content/uploads/2014/04/test_image-300x300.jpg.pagespeed.ce.JxHQjSEXKB.jpg" width="300" height="300" /></a><p>Test image</p></div><br /><!-- Crayon Syntax Highlighter v2.4.1 -->
<div id="crayon-533d532a10b71498755172" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
    &gt;&gt;&gt; from PIL import Image
    &gt;&gt;&gt; test_image  = Image.open('data/test_image.jpg')

    # The image is an RGB image with a size of 8x8 pixels.
    &gt;&gt;&gt; print 'Image Mode: %s' % test_image.mode
    Image Mode: RGB
    &gt;&gt;&gt; print 'Width: %s px, Height: %s px' % (test_image.size[0], test_image.size[1])
    Width: 4 px, Height: 4 px

    # Get the pixel values from the image and print them into rows based on
    # the image's width.
    &gt;&gt;&gt; width, height = test_image.size
    &gt;&gt;&gt; pixels = list(test_image.getdata())
    &gt;&gt;&gt; for col in xrange(width):
    ...   print pixels[col:col+width]
    ...
    [(255, 0, 0), (0, 255, 0), (0, 0, 255), (255, 255, 255)]
    [(0, 0, 0), (212, 45, 45), (51, 92, 154), (130, 183, 47)]
    [(206, 210, 198), (131, 78, 8), (131, 156, 180), (117, 155, 201)]
    [(104, 133, 170), (215, 130, 20), (153, 155, 155), (104, 142, 191)]</textarea></p><div><table>
<tr>
<td data-settings="hide">
<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p></div>
</td>
<td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>from</span><span> </span><span>PIL </span><span>import</span><span> </span><span>Image</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>test_image</span><span>&nbsp;&nbsp;</span><span>=</span><span> </span><span>Image</span><span>.</span><span>open</span><span>(</span><span>'data/test_image.jpg'</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># The image is an RGB image with a size of 8x8 pixels.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>print</span><span> </span><span>'Image Mode: %s'</span><span> </span><span>%</span><span> </span><span>test_image</span><span>.</span><span>mode</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Image </span><span>Mode</span><span>:</span><span> </span><span>RGB</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>print</span><span> </span><span>'Width: %s px, Height: %s px'</span><span> </span><span>%</span><span> </span><span>(</span><span>test_image</span><span>.</span><span>size</span><span>[</span><span>0</span><span>]</span><span>,</span><span> </span><span>test_image</span><span>.</span><span>size</span><span>[</span><span>1</span><span>]</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Width</span><span>:</span><span> </span><span>4</span><span> </span><span>px</span><span>,</span><span> </span><span>Height</span><span>:</span><span> </span><span>4</span><span> </span><span>px</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Get the pixel values from the image and print them into rows based on</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># the image's width.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>width</span><span>,</span><span> </span><span>height</span><span> </span><span>=</span><span> </span><span>test_image</span><span>.</span><span>size</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>pixels</span><span> </span><span>=</span><span> </span><span>list</span><span>(</span><span>test_image</span><span>.</span><span>getdata</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>for</span><span> </span><span>col </span><span>in</span><span> </span><span>xrange</span><span>(</span><span>width</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>.</span><span>.</span><span>&nbsp;&nbsp; </span><span>print</span><span> </span><span>pixels</span><span>[</span><span>col</span><span>:</span><span>col</span><span>+</span><span>width</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>.</span><span>.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>(</span><span>255</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>0</span><span>)</span><span>,</span><span> </span><span>(</span><span>0</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>0</span><span>)</span><span>,</span><span> </span><span>(</span><span>0</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>255</span><span>)</span><span>,</span><span> </span><span>(</span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>)</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>(</span><span>0</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>0</span><span>)</span><span>,</span><span> </span><span>(</span><span>212</span><span>,</span><span> </span><span>45</span><span>,</span><span> </span><span>45</span><span>)</span><span>,</span><span> </span><span>(</span><span>51</span><span>,</span><span> </span><span>92</span><span>,</span><span> </span><span>154</span><span>)</span><span>,</span><span> </span><span>(</span><span>130</span><span>,</span><span> </span><span>183</span><span>,</span><span> </span><span>47</span><span>)</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>(</span><span>206</span><span>,</span><span> </span><span>210</span><span>,</span><span> </span><span>198</span><span>)</span><span>,</span><span> </span><span>(</span><span>131</span><span>,</span><span> </span><span>78</span><span>,</span><span> </span><span>8</span><span>)</span><span>,</span><span> </span><span>(</span><span>131</span><span>,</span><span> </span><span>156</span><span>,</span><span> </span><span>180</span><span>)</span><span>,</span><span> </span><span>(</span><span>117</span><span>,</span><span> </span><span>155</span><span>,</span><span> </span><span>201</span><span>)</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>(</span><span>104</span><span>,</span><span> </span><span>133</span><span>,</span><span> </span><span>170</span><span>)</span><span>,</span><span> </span><span>(</span><span>215</span><span>,</span><span> </span><span>130</span><span>,</span><span> </span><span>20</span><span>)</span><span>,</span><span> </span><span>(</span><span>153</span><span>,</span><span> </span><span>155</span><span>,</span><span> </span><span>155</span><span>)</span><span>,</span><span> </span><span>(</span><span>104</span><span>,</span><span> </span><span>142</span><span>,</span><span> </span><span>191</span><span>)</span><span>]</span></p></div></td>
</tr>
</table></div></div>
<!-- [Format Time: 0.0216 seconds] -->
<br />The first three pixels have an intensity value of 255 for red, green and blue respectively and 0 for other values, white has all three values at their maximum intensity (255) and black has all three values at their lowest intensity (0). The rest of the color pixels are a combination of red, green and blue at different intensities.</p><p>Now let’s get back on track, the dHash algorithm has four steps, I’m gonna go through each one and illustrate it’s effects on the original and modified image.</p><h3>1. Grayscale the image.</h3><p>By grayscaling the image we reduce each pixel value to an luminous intensity value. For example, a white pixel (255, 255, 255) will be reduced to an intensity value of 255 and a black pixel (0, 0, 0) will be reduced to an intensity value of 0.</p><div id="attachment_4516"><a href="/wp-content/uploads/2014/04/cat_grumpy_orig_step_1.png"><img alt="Original image (after step 1)" src="/wp-content/uploads/2014/04/cat_grumpy_orig_step_1.png.pagespeed.ce.dpnTokpaoA.png" width="256" height="256" /></a><p>Original image (after step 1)</p></div><div id="attachment_4513"><a href="/wp-content/uploads/2014/04/cat_grumpy_modif_step_1.png"><img alt="Modified image (after step 1)" src="/wp-content/uploads/2014/04/cat_grumpy_modif_step_1.png.pagespeed.ce.EG7HjzMSQE.png" width="256" height="256" /></a><p>Modified image (after step 1)</p></div><h3>2. Shrink the image to a common size.</h3><p>By shrinking the image to a common base size, for example 9×8 pixels, where the width is 1px larger than the height (you’ll understand why the odd size in step 3). This way we remove all the high frequencies and details of the image and we are left with a sample size of 72 intensity values. This also means that resizing or stretching an image won’t affect it’s hash value, all images are normalized to a common size.</p><div id="attachment_4517"><a href="/wp-content/uploads/2014/04/cat_grumpy_orig_step_2.png"><img alt="Original image (after step 2)" src="/wp-content/uploads/2014/04/cat_grumpy_orig_step_2.png.pagespeed.ce.vGzzQd-mk9.png" width="180" height="160" /></a><p>Original image (after step 2)</p></div><div id="attachment_4514"><a href="/wp-content/uploads/2014/04/cat_grumpy_modif_step_2.png"><img alt="Modified image (after step 2)" src="/wp-content/uploads/2014/04/cat_grumpy_modif_step_2.png.pagespeed.ce.g76QzyGiSC.png" width="180" height="160" /></a><p>Modified image (after step 2)</p></div><h3>3. Compare adjacent pixels.</h3><p>After the previous two steps we are left with an list containing intensity values, we then compare each intensity value to it’s adjacent value for each row resulting in a binary array.</p><!-- Crayon Syntax Highlighter v2.4.1 --><div id="crayon-533d532a10b7a673680045" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
    &gt;&gt;&gt; from PIL import Image
    &gt;&gt;&gt; img = Image.open('data/cat_grumpy_orig_after_step_2.png')
    &gt;&gt;&gt; width, height = img.size
    &gt;&gt;&gt; pixels = list(img.getdata())
    &gt;&gt;&gt; for col in xrange(width):
    ...   print pixels[col:col+width]
    ...
    [254, 254, 255, 253, 248, 254, 255, 254, 255]
    [254, 255, 253, 248, 254, 255, 254, 255, 255]
    [255, 253, 248, 254, 255, 254, 255, 255, 255]
    [253, 248, 254, 255, 254, 255, 255, 255, 222]
    [248, 254, 255, 254, 255, 255, 255, 222, 184]
    [254, 255, 254, 255, 255, 255, 222, 184, 177]
    [255, 254, 255, 255, 255, 222, 184, 177, 184]
    [254, 255, 255, 255, 222, 184, 177, 184, 225]
    [255, 255, 255, 222, 184, 177, 184, 225, 255]</textarea></p><div><table>
<tr>
<td data-settings="hide">

</td>
<td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>from</span><span> </span><span>PIL </span><span>import</span><span> </span><span>Image</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>img</span><span> </span><span>=</span><span> </span><span>Image</span><span>.</span><span>open</span><span>(</span><span>'data/cat_grumpy_orig_after_step_2.png'</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>width</span><span>,</span><span> </span><span>height</span><span> </span><span>=</span><span> </span><span>img</span><span>.</span><span>size</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>pixels</span><span> </span><span>=</span><span> </span><span>list</span><span>(</span><span>img</span><span>.</span><span>getdata</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>for</span><span> </span><span>col </span><span>in</span><span> </span><span>xrange</span><span>(</span><span>width</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>.</span><span>.</span><span>&nbsp;&nbsp; </span><span>print</span><span> </span><span>pixels</span><span>[</span><span>col</span><span>:</span><span>col</span><span>+</span><span>width</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>.</span><span>.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>254</span><span>,</span><span> </span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>253</span><span>,</span><span> </span><span>248</span><span>,</span><span> </span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>254</span><span>,</span><span> </span><span>255</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>253</span><span>,</span><span> </span><span>248</span><span>,</span><span> </span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>255</span><span>,</span><span> </span><span>253</span><span>,</span><span> </span><span>248</span><span>,</span><span> </span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>253</span><span>,</span><span> </span><span>248</span><span>,</span><span> </span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>222</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>248</span><span>,</span><span> </span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>222</span><span>,</span><span> </span><span>184</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>222</span><span>,</span><span> </span><span>184</span><span>,</span><span> </span><span>177</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>255</span><span>,</span><span> </span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>222</span><span>,</span><span> </span><span>184</span><span>,</span><span> </span><span>177</span><span>,</span><span> </span><span>184</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>254</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>222</span><span>,</span><span> </span><span>184</span><span>,</span><span> </span><span>177</span><span>,</span><span> </span><span>184</span><span>,</span><span> </span><span>225</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>255</span><span>,</span><span> </span><span>222</span><span>,</span><span> </span><span>184</span><span>,</span><span> </span><span>177</span><span>,</span><span> </span><span>184</span><span>,</span><span> </span><span>225</span><span>,</span><span> </span><span>255</span><span>]</span></p></div></td>
</tr>
</table></div></div><!-- [Format Time: 0.0244 seconds] --><p>The first value (254) will be compared to the second value (254), the second value to the third and so on, giving us 8 boolean values per row.</p><!-- Crayon Syntax Highlighter v2.4.1 --><div id="crayon-533d532a10b81809305591" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
    &gt;&gt;&gt; difference = []
    &gt;&gt;&gt; for row in xrange(height):
    ...   for col in xrange(width):
    ...     if col != width:
    ...       difference.append(pixels[col+row] &gt; pixels[(col+row)+1])
    ...
    &gt;&gt;&gt; for col in xrange(width-1):
    ...   print difference[col:col+(width-1)]
    ...
    [False, False, True, True, False, False, True, False]
    [False, True, True, False, False, True, False, False]
    [True, True, False, False, True, False, False, False]
    [True, False, False, True, False, False, False, True]
    [False, False, True, False, False, False, True, True]
    [False, True, False, False, False, True, True, False]
    [True, False, False, False, True, True, False, False]
    [False, False, False, True, True, False, False, True]</textarea></p><div><table>
<tr>
<td data-settings="hide">
<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p></div>
</td>
<td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>difference</span><span> </span><span>=</span><span> </span><span>[</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>for</span><span> </span><span>row </span><span>in</span><span> </span><span>xrange</span><span>(</span><span>height</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>.</span><span>.</span><span>&nbsp;&nbsp; </span><span>for</span><span> </span><span>col </span><span>in</span><span> </span><span>xrange</span><span>(</span><span>width</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>.</span><span>.</span><span>&nbsp;&nbsp;&nbsp;&nbsp; </span><span>if</span><span> </span><span>col</span><span> </span><span>!=</span><span> </span><span>width</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>.</span><span>.</span><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>difference</span><span>.</span><span>append</span><span>(</span><span>pixels</span><span>[</span><span>col</span><span>+</span><span>row</span><span>]</span><span> </span><span>&gt;</span><span> </span><span>pixels</span><span>[</span><span>(</span><span>col</span><span>+</span><span>row</span><span>)</span><span>+</span><span>1</span><span>]</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>.</span><span>.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>for</span><span> </span><span>col </span><span>in</span><span> </span><span>xrange</span><span>(</span><span>width</span><span>-</span><span>1</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>.</span><span>.</span><span>&nbsp;&nbsp; </span><span>print</span><span> </span><span>difference</span><span>[</span><span>col</span><span>:</span><span>col</span><span>+</span><span>(</span><span>width</span><span>-</span><span>1</span><span>)</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>.</span><span>.</span><span>.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>False</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>False</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>True</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>True</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>True</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>True</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>False</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>False</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>True</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>[</span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>True</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>False</span><span>,</span><span> </span><span>True</span><span>]</span></p></div></td>
</tr>
</table></div></div><!-- [Format Time: 0.0228 seconds] --><h3>4. Convert the difference into bits.</h3><p>To make the hash easy to store and use, we convert it into a hexadecimal string. A True value will have a binary value of 1 and a False value will have one of 0.</p><h2>Python implementation</h2><p>A full implementation of the algorithm in Python:</p><!-- Crayon Syntax Highlighter v2.4.1 --><div id="crayon-533d532a10b88335261851" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
    def dhash(image, hash_size = 8):
        # Grayscale and shrink the image in one step.
        image = image.convert('L').resize(
            (hash_size + 1, hash_size),
            Image.ANTIALIAS,
        )

        pixels = list(image.getdata())

        # Compare adjacent pixels.
        difference = []
        for row in xrange(hash_size):
            for col in xrange(hash_size):
                pixel_left = image.getpixel((col, row))
                pixel_right = image.getpixel((col + 1, row))
                difference.append(pixel_left &gt; pixel_right)

        # Convert the binary array to a hexadecimal string.
        decimal_value = 0
        hex_string = []
        for index, value in enumerate(difference):
            if value:
                decimal_value += 2**(index % 8)
            if (index % 8) == 7:
                hex_string.append(hex(decimal_value)[2:].rjust(2, '0'))
                decimal_value = 0

        return ''.join(hex_string)</textarea></p><div><table>
<tr>
<td data-settings="hide">
<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p></div>
</td>
<td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>dhash</span><span>(</span><span>image</span><span>,</span><span> </span><span>hash_size</span><span> </span><span>=</span><span> </span><span>8</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Grayscale and shrink the image in one step.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>image</span><span> </span><span>=</span><span> </span><span>image</span><span>.</span><span>convert</span><span>(</span><span>'L'</span><span>)</span><span>.</span><span>resize</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>hash_size</span><span> </span><span>+</span><span> </span><span>1</span><span>,</span><span> </span><span>hash_size</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>Image</span><span>.</span><span>ANTIALIAS</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pixels</span><span> </span><span>=</span><span> </span><span>list</span><span>(</span><span>image</span><span>.</span><span>getdata</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Compare adjacent pixels.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>difference</span><span> </span><span>=</span><span> </span><span>[</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>row </span><span>in</span><span> </span><span>xrange</span><span>(</span><span>hash_size</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>col </span><span>in</span><span> </span><span>xrange</span><span>(</span><span>hash_size</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pixel_left</span><span> </span><span>=</span><span> </span><span>image</span><span>.</span><span>getpixel</span><span>(</span><span>(</span><span>col</span><span>,</span><span> </span><span>row</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pixel_right</span><span> </span><span>=</span><span> </span><span>image</span><span>.</span><span>getpixel</span><span>(</span><span>(</span><span>col</span><span> </span><span>+</span><span> </span><span>1</span><span>,</span><span> </span><span>row</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>difference</span><span>.</span><span>append</span><span>(</span><span>pixel_left</span><span> </span><span>&gt;</span><span> </span><span>pixel_right</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Convert the binary array to a hexadecimal string.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>decimal_value</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>hex_string</span><span> </span><span>=</span><span> </span><span>[</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>index</span><span>,</span><span> </span><span>value </span><span>in</span><span> </span><span>enumerate</span><span>(</span><span>difference</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>value</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>decimal_value</span><span> </span><span>+</span><span>=</span><span> </span><span>2</span><span>*</span><span>*</span><span>(</span><span>index</span><span> </span><span>%</span><span> </span><span>8</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>index</span><span> </span><span>%</span><span> </span><span>8</span><span>)</span><span> </span><span>==</span><span> </span><span>7</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>hex_string</span><span>.</span><span>append</span><span>(</span><span>hex</span><span>(</span><span>decimal_value</span><span>)</span><span>[</span><span>2</span><span>:</span><span>]</span><span>.</span><span>rjust</span><span>(</span><span>2</span><span>,</span><span> </span><span>'0'</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>decimal_value</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>''</span><span>.</span><span>join</span><span>(</span><span>hex_string</span><span>)</span></p></div></td>
</tr>
</table></div></div><!-- [Format Time: 0.0183 seconds] --><h2>Comparing hashes</h2><p>In the most simple case where the images differ only slightly the hashes most likely will be the same so we can directly compare them.</p><!-- Crayon Syntax Highlighter v2.4.1 --><div id="crayon-533d532a10b8e958558582" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
    &gt;&gt;&gt; from PIL import Image
    &gt;&gt;&gt; from utility import dhash, hamming_distance
    &gt;&gt;&gt; orig = Image.open('data/cat_grumpy_orig.png')
    &gt;&gt;&gt; modif = Image.open('data/cat_grumpy_modif.png')
    &gt;&gt;&gt; dhash(orig)
    '4c8e3366c275650f'
    &gt;&gt;&gt; dhash(modif)
    '4c8e3366c275650f'
    &gt;&gt;&gt; dhash(orig) == dhash(modif)
    True</textarea></p><div><table>
<tr>
<td data-settings="hide">

</td>
<td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>from</span><span> </span><span>PIL </span><span>import</span><span> </span><span>Image</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>from</span><span> </span><span>utility </span><span>import</span><span> </span><span>dhash</span><span>,</span><span> </span><span>hamming_distance</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>orig</span><span> </span><span>=</span><span> </span><span>Image</span><span>.</span><span>open</span><span>(</span><span>'data/cat_grumpy_orig.png'</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>modif</span><span> </span><span>=</span><span> </span><span>Image</span><span>.</span><span>open</span><span>(</span><span>'data/cat_grumpy_modif.png'</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>dhash</span><span>(</span><span>orig</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>'4c8e3366c275650f'</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>dhash</span><span>(</span><span>modif</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>'4c8e3366c275650f'</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>&gt;&gt;&gt;</span><span> </span><span>dhash</span><span>(</span><span>orig</span><span>)</span><span> </span><span>==</span><span> </span><span>dhash</span><span>(</span><span>modif</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>True</span></p></div></td>
</tr>
</table></div></div><!-- [Format Time: 0.0036 seconds] --><p>If we kept an SQL database with our hashes and we wanted to see if the ’4c8e3366c275650f’ hash existed in our database we could simply do something like this:</p><!-- Crayon Syntax Highlighter v2.4.1 --><div id="crayon-533d532a10b93113381846" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
    SELECT pk, hash, file_path FROM image_hashes
        WHERE hash = '4c8e3366c275650f';</textarea></p><div><table>
<tr>
<td data-settings="hide">

</td>
<td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>SELECT</span><span> </span>pk,<span> </span><span>hash</span>,<span> </span>file_path<span> </span><span>FROM</span><span> </span>image_hashes</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>WHERE</span><span> </span><span>hash</span><span> </span>=<span> </span><span>'4c8e3366c275650f'</span>;</p></div></td>
</tr>
</table></div></div><!-- [Format Time: 0.0019 seconds] --><p>Now, in the case that the images differ a bit more and the hashes are not exactly the same we need to compare them by calculating the minimum number of substitutions required to change one string into the other, this is called a hamming distance.</p><p>On <a href="http://en.wikipedia.org/wiki/Hamming_distance">the Wikipedia page</a> there is some sample Python code that computes the hamming distance between two string but we can calculate the hamming distance and query based on it directly in MySQL:</p><!-- Crayon Syntax Highlighter v2.4.1 --><div id="crayon-533d532a10b99806407436" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
    SELECT pk, hash, BIT_COUNT(
        CONV(hash, 16, 10) ^ CONV('4c8e3366c275650f', 16, 10)
    ) as hamming_distance
        FROM image_hashes
        HAVING hamming_distance &lt; 4
        ORDER BY hamming_distance ASC;</textarea></p><div><table>
<tr>
<td data-settings="hide">

</td>
<td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>SELECT</span><span> </span>pk,<span> </span><span>hash</span>,<span> </span><span>BIT_COUNT</span>(</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>CONV</span>(<span>hash</span>,<span> </span>16,<span> </span>10)<span> </span>^<span> </span><span>CONV</span>(<span>'4c8e3366c275650f'</span>,<span> </span>16,<span> </span>10)</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span>)<span> </span><span>as</span><span> </span>hamming_distance</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>FROM</span><span> </span>image_hashes</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>HAVING</span><span> </span>hamming_distance<span> </span><span>&lt;</span><span> </span>4</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ORDER BY</span><span> </span>hamming_distance<span> </span><span>ASC</span>;</p></div></td>
</tr>
</table></div></div><!-- [Format Time: 0.0027 seconds] --><p>It will do a binary XOR of the two values, the first one from the database and the second one the one that we query, and count the bits that are different amongst the two values. Because BIT_COUNT works only on integers and we stored the hash as a hex string (base 16) we have to convert it to a decimal value (base 10), the same goes for the value that we want to query by.</p><h2>Ending words</h2><p>Even though I’ve presented the algorithm using Python snippets the algorithm is pretty general and can implemented in any other programming language.</p><p>As I said in the introduction, we will be using using the algorithm in the future on Iconfinder to warn us if an submitted icon already exists in our collection but it can also have other practical uses. For example, because images with similar features have the hamming distance of their hashes close, it can also be used as a basic recomandation system where the recomended images are within a certain hashing distance of the current image.</p></div></div>
<script>var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-34802167-1']); _gaq.push(['_setDomainName', 'liuzhe.co']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();</script></body>
</html>