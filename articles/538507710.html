<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>New iFrame Injections Leverage PNG Image Metadata</title>
<link rel="stylesheet" href="../css/article.css" />
</head>
<body>
<div class="m-content">
<h1>New iFrame Injections Leverage PNG Image Metadata</h1>
<div><p>We’re always trying to stay ahead of the latest trends, and today we caught a very interesting one that we have either been missing, or it’s new. We’ll just say it’s new.. <img src="http://blog.sucuri.net/wp-includes/images/smilies/icon_wink.gif" alt=";)" /> </p><p>We’re all familiar with the idea of iFrame Injections, right? </p><h4>Understanding an iFrame Injection</h4><p>The <strong>iFrame</strong> HTML tag is very standard today, it’s an easy way to embed content from another site into your own. It’s supported by almost all browsers and employed by millions of websites today, use Adsense? Then you have an iFrame embedded within your site too. </p><p>Pretty nifty, I know. Like with most things though, the good is always accompanied with the bad.<br /><span id="more-8714"></span><br />In today’s attacks, especially when we’re talking about drive-by-downloads, leveraging the iFrame tag is often the preferred method. It’s simple and easy, and with a few attribute modifications, the attacker is able to embed code from another site, often compromised, and load something via the client’s browser without them knowing (i.e., silently). </p><p>It would look something like this:</p><p><a href="http://blog.sucuri.net/2014/02/new-iframe-injections-leverage-png-image-metadata.html/iframe-sample" rel="attachment wp-att-8723"><img src="http://blog.sucuri.net/wp-content/uploads/2014/01/iframe-sample.png" alt="iframe sample" width="619" height="88" /></a></p><p>Attackers normally embed a malicious file from another site, often in the form of a PHP file or something similar. This of course is not the only method, but the most prevalent. From a detection and remediation standpoint, these are often fairly straight forward to fix. </p><h4>New iFrame Injection Method</h4><p>Today however we found an interesting type of iFrame injection. </p><p>The uniqueness is not in the use of an iFrame tag to embed the content, but rather in how it distributes the malware. You see, the attacker obfuscated the payload inside a <strong>PNG</strong> file. </p><p>I can almost hear the lot of you snickering, pff.. this isn’t new…. but it’s all in the details my friends. </p><p>You see, the iFrame was loading a valid file, nothing malicious, it was a JavaScript file, <strong>jquery.js</strong>. For all intents and purposed, the file was good. Here, look for yourself:</p><p><a href="http://blog.sucuri.net/wp-content/uploads/2014/01/blog_injection1.png" rel="lightbox"><img src="http://blog.sucuri.net/wp-content/uploads/2014/01/blog_injection1-494x650.png" alt="blog_injection1" width="494" height="650" /></a></p><p>At first, like many of you, we were stumped. I mean the code is good, no major issues, right? Then we noticed this little function, <strong>loadFile()</strong>. The function itself wasn’t curious, but the fact that it was loading a PNG was – <strong>var strFile = ‘./dron.png</strong>. You’d be surprised how long of staring it takes to notice something like that, I know hindsight is a real kicker. </p><p>Naturally our next step was to open that curious <strong>dron.png</strong> file. I mean, what could go wrong?</p><p>Well, absolutely nothing, it’s perhaps the most boring thing I have ever seen, lovely. What a waste of time…</p><p><a href="http://blog.sucuri.net/2014/02/new-iframe-injections-leverage-png-image-metadata.html/sucuri-iframe-png" rel="attachment wp-att-8720"><img src="http://blog.sucuri.net/wp-content/uploads/2014/01/Sucuri-iframe-png.png" alt="Sucuri-iframe-png" width="265" height="160" /></a></p><p>But wait, we then noticed this interesting little loop:</p><p><a href="http://blog.sucuri.net/2014/02/new-iframe-injections-leverage-png-image-metadata.html/sucuri-png-decoding-loop" rel="attachment wp-att-8721"><img src="http://blog.sucuri.net/wp-content/uploads/2014/01/Sucuri-PNG-Decoding-Loop.png" alt="Sucuri-PNG-Decoding-Loop" width="700" height="152" /></a></p><p>Well that’s surely curious, it has a decoding loop. Why would it need a decoding loop for a PNG file? </p><p>Like any good researcher, I went about it the easy way, why worry about breaking down an image when I can just load the image on a test page and take the content. For the win!! </p><p>After loading it on a test page this is what we were able to pull from the <strong>strData</strong> variable:</p><p><a href="http://blog.sucuri.net/2014/02/new-iframe-injections-leverage-png-image-metadata.html/sucuri-png-iframe-payload" rel="attachment wp-att-8722"><img src="http://blog.sucuri.net/wp-content/uploads/2014/01/sucuri-png-iframe-payload.png" alt="sucuri-png-iframe-payload" width="378" height="149" /></a></p><p>Do you see what it is doing?</p><p>It’s taking the normal behavior of an iFrame injection, embedding it within the meta of the PNG file and just like that we have a new distribution mechanism.</p><p>A couple of areas to pay special attention too. You see where they use the <strong>createElement</strong> to use an <strong>iFrame</strong>, then you should see where they place the iFrame out of view to the naked eye via their <strong>elm.style.position.left and elm.style.position.top</strong> elements by placing it at <strong>-1000px</strong>. That’s right, you can’t see a negative placement in your browser, everything is positive. But you know who can? That’s right, the browser itself sees it and so does Google, nice little technique both for drive-by-download and Search Engine Poisoning (SEP) attacks.</p><p>Lastly of course we have the payload, which can found on that domain set in the <strong>elm.src</strong> element. </p><h4>Why is this Unique and what is the benefit?</h4><p>This is unique because in the level of effort being taken to obfuscate the payload. Most scanners today will not decode the meta in the image, they would stop at the <strong>JavaScript</strong> that is being loaded, but they won’t follow the cookie trail. This also talks to the benefit, at least for attackers, it’s exceptionally difficult to detect. </p><p>Do make note however that while in this specific case we’re talking about PNG, the concepts do and can apply to other image file types as well. This only puts more emphasis on the importance of being <a href="http://sucuri.net/signup">aware of the state of your web server, understanding what files are and aren’t being added and modified</a> and <a href="http://cloudproxy.sucuri.net">ensuring that vulnerabilities are not being exploited</a>. </p><p>As is often the case, some creative sleuthing and troubleshooting allowed us to spend the time required to find this lovely little gem. Do we detect it now via our <a href="http://sitecheck.sucuri.net">Website Malware Scanner</a>? Absolutely!!! </p><p>Stay frosty my friends!!</p></div></div>
<script>var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-34802167-1']); _gaq.push(['_setDomainName', 'liuzhe.co']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();</script></body>
</html>