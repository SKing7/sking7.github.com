




 


<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7, IE=9" />
	<title>图灵社区 : 阅读 : 从VOA慢速英语的网站上下载Mp3与PDF文本的Python脚本</title>

<link href="/Content/2012/css/style?v=0EAQ_XOLvMkr4D-XN-sUslEuAQV-NvWL60R1FJc2-pA1" rel="stylesheet"/>



<!--[if IE 6]>
<link href="/Content/2012/css/ie6.min.css" rel="stylesheet">
<![endif]--> 

<script src="/js/frontend?v=WrwLFUrDgS45U5wI2E2GN6NKxBmZFQ9vbPlz1WOeRbw1"></script>



<!--Le HTML5 shim, for IE6-8 support of HTML5 elements-->
<!--[if lt IE 9]>
<script src="/Content/2012/js/html5.js"></script>
<![endif]-->
<!--[if IE 6]>
<script src="/Content/2012/js/ie6.min.js"></script>
<![endif]-->
<!--Le fav and touch icons-->
<link rel="shortcut icon" href="/favicon.ico">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/Content/2012/img/icon-touch-114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/Content/2012/img/icon-touch-72.png">
<link rel="apple-touch-icon-precomposed" href="/Content/2012/img/icon-touch-57.png">

</head>
<body>
	<div id="topnav"><div class="page">

	
        <!--Donut#D8C7C6DFBDB19F6B8361D6EA0A71CB2AE72A9D98AFCF831CB5549AF8AAA96279399B936BFA8E2F493B516A9EB6DE379D89BA3F3FEC094C6F1F24FB47254F404CC0023A2D171A181B1EAABB1C1D3C821381518FE87B119F6AA918DD666B02FA8EB11F7B0D471B0C0399DEE2E12B6B79EFD2F8C6399370EAEB2C5174A4CFC83A1A98FABCBA74BACABBC73F7CE662CD8F0C14D7493868D68327C9316267B29368E0E70F2D64AB54EC5BFD130BA623BEB76E1A6A5E66E3F7E37F3926C3CBDCFC3F072E69E7A20A1E6BEAE4512DE40273C128FE28452C11A7B595C361CC8E1CB107B06205460E7D529AAAEEDF813F2A4A2ACEAE0327032E8FC3D6FF08F07EEE845F2D922225120A0ADD6935D050DA7339C1FF1A255854B12FD700E957E89AC6B5FF2508F7E693C69BA5E9279A07C839E39F8E8858AAD82458F5C6D82CBEED93F13D131838F8CE93C8C01122558C0C695460B46734707BA22EC04B2284D083288A0D740D6BB6A54F05407DF11B4BD19259D899790FB93721627304D2C705AF20C86693B66F7DC74437D49C601EEFA48984A0FF#-->	<ul id="usermenu">
		<li>你好！</li>


		<li><a href="/account/register">新会员注册</a></li>
		<li><a href="/account/logon">登录</a></li>

	</ul>
<!--EndDonut-->
    

	</div></div>
	<div class="page">
		<div id="header">
			<a href="/" id="title" title="图灵社区 首页">◁ 首页</a>
			<div id="menucontainer">
				<ul id="menu" class="article" >
					
					<form id="nav-search" class="form-search" action="/search" method="get">
					  <input type="search" id="q" name="q" />
					  <input type="hidden" id="type" name="type" />
					  <input type="submit" id="search-btn" value="搜索" />
					</form>

					<li><a class="ebooks" href="/book/ebook?sort=updated">电子书</a></li>
					<li><a class="book" href="/book">图 书</a></li>
					<li><a class="article" href="/article?sort=newest">文 章</a></li>
					<li><a class="users" href="/users">会 员</a></li>
					<li><a class="write" href="/users/mywriting">写 作</a></li>
				</ul>
			</div>
		</div>
		<div id="main" class="clearfix">
			



<script type="text/javascript">

    $(function () {
        $("pre").addClass("prettyprint");
        prettyPrint();
    });
    
    function onCloneSuccess(data) {
        alert(data);
    }

    function onDonateSuccess(data) {
        alert(data);

        if (data.substring(0, 4) != "赠银失败") {
            $("#donate_btn").remove();
            $("#donate_info").show();
        }
            
    }
</script>

<div class="row">
    <div class="span9">
        <div id="question-header">
            <h1>
                <a href="/article/50268">从VOA慢速英语的网站上下载Mp3与PDF文本的Python脚本</a> 
            </h1>
        </div>

        <div class="row">
            <div class="span1 votecell">
                <div id="votediv" class="vote">
    
<a data-ajax="true" data-ajax-begin="$(&#39;#vote-50268&#39;).html(&#39;取消推荐&#39;)" data-ajax-mode="replace" data-ajax-update="#votediv" href="/article/vote/50268" id="vote-50268">推荐</a>
    <strong>1</strong>

    <a data-ajax="true" data-ajax-begin="$(&#39;#fav-50268&#39;).html(&#39;取消收藏&#39;)" data-ajax-mode="replace" data-ajax-update="#votediv" href="/article/vote/50268?isFave=True" id="fav-50268">收藏</a>

</div>






            </div>
            <div class="span8">
                <div class="post-text">
<p>想通过听写练习来提高自己的英语听力。<a href="http://www.voanews.com/learningenglish/home/">VOA慢速英语</a>语速很慢（约100－120字/分钟），发音标准清晰，内容丰富（包括新闻、词汇谚语、人物故事等），提供录音及文本下载，是非常不错的入门听写材料。</p>

<p>为什么要写脚本来下载呢？首先，虽然VOA有对应的Podcast节目，更新方便，但下载链接在大陆是无法访问的，只能看到节目有更新，就是无法下载。其次，每天手动到VOA网站上去下载，似乎太傻瓜，这种重复性地工作应该要自动化处理的。</p>

<p>从网页中抓取内容是非常常见的应用，处理流程一般就是下载网页，用正则或其他解析html的工具提取需要的链接，再下载链接内容。在写这个脚本的过程中，遇到并解决了以下几个问题，记录在此。</p>

<ul>
<li>提取节目的下载链接</li>
<li>下载内容时显示进度条</li>
<li>保证文件能够完全下载，避免重复下载</li>
<li>使用Socks代理来解决GFW的问题</li>
</ul>

<h2>提取节目的下载链接</h2>

<p>需要获取3个数据：节目标题、节目PDF链接、节目Mp3链接。</p>

<p>VOS慢速英语除了Podcast外，还提供了RSS订阅，可以直接解析RSS内容来获取Mp3的下载链接；但是RSS输出中没有PDF文本的链接，所以我选择了直接拉取web页面，用正则来提取内容。</p>

<p>VOA慢速英语目前有7个主题，在每个主题自己的页面可以看到当月更新的节目（我没有找到可以列出所有节目的页面）。在每期节目自己的页面中，可以找到PDF的下载链接；但是Mp3的链接还需要进入在线收听页面才能找到。</p>

<p>这是<a href="http://learningenglish.voanews.com/programindex.html">主题列表页面</a>部分截图：<img src="/download/01YZBHPoDwDG.small" alt="enter image description here"/>
这是某个<a href="http://learningenglish.voanews.com/archive/as-it-is/latest/3521/3521.html">主题下面最新节目列表页面</a>部分截图：<img src="/download/01YZBHQIYVzw" alt="enter image description here"/>
这是<a href="http://learningenglish.voanews.com/content/un-wpf-syria-heart-swimming/1705955.html">PDF下载链接与Mp3在线收听页面</a>部分截图：<img src="/download/01YZBHRMAgB8" alt="enter image description here"/></p>

<h2>下载内容时显示进度条</h2>

<p>知道当前的进度总是一件减少焦虑感的事情。找到需要的下载链接后，使用Python的<code>urllib.urlretrieve()</code>这个方法来下载文件。<code>urllib.urlretrieve()</code>的语法如下：</p>

<pre><code>urlretrieve(url, filename=None, reporthook=None, data=None)
</code></pre>

<p>其中，reporthook是接收一定数据后要调用的函数，可以利用此回调函数来实现进度条的功能，reporthook函数的定义如下：</p>

<pre><code>reporthook(blocknum, blocksize, totalsize)
</code></pre>

<p>其中，blocknum是接收到的数据包个数，blocksize是数据包的字节数，totalsize是总的需要下载的字节数。对传入的参数进行简单处理就可以得到当前的下载进度。如果直接用print语句输出结果的话，每次调用此函数都会产生新的一行，这显然不是进度条的行为，我们希望在同一行更新进度。首先使用<code>sys.stdout.write()</code>代替print语句可以去掉print自动输出的换行符。然后，在每次输出内容时，先输出回车符（&#39;\b&#39;）让光标回到行首，这样就可以在当前行输出内容，实现进度条的行为。reporthook函数的代码如下：</p>

<pre><code># show download progress
# 此函数感谢 http://ljdam.iteye.com/blog/1415336 的分享
def reporthook(blocks_read,block_size,total_size):  
    if not blocks_read:  
        print (&quot;Connection opened&quot;)  
    if total_size &lt;0:  
        sys.stdout.write(&quot;\rRead %d blocks   &quot;  % blocks_read)
        sys.stdout.flush()
    else:  
        sys.stdout.write(&quot;\rdownloading: %d KB, totalsize: %d KB   &quot; % (blocks_read*block_size/1024.0,total_size/1024.0))
        sys.stdout.flush()
</code></pre>

<h2>保证文件能够完全下载，避免重复下载</h2>

<p>首先避免重复下载，当本地已存在待下载文件时，先从服务器上获取待下载的字节数，与本地文件对比，如果大小相等，那么认为已经正常下载，跳过此文件。这里存在一个问题，有的服务器在hearder中不包含<code>Content-Length</code>这个字段，这时无法判断是否已完全下载。考虑到这种情况很少，且重复下载代价较高，所以也不下载此文件。</p>

<pre><code>if os.path.isfile(file_path):
    # check length
    length_s = urllib.urlopen( url ).info().get(&#39;Content-Length&#39;, 0)
    length_l = os.path.getsize( file_path )
    if length_s == 0 or long(length_s) == length_l:
        return True
</code></pre>

<p>然后避免出现未下载完成的文件。在下载时，当关闭程序窗口、手动停止(Ctrl+C)、出现错误时，会在文件系统中残留未下载完成的文件，考虑到这种文件会影响收听，所以应当避免出现未下载完成的文件。处理的思路是，如果在下载过程中遇到任何异常，那么首先删除未完成的邮件，然后将异常冒泡进行后续处理。</p>

<pre><code>try:
    urllib.urlretrieve(url, file_path, reporthook)
except:
    os.remove( file_path)
    raise
else:
    return True
</code></pre>

<h2>使用Socks代理来解决GFW的问题</h2>

<p>首先感谢<a href="http://blog.csdn.net/mscf/article/details/7552297">这个博客</a>的分享。Python可以通过SocksiPy模块来使用Socks代理。SocksiPy的下载与安装见<a href="http://socksipy.sourceforge.net/">官网</a>。这部分的代码如下：</p>

<pre><code>import socks
socks.setdefaultproxy(socks.PROXY_TYPE_SOCKS5, &#39;127.0.0.1&#39;, 9050, rdns=False)
socket.socket = socks.socksocket
</code></pre>

<p>这里首先设置了socks的代理信息，<code>socks.PROXY_TYPE_SOCKS5</code>表示类型为socks5，<code>127.0.0.1</code>与<code>9050</code>分别是代理的IP与端口。我这里使用的是本机作为代理。然后用具有代理功能的套接字覆盖系统缺省的套接字，后续连接就全部走代理了，非常方便。</p>

<p>完整代码请访问这个<a href="https://gist.github.com/yinchuan/6069808">gist</a>。最后是程序运行截图：<img src="/download/01YZBHKEh9Zn" alt="enter image description here"/></p>
                </div>

                <div class="copyright-announce">
                             本文仅用于学习和交流目的，不代表图灵社区观点。非商业转载请注明作译者、出处，并保留本文的原始链接。
                </div>
                <div class="post-taglist">

                         <a class="post-tag" href="/article/tagged/11" tagid="11">python</a>
                                                            <!-- JiaThis Button BEGIN -->
                        <div id="ckepop">
                            

                            <a class="jiathis_cwb" target="_blank" href="/article/share/50268">分享长微博</a>
                            
                            <span class="jiathis_txt"></span><a class="jiathis_button_tsina"></a><a class="jiathis_button_douban"></a><a class="jiathis_button_tqq"></a><a class="jiathis_button_linkedin"></a><a href="http://www.jiathis.com/share?uid=891559" target="_blank" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis"></a><a class="jiathis_counter_style"></a>
                        </div>
                    <!-- JiaThis Button END -->
                </div>
            </div>
        </div>

        <div class="row">
            <div class="span9">
                <div class="well">

                    <div class="btn-admins pull-right">





                    </div>
                    <div class="user-info clearfix">
                         <a href="/users/99133">
                             <img class="avatar show-user-card" userid="99133"  src="/Users/GetAvatar/99133?size=Middle" />yinchuan
                         </a> <br />
                         <span class="status-date">发表于 07-24 19:42
                         </span>
                    </div>
                </div>
            </div>
        </div>
        
            <div id="wumii">
                <script type="text/javascript" id="wumiiRelatedItems"></script>
            </div>
<script type="text/javascript">
    var wumiiPermaLink = "http://www.ituring.com.cn/article/50268"; //请用代码生成文章永久的链接
    var wumiiTitle = "从VOA慢速英语的网站上下载Mp3与PDF文本的Python脚本"; //请用代码生成文章标题
    var wumiiTags = "python"; //请用代码生成文章标签，以英文逗号分隔，如："标签1,标签2"
    var wumiiSitePrefix = "http://www.ituring.com.cn/";
    var wumiiParams = "&num=6&mode=2&pf=JAVASCRIPT";
</script>
<script type="text/javascript" src="http://widget.wumii.com/ext/relatedItemsWidget"></script>
            <a name="firstcomment"></a>
            <div id="CommentList">
                
    <div class="subheader">
        <h1>
            评论</h1>
        <div id="tabs">
            <a class="" data-ajax="true" data-ajax-mode="replace" data-ajax-update="#CommentList" href="/articlecomment/index/50268?sort=newest">时间</a>
            <a class="youarehere" data-ajax="true" data-ajax-mode="replace" data-ajax-update="#CommentList" href="/articlecomment/index/50268?sort=vote">推荐</a>
        </div>
    </div>



    <div class="row reply-item" id="comment-17214">
    <div             class="firstcomment"
>
        <div class="span1 votecell">
            <div id="votediv17214" class="vote">
    
<a data-ajax="true" data-ajax-begin="$(&#39;#vote-17214&#39;).html(&#39;取消推荐&#39;)" data-ajax-mode="replace" data-ajax-update="#votediv17214" href="/ArticleComment/vote/17214" id="vote-17214">推荐</a>
    <strong>0</strong>

</div>



        </div>
        <div class="span8 postcell">
            <div class="post-text">
            IOError: [Errno 22] invalid mode (&#39;wb&#39;) or filename: &#39;D:\\VOA\\Caffeine-is-the-&quot;Drug&quot;-of-Choice-in-Many-Cultures.pdf&#39;<br/><br/>这个文件似乎一直下不了？是不是这个双引号导致的？
            </div>
            <div class="user-info clearfix pull-right user-comment">
                <img class="avatar show-user-card" userid="115929" src="/Users/GetAvatar/115929?size=Small" width="32" height="32" /><a class="show-user-card" href="/users/115929" userid="115929">tntnt</a><br />
                <span class="status-date"> 07-26 14:21 </span>
            </div>

            <div class="replies" id="replies-17214">
        <div id="reply-21838">
        <div class="reply"
          >
            <span class="comment-copy">是的。当时只做了功能，没有过滤title中的一些特殊字符，我马上处理一下。多谢反馈。</span> –&nbsp;
            <a class="show-user-card" userid="99133"  href="/users/info/99133" class="reply-user">yinchuan</a>
            <span class="status-date">07-26 15:36</span>
        </div>
        </div>        <div id="reply-21840">
        <div class="reply"
          >
            <span class="comment-copy">已修改。使用正则取出title中的单词，实现过滤特殊字符的目的。不过这样一来，文件名会改变，之前下载的文件有点会重复下载，抱歉啦。 &#39;-&#39;.join( re.findall(&#39;(\w+)&#39;, article_title[0]) )</span> –&nbsp;
            <a class="show-user-card" userid="99133"  href="/users/info/99133" class="reply-user">yinchuan</a>
            <span class="status-date">07-26 15:45</span>
        </div>
        </div>        <div id="reply-21866">
        <div class="reply"
          >
            <span class="comment-copy">多谢 @yinchuan</span> –&nbsp;
            <a class="show-user-card" userid="115929"  href="/users/info/115929" class="reply-user">tntnt</a>
            <span class="status-date">07-29 12:26</span>
        </div>
        </div>            </div>
            <div class="btn-replies">
            </div>
        </div>
    </div>
    </div>
    <hr />
    <div class="row reply-item" id="comment-17189">
    <div >
        <div class="span1 votecell">
            <div id="votediv17189" class="vote">
    
<a data-ajax="true" data-ajax-begin="$(&#39;#vote-17189&#39;).html(&#39;取消推荐&#39;)" data-ajax-mode="replace" data-ajax-update="#votediv17189" href="/ArticleComment/vote/17189" id="vote-17189">推荐</a>
    <strong>0</strong>

</div>



        </div>
        <div class="span8 postcell">
            <div class="post-text">
            源码可分享不？跑你博客，只看到 about me  :-)
            </div>
            <div class="user-info clearfix pull-right user-comment">
                <img class="avatar show-user-card" userid="92165" src="/Users/GetAvatar/92165?size=Small" width="32" height="32" /><a class="show-user-card" href="/users/92165" userid="92165">易枭寒</a><br />
                <span class="status-date"> 07-25 13:25 </span>
            </div>

            <div class="replies" id="replies-17189">
        <div id="reply-21826">
        <div class="reply"
          >
            <span class="comment-copy">源码在github上，https://gist.github.com/yinchuan/6069808  
这个脚本需要在本机上有一个socks5代理，我是用 MyEnTunnel生成的，如果会科学上网的话，肯定懂的。  
我现在主要在图灵上写文章，博客没用上。那个 about me页面是之前用来放简历的，sorry 误导你了。  
</span> –&nbsp;
            <a class="show-user-card" userid="99133"  href="/users/info/99133" class="reply-user">yinchuan</a>
            <span class="status-date">07-25 14:21</span>
        </div>
        </div>            </div>
            <div class="btn-replies">
            </div>
        </div>
    </div>
    </div>
    <hr />


        <h3>我要评论</h3>

    <div id="CommentForm">
            <div id="logon-div">
    


<form action="/account/_logon/50268?Length=7" class="well form-inline" data-ajax="true" data-ajax-failure="onLogonFail" data-ajax-success="onLogonSuccess" id="form0" method="post"><legend>需要登录后才能发言</legend>
<input data-val="true" data-val-required="请填写用户名" id="UserName" name="UserName" type="text" value="" />     
<input data-val="true" data-val-required="请填写密码" id="Password" name="Password" type="password" />     
<input data-val="true" data-val-required="The 记住我 field is required." id="RememberMe" name="RememberMe" type="checkbox" value="true" /><input name="RememberMe" type="hidden" value="false" />     
<label for="RememberMe">记住我</label>     
    <input type="submit" value=" 登录 " class="btn btn-primary" />
</form>
<div class="validation-summary-valid" data-valmsg-summary="true"><span>登录未成功，请修改提交。</span>
<ul><li style="display:none"></li>
</ul></div>


        <script type="text/javascript">

            function onLogonSuccess() {
                 $.get("/articlecomment/add/50268?isErrata=False", function (data) {
                    $("#CommentForm").html(data);
                    $.get("/account/_logonpartial", function(logdata) {
                        $("#logindisplay").html(logdata);
                    });
                });
            }

            function onLogonFail(jqXHR) {
                $("#logon-div").html(jqXHR.responseText);
            }  

        </script>


    </div>

    </div>



<div id="reply-form" class="hide">

<form action="/reply/add" data-ajax="true" data-ajax-begin="window.disableCalmer" data-ajax-failure="onReplyFailure" data-ajax-mode="after" data-ajax-success="onReplySuccess" data-ajax-update="#placeholder" id="form1" method="post">        <input type="hidden" name="" />
        <textarea name="body" style="width: 95%">
        </textarea>
        <br />
<input type="submit" value=" 提交 " class="btn btn-primary calmer" /> <input type="button" id="cancel" value=" 取消 " class="btn" /> <span id="reply-error" style="color: #c33"></span>
</form>
</div>

<script type="text/javascript">

    function onReplySuccess() {
        $(".add-reply").parent().show();
        $("#reply-form").hide();
        window.enableCalmer();
    }

    function onReplyFailure(jqXHR) {
        $("#reply-error").text(jqXHR.responseText);
        window.enableCalmer();
    }


    $(function () {

        $("#cancel").click(function () {
            $("#reply-form").hide();
            $(".add-reply").parent().show();
        });

        $(".add-reply").click(function () {
            var replyForm = $("#reply-form");
            replyForm.find("form").attr("data-ajax-update", "#replies-" + $(this).attr("target-id"))
            replyForm.find("input[type=hidden]").attr("name", $(this).attr("target-name"));
            replyForm.find("input[type=hidden]").val($(this).attr("target-id"));
            replyForm.find("textarea").val("");

            replyForm.show().appendTo($("#reply-form-" + $(this).attr("target-id")));
            $("#reply-error").text("");

            $(this).parent().hide();
            return false;
        });

    });
</script>

            </div>

    </div>
    <div class="span3 side-right">

        <div class="module">
<form action="/Article" method="post">            <div class="input-append">
            <input class="span2" id="keyword" name="keyword" type="text" value="" /><input type="submit" class="btn" value="搜索" />
            </div>
</form>        </div>



                         

                         


    <div id="related-tags" class="module">
        <h4 id="h-related-tags">
            本文标签</h4>

             <a class="post-tag" href="/article/tagged/11" tagid="11">python</a>
            <span class="item-multiplier">×&nbsp;810</span>
            <br/>

    </div>





    <div class="module">
        <h4 id="h-related-tags">
            推荐会员</h4>
            <a href="/users/82554" >
                <img class="side-avatar show-user-card" userid="82554" class="side-avatar" src="/Users/GetAvatar/82554?size=Small" width="32" height="32" />
            </a>
        <div style="clear:both"></div>
    </div>

    <div class="module">
        <h4 id="h-related-tags">
            相关标签</h4>


             <a class="post-tag" href="/article/tagged/2" tagid="2">web编程与设计</a>
            <span class="item-multiplier">×&nbsp;4</span>
            <br/>

    </div>



    </div>
</div>

		</div>
		
	</div>
	<div id="footer">
	  <div class="container">
		<ul id="footmenu">
			<li class="first"><a href="/users/guaguacode">刮刮卡</a></li>
			<li><a href="/article/36242">联系我们</a></li>
			<li><a href="/article/7751">常见问题</a></li>
			<li><a href="/article/17095">建议改进</a></li>
		</ul>
		<p>
		  2005-2013 &copy; 北京图灵文化发展有限公司 · All Rights Reserved
		</p>
		<p class="muted">
		  京ICP备11039595号
		</p>

	  </div>
	</div>
<div id="toTop">
<a href="#">▲</a>
<a href="#footer">▼</a>
</div>
		<div id="popup"><div class="user-card" id="tagcard"></div><p class="corner"></p></div>



<div class="modal fade hide" id="wModal">
  <div class="modal-header">
	<button type="button" class="close" data-dismiss="modal">×</button>
	<h4>modalMsg</h4>
  </div>
  <form action="" data-ajax="true" data-ajax-failure="modalMsgError" data-ajax-success="modalMsgSuccess" data-ajax-begin="window.disableCalmer" id="formModalMsg" method="post">
  <div class="modal-body">
	<textarea cols="20" id="msgBody" name="Body" rows="2" style="width:97%;height:80px;"></textarea>
	<input id="ReceiverUserName" name="ReceiverUserName" type="hidden" value="">
	<span id="error-span" style="color:red"></span>
	<span id="success-span" style="color:#080"></span>
  </div>
  <div class="modal-footer">
	<input type="button" class="btn" data-dismiss="modal" value="取消">
	<input type="submit" id="submitMsg" class="btn btn-message calmer" value=" 发 送 ">
  </div>
  </form>
</div>
		</body>



</html>