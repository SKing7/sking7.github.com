<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Concurrency in JavaScript | TypedArray.org</title>
<link rel="stylesheet" href="../css/article.css" />
</head>
<body>
<div class="m-content">
<h1>Concurrency in JavaScript | TypedArray.org</h1>
<div><header>
											
										</header><p>Just like with Flash, JavaScript code runs by default on the UI thread, and any expensive computation will usually affect the UI responsiveness. As you may know, at 60 fps, you have around 16ms (1000ms/60) per frame to do what you have to do (computations, rendering and other misc logic). If you exceed that budget, you will alter the frame rate and potentially make your content feel sluggish or worse, unresponsive.</p><div id="attachment_70"><img alt="Frame budget" src="http://typedarray.org/wp-content/uploads/2013/06/budget-frame-med.jpg" width="283" height="262" /><p>Frame budget</p></div><p>Web Workers are now broadly available in most browsers even on mobile <a title="Web Workers support" href="http://caniuse.com/#search=web%20workers" target="_blank">(caniuse.com stats for Web Workers)</a> and give you the power of concurrency from within JavaScript. It will allow you to move expensive computations to other threads, to permit best responsive programming, and ideally open the doors in the future&nbsp;to true parallelization in JavaScript. Let’s have a look at the reasons why you may be interested into leveraging Web Workers.</p><ul>
<li><span><em>Responsive programming</em>: When you have an expensive computation and don’t want to block the UI.</span></li>
<li><em>Parallel programming</em>: When you want to leverage multiple CPU cores by having computations running concurrently to solve a specific task.</li>
</ul><p>We will see later on that parallel programming with Web Workers can be challenging, and that they are not really designed for that today unfortunately. But before we dive into the details of responsive programming and parallel programming, let’s start with some more details about Web Workers. Note that we will cover here dedicated Web Workers, not the shared Web Workers.</p><h5><span>Workers and threads</span></h5><p>A very common question around Web Workers is how they compare to low-level threads available in other languages like C++, Java or C#.</p><p>First off, Web Workers are way more high-level and heavier than threads, when newing a Web Worker, you are actually instantiating a new JS VM. As a result, instantiating a Web Worker does indeed create another low-level thread behind the scenes to power the VM that runs your code, but you never work with it directly. Therefore, it is important to remember that the cost of a single Worker in memory is pretty high, and same for its instantiation time. Based on that, you can imagine that instantiating many workers on a mobile browser is usually not an option, in fact, most browsers have a limitation in the number of workers that can be allocated for that reason.</p><p>Another major difference with threads is how data passing works, where nothing is shared. As we will see later with Web Workers, data is passed by default through <strong>message cloning</strong>, in other words, any data passed is cloned. Given the overhead of cloning for large objects, you can also <strong>transfer ownership</strong> when needed. That allows you to pass the reference of your object to another Web Worker, without cloning it, you just lose its reference from where you sent it. It is a pretty elegant approach and very simple to use and works well with the responsive use cases.</p><h5>Workers and cores</h5><p>On a multi-core environment, multiple threads can truly run concurrently if distributed over multiple cores. On a single core system, the CPU performs what is called context switching betweens the threads. It happens so fast that you cannot actually tell the threads are not running concurrently but they truly aren’t. This leads to another common question: can I leverage multi-core architectures with Web Workers ? In other words, can I choose specifically which core to leverage?</p><p>That is not in your control, the OS will decide if the thread utilized by the instantiated VM is spawn on another core or not. It is also not possible to query the number of cores available, even if libraries have emerged to guess that, but you ideally want to stay out of this and let the OS balance things best for you.<span><br /></span></p><h5>Life as a worker</h5><p>You can use all of the JavaScript features inside a Worker, but the amount of browser APIs available is limited. The main restriction is that there is no way to display anything inside from a Worker, simply because there is no DOM available, which lives on the UI thread. Imaging making the DOM thread safe, that would be pretty tricky across workers. Hence why if you try to access the document object from within a worker, you will get the following runtime exception:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd17e294370552" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
Uncaught ReferenceError: document is not defined</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>Uncaught </span><span>ReferenceError</span><span>:</span><span> </span><span>document </span><span>is</span><span> </span><span>not</span><span> </span><span>defined</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0010 seconds] --><p>At this point, an error event will be dispatched by the worker, that can be listened to. As a result, it is impossible to render anything on screen from a Web Worker. To achieve this, you will have to send the object back to the main (UI) thread for display. A very classic scenario is anything related to image processing. Given how expensive image processing can be, it is very tempting to offload the expensive code to a Web Worker. In the initial Web Workers specification, it was not possible to pass an <a title="ImageData (canvas)" href="https://developer.mozilla.org/en-US/docs/Web/API/ImageData" target="_blank">ImageData</a> object between Web Workers, you had to pass an array of pixel colors. Recently, the specification got updated to allow message passing of ImageData objects, which is quite nice, given that many use cases rely on image/bitmap manipulation.</p><p>Another important use case is resource loading. You may want to load a remote resource from a worker, and that is possible through the XMLHttpRequest object. That is very useful if you want to do some expensive parsing of a resource that you are loading within a game, like parsing an object model, or more simply logging to a server some analytics you have been cooking within a background worker. You can find <a title="Functions available from within Web Workers" href="https://developer.mozilla.org/en-US/docs/DOM/Worker/Functions_available_to_workers" target="_blank">here</a> more details about the functions available from within Web Workers.</p><p>Another thing you may try is to use the console to log things from within a worker, this is also not supported, but you can build a wrapper on top of the postMessage API that we will cover in a few minutes. David Flanagan has posted one&nbsp;<a title="WorkerConsole" href="https://github.com/davidflanagan/WorkerConsole/" target="_blank">there</a>&nbsp;which works well. In addition, you can also use the Chrome Dev Tools which offer you a way to debug Web Workers.</p><h5>Instantiating a Worker</h5><p>To instantiate a worker, two approaches are available. The first one requires you to point to the JavaScript code needed to run in the background:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd195870836486" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
var worker = new Worker("background.js");</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>var</span><span> </span><span>worker</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Worker</span><span>(</span><span>"background.js"</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0012 seconds] --><p>When the script logic is passed to the Worker object, the code is immediately ran. Simple and easy. The limitation here is that it relies on a separate file, you may be in a situation where you need to reduce as much as possible the file dependencies. Another technique allows you to remove such a dependency and create the worker logic through the createObjectURL API and a <em>Blob</em> object:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd19e493456567" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
// worker logic
var blob = new Blob(["self.addEventListener('message', messageReceived);function messageReceived(e) {self.postMessage('Doing pretty good here!');}"], {type: 'text/javascript'});

// webkit handling
var URL = window.URL || window.webkitURL;

// create the virtual file
var code = URL.createObjectURL(blob);

// create the worker
var worker = new Worker(code);</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>// worker logic</span></p><p><span>var</span><span> </span><span>blob</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Blob</span><span>(</span><span>[</span><span>"self.addEventListener('message', messageReceived);function messageReceived(e) {self.postMessage('Doing pretty good here!');}"</span><span>]</span><span>,</span><span> </span><span>{</span><span>type:</span><span> </span><span>'text/javascript'</span><span>}</span><span>)</span><span>;</span></p><p><span>// webkit handling</span></p><p><span>var</span><span> </span><span>URL</span><span> </span><span>=</span><span> </span><span>window</span><span>.</span><span>URL</span><span> </span><span>||</span><span> </span><span>window</span><span>.</span><span>webkitURL</span><span>;</span></p><p><span>// create the virtual file</span></p><p><span>var</span><span> </span><span>code</span><span> </span><span>=</span><span> </span><span>URL</span><span>.</span><span>createObjectURL</span><span>(</span><span>blob</span><span>)</span><span>;</span></p><p><span>// create the worker</span></p><p><span>var</span><span> </span><span>worker</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Worker</span><span>(</span><span>code</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0037 seconds] --><p>Note that the way you retrieve the string passed to the <em>Blob</em> object can vary. Obviously, passing the string like above is not very optimal. As <a title="Using Web Workers | Mozilla" href="https://developer.mozilla.org/en-US/docs/Web/Guide/Performance/Using_web_workers" target="_blank">Mozilla</a> points out in their documentation, you can also store the JavaScript code inside a custom script tag and extract its content dynamically and pass it to the Blob object.</p><p>In the code below, the JavaScript code is located inside a custom script tag:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd1a7916785848" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
&lt;script type="mce-text/js-worker"&gt;
self.addEventListener('message', messageReceived); 

function messageReceived(e) {
    self.postMessage('Doing pretty good here!');
}
&lt;/script&gt;</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>&lt;script </span><span>type</span><span>=</span><span>"mce-text/js-worker"</span><span>&gt;</span></p><p><span>self</span><span>.</span><span>addEventListener</span><span>(</span><span>'message'</span><span>,</span><span> </span><span>messageReceived</span><span>)</span><span>;</span><span> </span></p><p><span>function</span><span> </span><span>messageReceived</span><span>(</span><span>e</span><span>)</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>postMessage</span><span>(</span><span>'Doing pretty good here!'</span><span>)</span><span>;</span></p><p><span>}</span></p><p><span>&lt;/script&gt;</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0020 seconds] --><p>Did you notice the use of the keyword <em>self</em>? This is how we refer (from the background code) to the worker itself.</p><p>We retrieve the script using the querySelector API and pass it to the <em>Blob</em> object:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd1b0352379526" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
// extract the string
var logic = document.querySelectorAll("script[type=\"text\/js-worker\"]")[0].textContent;

// worker logic
var blob = new Blob([logic], {type: 'text/javascript'});

// webkit handling
var URL = window.URL || window.webkitURL;

// create the virtual file
var code = URL.createObjectURL(blob);

// create the worker
var worker = new Worker(code);</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>// extract the string</span></p><p><span>var</span><span> </span><span>logic</span><span> </span><span>=</span><span> </span><span>document</span><span>.</span><span>querySelectorAll</span><span>(</span><span>"script[type=\"text\/js-worker\"]"</span><span>)</span><span>[</span><span>0</span><span>]</span><span>.</span><span>textContent</span><span>;</span></p><p><span>// worker logic</span></p><p><span>var</span><span> </span><span>blob</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Blob</span><span>(</span><span>[</span><span>logic</span><span>]</span><span>,</span><span> </span><span>{</span><span>type:</span><span> </span><span>'text/javascript'</span><span>}</span><span>)</span><span>;</span></p><p><span>// webkit handling</span></p><p><span>var</span><span> </span><span>URL</span><span> </span><span>=</span><span> </span><span>window</span><span>.</span><span>URL</span><span> </span><span>||</span><span> </span><span>window</span><span>.</span><span>webkitURL</span><span>;</span></p><p><span>// create the virtual file</span></p><p><span>var</span><span> </span><span>code</span><span> </span><span>=</span><span> </span><span>URL</span><span>.</span><span>createObjectURL</span><span>(</span><span>blob</span><span>)</span><span>;</span></p><p><span>// create the worker</span></p><p><span>var</span><span> </span><span>worker</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Worker</span><span>(</span><span>code</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0051 seconds] --><p>Relying on a separate file for the worker logic is the most common way to work with Workers but you now have seen different options in case you had to get rid of a dependent file.</p><h5>Terminating a Web Worker</h5><p>To terminate a Worker, just call the terminate API:</p><!-- Crayon Syntax Highlighter v2.3.0 --><!-- [Format Time: 0.0006 seconds] --><p>In the same way, a Worker can close itself through the close API:</p><!-- Crayon Syntax Highlighter v2.3.0 --><!-- [Format Time: 0.0006 seconds] --><p>Note that once terminated or closed, a Web Worker cannot be restored, it would have to be recreated. Now that our Worker object is created, let’s send some data back and forth to see how things work.</p><h5>Sub Web Workers</h5><p>If needed, a Worker can create a Worker within itself:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd1c9546727690" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
self.addEventListener('message', messageReceived);

// a sub worker
var subworker = new Worker ('Task.js');

subworker.addEventListener('message', subTaskReceived);

function messageReceived(e) {
    // some logic
}

function subTaskReceived(e) {
    // some logic
}</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>self</span><span>.</span><span>addEventListener</span><span>(</span><span>'message'</span><span>,</span><span> </span><span>messageReceived</span><span>)</span><span>;</span></p><p><span>// a sub worker</span></p><p><span>var</span><span> </span><span>subworker</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Worker</span><span> </span><span>(</span><span>'Task.js'</span><span>)</span><span>;</span></p><p><span>subworker</span><span>.</span><span>addEventListener</span><span>(</span><span>'message'</span><span>,</span><span> </span><span>subTaskReceived</span><span>)</span><span>;</span></p><p><span>function</span><span> </span><span>messageReceived</span><span>(</span><span>e</span><span>)</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// some logic</span></p><p><span>}</span></p><p><span>function</span><span> </span><span>subTaskReceived</span><span>(</span><span>e</span><span>)</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>// some logic</span></p><p><span>}</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0029 seconds] --><h5><span>Passing data</span></h5><p>To communicate, we use the postMessage API (not to be confused with window.postMessage). Any message sent with postMessage triggers the “message” event that dispatched by the Worker object:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd1d2507971778" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
// extract the string
var logic = document.querySelectorAll("script[type=\"text\/js-worker\"]")[0].textContent;

// worker logic
var blob = new Blob([logic], {type: 'text/javascript'});

// webkit handling
var URL = window.URL || window.webkitURL;

// create the virtual file
var code = URL.createObjectURL(blob);

// create the worker
var worker = new Worker(code);

// listen to the response from the Worker
worker.addEventListener('message', receiveMessage);

// pass some data
worker.postMessage('How is it going over there?');

// callback handling the response, data is available in the event object
function receiveMessage (e)
{
    console.log (e.data);
}</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p></div>
				</td>
						<td><div><p><span>// extract the string</span></p><p><span>var</span><span> </span><span>logic</span><span> </span><span>=</span><span> </span><span>document</span><span>.</span><span>querySelectorAll</span><span>(</span><span>"script[type=\"text\/js-worker\"]"</span><span>)</span><span>[</span><span>0</span><span>]</span><span>.</span><span>textContent</span><span>;</span></p><p><span>// worker logic</span></p><p><span>var</span><span> </span><span>blob</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Blob</span><span>(</span><span>[</span><span>logic</span><span>]</span><span>,</span><span> </span><span>{</span><span>type:</span><span> </span><span>'text/javascript'</span><span>}</span><span>)</span><span>;</span></p><p><span>// webkit handling</span></p><p><span>var</span><span> </span><span>URL</span><span> </span><span>=</span><span> </span><span>window</span><span>.</span><span>URL</span><span> </span><span>||</span><span> </span><span>window</span><span>.</span><span>webkitURL</span><span>;</span></p><p><span>// create the virtual file</span></p><p><span>var</span><span> </span><span>code</span><span> </span><span>=</span><span> </span><span>URL</span><span>.</span><span>createObjectURL</span><span>(</span><span>blob</span><span>)</span><span>;</span></p><p><span>// create the worker</span></p><p><span>var</span><span> </span><span>worker</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Worker</span><span>(</span><span>code</span><span>)</span><span>;</span></p><p><span>// listen to the response from the Worker</span></p><p><span>worker</span><span>.</span><span>addEventListener</span><span>(</span><span>'message'</span><span>,</span><span> </span><span>receiveMessage</span><span>)</span><span>;</span></p><p><span>// pass some data</span></p><p><span>worker</span><span>.</span><span>postMessage</span><span>(</span><span>'How is it going over there?'</span><span>)</span><span>;</span></p><p><span>// callback handling the response, data is available in the event object</span></p><p><span>function</span><span> </span><span>receiveMessage</span><span> </span><span>(</span><span>e</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>console</span><span>.</span><span>log</span><span> </span><span>(</span><span>e</span><span>.</span><span>data</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0065 seconds] --><p>Our code sends a message to the Worker, which returns a message back to the main thread. The code above outputs the following message:</p><!-- Crayon Syntax Highlighter v2.3.0 --><!-- [Format Time: 0.0006 seconds] --><p>In that case, we sent the string: <em>‘How is it going over there’</em>, and the Worker returned <em>‘Doing pretty good here’</em>. We sent different data to illustrate how simply message passing works. But in most cases you want to send similar data that you can retrieve on both sides. Some coordinates, a path that has been computed in a game, or more simply a binary blob that you want to process, like a PDF or an image that has been generated. To retrieve the data that is being passed, we use the <em>data</em> property of the event object.</p><p>In the code below, we update our worker logic to return the data back to the main thread:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd1e3806743739" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
self.addEventListener('message', messageReceived);

function messageReceived(e) {
    self.postMessage(e.data);
}</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>self</span><span>.</span><span>addEventListener</span><span>(</span><span>'message'</span><span>,</span><span> </span><span>messageReceived</span><span>)</span><span>;</span></p><p><span>function</span><span> </span><span>messageReceived</span><span>(</span><span>e</span><span>)</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>postMessage</span><span>(</span><span>e</span><span>.</span><span>data</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0018 seconds] --><p>We still pass a simple string, but it is now sent back to the main thread:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd1eb733085017" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
// extract the string
var logic = document.querySelectorAll("script[type=\"text\/js-worker\"]")[0].textContent;

// worker logic
var blob = new Blob([logic], {type: 'text/javascript'});

// webkit handling
var URL = window.URL || window.webkitURL;

// create the virtual file
var code = URL.createObjectURL(blob);

// create the worker
var worker = new Worker(code);

// listen to the response from the Worker
worker.addEventListener('message', receiveMessage);

// we send some data
worker.postMessage("Some data passed back and forth!")

// callback handling the response, data is available in the event object
function receiveMessage (e)
{
    console.log (e.data);
}</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p></div>
				</td>
						<td><div><p><span>// extract the string</span></p><p><span>var</span><span> </span><span>logic</span><span> </span><span>=</span><span> </span><span>document</span><span>.</span><span>querySelectorAll</span><span>(</span><span>"script[type=\"text\/js-worker\"]"</span><span>)</span><span>[</span><span>0</span><span>]</span><span>.</span><span>textContent</span><span>;</span></p><p><span>// worker logic</span></p><p><span>var</span><span> </span><span>blob</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Blob</span><span>(</span><span>[</span><span>logic</span><span>]</span><span>,</span><span> </span><span>{</span><span>type:</span><span> </span><span>'text/javascript'</span><span>}</span><span>)</span><span>;</span></p><p><span>// webkit handling</span></p><p><span>var</span><span> </span><span>URL</span><span> </span><span>=</span><span> </span><span>window</span><span>.</span><span>URL</span><span> </span><span>||</span><span> </span><span>window</span><span>.</span><span>webkitURL</span><span>;</span></p><p><span>// create the virtual file</span></p><p><span>var</span><span> </span><span>code</span><span> </span><span>=</span><span> </span><span>URL</span><span>.</span><span>createObjectURL</span><span>(</span><span>blob</span><span>)</span><span>;</span></p><p><span>// create the worker</span></p><p><span>var</span><span> </span><span>worker</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Worker</span><span>(</span><span>code</span><span>)</span><span>;</span></p><p><span>// listen to the response from the Worker</span></p><p><span>worker</span><span>.</span><span>addEventListener</span><span>(</span><span>'message'</span><span>,</span><span> </span><span>receiveMessage</span><span>)</span><span>;</span></p><p><span>// we send some data</span></p><p><span>worker</span><span>.</span><span>postMessage</span><span>(</span><span>"Some data passed back and forth!"</span><span>)</span></p><p><span>// callback handling the response, data is available in the event object</span></p><p><span>function</span><span> </span><span>receiveMessage</span><span> </span><span>(</span><span>e</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>console</span><span>.</span><span>log</span><span> </span><span>(</span><span>e</span><span>.</span><span>data</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0070 seconds] --><p>If we run the code above, the console outputs:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd1f4251370804" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
Some data passed back and forth!</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>Some </span><span>data </span><span>passed </span><span>back </span><span>and</span><span> </span><span>forth</span><span>!</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0007 seconds] --><p>Remember that we are not sharing anything here, our string got cloned implicitly. Now you may wonder, can I pass any kind of data? If you stick to all the primitive types available in the JavaScript language, like Number, String, Boolean, you will be fine. For composite data types, plain JSON objects are supported, in addition to the ImageData and TypedArray types.</p><p>In the code below, we pass a simple JSON object:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd1fc066918648" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
// a user
var user = { name : "Bob", age: 30, city: "San Francisco" };

// we pass our object
worker.postMessage ( user );</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>// a user</span></p><p><span>var</span><span> </span><span>user</span><span> </span><span>=</span><span> </span><span>{</span><span> </span><span>name</span><span> </span><span>:</span><span> </span><span>"Bob"</span><span>,</span><span> </span><span>age</span><span>:</span><span> </span><span>30</span><span>,</span><span> </span><span>city</span><span>:</span><span> </span><span>"San Francisco"</span><span> </span><span>}</span><span>;</span></p><p><span>// we pass our object</span></p><p><span>worker</span><span>.</span><span>postMessage</span><span> </span><span>(</span><span> </span><span>user</span><span> </span><span>)</span><span>;</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0020 seconds] --><p>Here again, the object is cloned and accessible from our Worker code:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd204469452787" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
self.addEventListener('message', messageReceived);

function messageReceived (e)
{
    var user = e.data;
    var name = user.name;
    var age = user.age;
    var city = user.city;
}</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>self</span><span>.</span><span>addEventListener</span><span>(</span><span>'message'</span><span>,</span><span> </span><span>messageReceived</span><span>)</span><span>;</span></p><p><span>function</span><span> </span><span>messageReceived</span><span> </span><span>(</span><span>e</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>user</span><span> </span><span>=</span><span> </span><span>e</span><span>.</span><span>data</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>name</span><span> </span><span>=</span><span> </span><span>user</span><span>.</span><span>name</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>age</span><span> </span><span>=</span><span> </span><span>user</span><span>.</span><span>age</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>city</span><span> </span><span>=</span><span> </span><span>user</span><span>.</span><span>city</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0030 seconds] --><p>If you try to pass an unsupported type, you will get a <em>DataCloneError</em> exception. In the code below, we try to pass a reference to the window object:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd20c367942911" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
// attempt to pass the window object
worker.postMessage(this.window);</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>// attempt to pass the window object</span></p><p><span>worker</span><span>.</span><span>postMessage</span><span>(</span><span>this</span><span>.</span><span>window</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0008 seconds] --><p>Which triggers the following exception:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd214835695013" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
Uncaught Error: DataCloneError: DOM Exception 25</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>Uncaught </span><span>Error:</span><span> </span><span>DataCloneError:</span><span> </span><span>DOM </span><span>Exception</span><span> </span><span>25</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0008 seconds] --><p>Same thing with an XHR object:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd21b157791828" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
// attempt to pass an XHR object
worker.postMessage(new XMLHttpRequest());</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>// attempt to pass an XHR object</span></p><p><span>worker</span><span>.</span><span>postMessage</span><span>(</span><span>new</span><span> </span><span>XMLHttpRequest</span><span>(</span><span>)</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0009 seconds] --><p>Which also results in a runtime exception:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd223476065980" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
Uncaught Error: DataCloneError: DOM Exception 25</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>Uncaught </span><span>Error</span><span>:</span><span> </span><span>DataCloneError</span><span>:</span><span> </span><span>DOM </span><span>Exception</span><span> </span><span>25</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0010 seconds] --><p>In the same way, passing a custom type is not supported. In the code below, we try to pass an Array of Ball objects:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd22b532657288" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
var radius = 10;
var Ball = (function () {
    function Ball(radius, x, y, destX, destY, context, balls) {
        this.friction = .1;
        this.color = 'green';
        this.radius = radius;
        this.x = x;
        this.y = y;
        this.destX = destX;
        this.destY = destY;
        this.context = context;
        this.balls = balls;
    }
    return Ball;
})();

var BALLS_NUM = 100;
var balls = new Array();

for(var i = 0; i &lt; BALLS_NUM; i++) {
    var obj = new Ball(radius, Math.round(Math.random() * 1024), Math.round(Math.random() * 768), Math.random() * 1024, Math.random() * 768, context, balls);
    balls.push(obj);
}

// attempt to pass an array of custom type (Ball) objects
worker.postMessage (balls);</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p></div>
				</td>
						<td><div><p><span>var</span><span> </span><span>radius</span><span> </span><span>=</span><span> </span><span>10</span><span>;</span></p><p><span>var</span><span> </span><span>Ball</span><span> </span><span>=</span><span> </span><span>(</span><span>function</span><span> </span><span>(</span><span>)</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>function</span><span> </span><span>Ball</span><span>(</span><span>radius</span><span>,</span><span> </span><span>x</span><span>,</span><span> </span><span>y</span><span>,</span><span> </span><span>destX</span><span>,</span><span> </span><span>destY</span><span>,</span><span> </span><span>context</span><span>,</span><span> </span><span>balls</span><span>)</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>friction</span><span> </span><span>=</span><span> </span><span>.</span><span>1</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>color</span><span> </span><span>=</span><span> </span><span>'green'</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>radius</span><span> </span><span>=</span><span> </span><span>radius</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>x</span><span> </span><span>=</span><span> </span><span>x</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>y</span><span> </span><span>=</span><span> </span><span>y</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>destX</span><span> </span><span>=</span><span> </span><span>destX</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>destY</span><span> </span><span>=</span><span> </span><span>destY</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>context</span><span> </span><span>=</span><span> </span><span>context</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>this</span><span>.</span><span>balls</span><span> </span><span>=</span><span> </span><span>balls</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>Ball</span><span>;</span></p><p><span>}</span><span>)</span><span>(</span><span>)</span><span>;</span></p><p><span>var</span><span> </span><span>BALLS_NUM</span><span> </span><span>=</span><span> </span><span>100</span><span>;</span></p><p><span>var</span><span> </span><span>balls</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Array</span><span>(</span><span>)</span><span>;</span></p><p><span>for</span><span>(</span><span>var</span><span> </span><span>i</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>BALLS_NUM</span><span>;</span><span> </span><span>i</span><span>++</span><span>)</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>var</span><span> </span><span>obj</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Ball</span><span>(</span><span>radius</span><span>,</span><span> </span><span>Math</span><span>.</span><span>round</span><span>(</span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span><span> </span><span>*</span><span> </span><span>1024</span><span>)</span><span>,</span><span> </span><span>Math</span><span>.</span><span>round</span><span>(</span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span><span> </span><span>*</span><span> </span><span>768</span><span>)</span><span>,</span><span> </span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span><span> </span><span>*</span><span> </span><span>1024</span><span>,</span><span> </span><span>Math</span><span>.</span><span>random</span><span>(</span><span>)</span><span> </span><span>*</span><span> </span><span>768</span><span>,</span><span> </span><span>context</span><span>,</span><span> </span><span>balls</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>balls</span><span>.</span><span>push</span><span>(</span><span>obj</span><span>)</span><span>;</span></p><p><span>}</span></p><p><span>// attempt to pass an array of custom type (Ball) objects</span></p><p><span>worker</span><span>.</span><span>postMessage</span><span> </span><span>(</span><span>balls</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0137 seconds] --><p>This code will also trigger the same <em>DataCloneError</em> exception. As you can imagine, passing data through cloning has overhead. If you try to pass a big amount of data at a high frequency, cloning will not be the most efficient path. However, this approach has one merit, it is very safe. Given that everything is cloned, it is therefore impossible to get in a situation where data is corrupted or simply ending up with unsynchronized shared data.</p><h6>Sending larger objects</h6><p>In the following example, we create a 16mb byte array that we send to the worker, we capture the time it takes to allocate and transfer back and forth:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd234162292551" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
// extract the string
var logic = document.querySelectorAll("script[type=\"text\/js-worker\"]")[0].textContent;

// worker logic
var blob = new Blob([logic], {type: 'text/javascript'});

// webkit handling
var URL = window.URL || window.webkitURL;

// create the virtual file
var code = URL.createObjectURL(blob);

// create the worker
var worker = new Worker(code);

// listen to the response from the Worker
worker.addEventListener('message', receiveMessage);

// capture current time
var started = Date.now();

// Create a 16MB "file" and fill it.
var uInt8View = new Uint8Array(1024*1024*16); // 16MB
for (var i = 0; i &lt; uInt8View.length; ++i) {
    uInt8View[i] = i;
}

console.log ( "Memory allocation : " + (Date.now() - started) + " ms" );

// capture current time
started = Date.now();

// pass the bytearray (cloned)
worker.postMessage(uInt8View.buffer);

// callback handling the response, data is available in the event object
function receiveMessage (e)
{
    console.log ("Back/forth transfer : " + (Date.now() - started) + " ms");
    console.log ("Byte array size : " + e.data.byteLength);
}</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p></div>
				</td>
						<td><div><p><span>// extract the string</span></p><p><span>var</span><span> </span><span>logic</span><span> </span><span>=</span><span> </span><span>document</span><span>.</span><span>querySelectorAll</span><span>(</span><span>"script[type=\"text\/js-worker\"]"</span><span>)</span><span>[</span><span>0</span><span>]</span><span>.</span><span>textContent</span><span>;</span></p><p><span>// worker logic</span></p><p><span>var</span><span> </span><span>blob</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Blob</span><span>(</span><span>[</span><span>logic</span><span>]</span><span>,</span><span> </span><span>{</span><span>type:</span><span> </span><span>'text/javascript'</span><span>}</span><span>)</span><span>;</span></p><p><span>// webkit handling</span></p><p><span>var</span><span> </span><span>URL</span><span> </span><span>=</span><span> </span><span>window</span><span>.</span><span>URL</span><span> </span><span>||</span><span> </span><span>window</span><span>.</span><span>webkitURL</span><span>;</span></p><p><span>// create the virtual file</span></p><p><span>var</span><span> </span><span>code</span><span> </span><span>=</span><span> </span><span>URL</span><span>.</span><span>createObjectURL</span><span>(</span><span>blob</span><span>)</span><span>;</span></p><p><span>// create the worker</span></p><p><span>var</span><span> </span><span>worker</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Worker</span><span>(</span><span>code</span><span>)</span><span>;</span></p><p><span>// listen to the response from the Worker</span></p><p><span>worker</span><span>.</span><span>addEventListener</span><span>(</span><span>'message'</span><span>,</span><span> </span><span>receiveMessage</span><span>)</span><span>;</span></p><p><span>// capture current time</span></p><p><span>var</span><span> </span><span>started</span><span> </span><span>=</span><span> </span><span>Date</span><span>.</span><span>now</span><span>(</span><span>)</span><span>;</span></p><p><span>// Create a 16MB "file" and fill it.</span></p><p><span>var</span><span> </span><span>uInt8View</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Uint8Array</span><span>(</span><span>1024</span><span>*</span><span>1024</span><span>*</span><span>16</span><span>)</span><span>;</span><span> </span><span>// 16MB</span></p><p><span>for</span><span> </span><span>(</span><span>var</span><span> </span><span>i</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>uInt8View</span><span>.</span><span>length</span><span>;</span><span> </span><span>++</span><span>i</span><span>)</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>uInt8View</span><span>[</span><span>i</span><span>]</span><span> </span><span>=</span><span> </span><span>i</span><span>;</span></p><p><span>}</span></p><p><span>console</span><span>.</span><span>log</span><span> </span><span>(</span><span> </span><span>"Memory allocation : "</span><span> </span><span>+</span><span> </span><span>(</span><span>Date</span><span>.</span><span>now</span><span>(</span><span>)</span><span> </span><span>-</span><span> </span><span>started</span><span>)</span><span> </span><span>+</span><span> </span><span>" ms"</span><span> </span><span>)</span><span>;</span></p><p><span>// capture current time</span></p><p><span>started</span><span> </span><span>=</span><span> </span><span>Date</span><span>.</span><span>now</span><span>(</span><span>)</span><span>;</span></p><p><span>// pass the bytearray (cloned)</span></p><p><span>worker</span><span>.</span><span>postMessage</span><span>(</span><span>uInt8View</span><span>.</span><span>buffer</span><span>)</span><span>;</span></p><p><span>// callback handling the response, data is available in the event object</span></p><p><span>function</span><span> </span><span>receiveMessage</span><span> </span><span>(</span><span>e</span><span>)</span></p><p><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>console</span><span>.</span><span>log</span><span> </span><span>(</span><span>"Back/forth transfer : "</span><span> </span><span>+</span><span> </span><span>(</span><span>Date</span><span>.</span><span>now</span><span>(</span><span>)</span><span> </span><span>-</span><span> </span><span>started</span><span>)</span><span> </span><span>+</span><span> </span><span>" ms"</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>console</span><span>.</span><span>log</span><span> </span><span>(</span><span>"Byte array size : "</span><span> </span><span>+</span><span> </span><span>e</span><span>.</span><span>data</span><span>.</span><span>byteLength</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0135 seconds] --><p>If we run this code on different devices and environments, we get the following results: 
<table id="tablepress-4">
<thead>
<tr>
	<th><p>Platform</p></th><th><p>Time (ms)</p></th>
</tr>
</thead>
<tbody>
<tr>
	<td>iOS7 (Safari/iPhone5)</td><td>214</td>
</tr>
<tr>
	<td>iOS6 (Safari/iPhone4S)</td><td>524</td>
</tr>
<tr>
	<td>MacBook Pro (Chrome/10.8.4)</td><td>75</td>
</tr>
</tbody>
</table>
<!-- #tablepress-4 from cache --></p><p>Note how expensive data cloning is on a recent device and OS. Let’s see if transfer of ownership can help performance.</p><h6>Transferable objects</h6><p>In a scenario where you need to pass a large amount of data and cloning could be too costly, you can rely on transferrable objects. To transfer an object, the postMessage API accepts a second optional second argument, which is an array containing the objects to transfer ownership from:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd23e472189714" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
// transfer ownership to the worker
worker.postMessage(uInt8View.buffer, [uInt8View.buffer]);</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>// transfer ownership to the worker</span></p><p><span>worker</span><span>.</span><span>postMessage</span><span>(</span><span>uInt8View</span><span>.</span><span>buffer</span><span>,</span><span> </span><span>[</span><span>uInt8View</span><span>.</span><span>buffer</span><span>]</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0013 seconds] --><p>With that change, we see that passing data becomes much more efficient, around a 3x performance boost on mobile: 
<table id="tablepress-5">
<thead>
<tr>
	<th><p>Platform</p></th><th><p>Time (ms)</p></th>
</tr>
</thead>
<tbody>
<tr>
	<td>iOS7 (Safari/iPhone5)</td><td>80</td>
</tr>
<tr>
	<td>iOS6 (Safari/iPhone4S)</td><td>162</td>
</tr>
<tr>
	<td>MacBook Pro (Chrome/10.8.4)</td><td>37</td>
</tr>
</tbody>
</table>
<!-- #tablepress-5 from cache --></p><p>Note that just before calling postMessage, our byte array is available, right after the transfer, the reference is no longer accesssible and trying to access it throws a runtime exception:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd247210483279" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
// outputs: 16777216
// access to the bytearray possible
console.log ( uInt8View.buffer.byteLength );

// transfer ownership to the worker
worker.postMessage(uInt8View.buffer, [uInt8View.buffer]);

// triggers runtime exception: Uncaught TypeError: Cannot read property 'byteLength' of null
console.log ( uInt8View.buffer.byteLength );</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>// outputs: 16777216</span></p><p><span>// access to the bytearray possible</span></p><p><span>console</span><span>.</span><span>log</span><span> </span><span>(</span><span> </span><span>uInt8View</span><span>.</span><span>buffer</span><span>.</span><span>byteLength</span><span> </span><span>)</span><span>;</span></p><p><span>// transfer ownership to the worker</span></p><p><span>worker</span><span>.</span><span>postMessage</span><span>(</span><span>uInt8View</span><span>.</span><span>buffer</span><span>,</span><span> </span><span>[</span><span>uInt8View</span><span>.</span><span>buffer</span><span>]</span><span>)</span><span>;</span></p><p><span>// triggers runtime exception: Uncaught TypeError: Cannot read property 'byteLength' of null</span></p><p><span>console</span><span>.</span><span>log</span><span> </span><span>(</span><span> </span><span>uInt8View</span><span>.</span><span>buffer</span><span>.</span><span>byteLength</span><span> </span><span>)</span><span>;</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0029 seconds] --><p>This technique can be useful in a scenario where you need to pass a big amount of data, like a big binary blob. Note that since the beginning, we passed data from the main thread to the Worker, but data could be passed the other way around. This time, we will create the memory buffer from the worker and send it to the main thread.</p><p>To achieve this, we modify our worker logic:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd24f242958998" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
// Create a 16MB "file" and fill it.
var uInt8View = new Uint8Array(1024*1024*16); // 16MB

for (var i = 0; i &lt; uInt8View.length; ++i) {
    uInt8View[i] = i;
} 

self.postMessage(uInt8View.buffer, [uInt8View.buffer]);</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>// Create a 16MB "file" and fill it.</span></p><p><span>var</span><span> </span><span>uInt8View</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Uint8Array</span><span>(</span><span>1024</span><span>*</span><span>1024</span><span>*</span><span>16</span><span>)</span><span>;</span><span> </span><span>// 16MB</span></p><p><span>for</span><span> </span><span>(</span><span>var</span><span> </span><span>i</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>uInt8View</span><span>.</span><span>length</span><span>;</span><span> </span><span>++</span><span>i</span><span>)</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>uInt8View</span><span>[</span><span>i</span><span>]</span><span> </span><span>=</span><span> </span><span>i</span><span>;</span></p><p><span>}</span><span> </span></p><p><span>self</span><span>.</span><span>postMessage</span><span>(</span><span>uInt8View</span><span>.</span><span>buffer</span><span>,</span><span> </span><span>[</span><span>uInt8View</span><span>.</span><span>buffer</span><span>]</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0041 seconds] --><p>Then, we listen to the message coming from the worker:</p><!-- Crayon Syntax Highlighter v2.3.0 --><div id="crayon-5268fd2ebd258265426686" data-settings=" minimize scroll-mouseover"><p><textarea wrap="off" data-settings="dblclick" readonly="">
// extract the string 
var logic = document.querySelectorAll("script[type=\"text\/js-worker\"]")[0].textContent; 

// worker logic 
var blob = new Blob([logic], {type: 'text/javascript'}); 

// webkit handling 
var URL = window.URL || window.webkitURL; 

// create the virtual file 
var code = URL.createObjectURL(blob); 

// create the Worker 
var worker = new Worker(code); 

// listen to the incoming message from the Worker 
worker.addEventListener('message', receiveMessage); 

function receiveMessage (e) { 
    console.log (e.data.byteLength); 
}</textarea></p><div><table>
					<tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p></div>
				</td>
						<td><div><p><span>// extract the string </span></p><p><span>var</span><span> </span><span>logic</span><span> </span><span>=</span><span> </span><span>document</span><span>.</span><span>querySelectorAll</span><span>(</span><span>"script[type=\"text\/js-worker\"]"</span><span>)</span><span>[</span><span>0</span><span>]</span><span>.</span><span>textContent</span><span>;</span><span> </span></p><p><span>// worker logic </span></p><p><span>var</span><span> </span><span>blob</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Blob</span><span>(</span><span>[</span><span>logic</span><span>]</span><span>,</span><span> </span><span>{</span><span>type:</span><span> </span><span>'text/javascript'</span><span>}</span><span>)</span><span>;</span><span> </span></p><p><span>// webkit handling </span></p><p><span>var</span><span> </span><span>URL</span><span> </span><span>=</span><span> </span><span>window</span><span>.</span><span>URL</span><span> </span><span>||</span><span> </span><span>window</span><span>.</span><span>webkitURL</span><span>;</span><span> </span></p><p><span>// create the virtual file </span></p><p><span>var</span><span> </span><span>code</span><span> </span><span>=</span><span> </span><span>URL</span><span>.</span><span>createObjectURL</span><span>(</span><span>blob</span><span>)</span><span>;</span><span> </span></p><p><span>// create the Worker </span></p><p><span>var</span><span> </span><span>worker</span><span> </span><span>=</span><span> </span><span>new</span><span> </span><span>Worker</span><span>(</span><span>code</span><span>)</span><span>;</span><span> </span></p><p><span>// listen to the incoming message from the Worker </span></p><p><span>worker</span><span>.</span><span>addEventListener</span><span>(</span><span>'message'</span><span>,</span><span> </span><span>receiveMessage</span><span>)</span><span>;</span><span> </span></p><p><span>function</span><span> </span><span>receiveMessage</span><span> </span><span>(</span><span>e</span><span>)</span><span> </span><span>{</span><span> </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>console</span><span>.</span><span>log</span><span> </span><span>(</span><span>e</span><span>.</span><span>data</span><span>.</span><span>byteLength</span><span>)</span><span>;</span><span> </span></p><p><span>}</span></p></div></td>
					</tr>
				</table></div></div><!-- [Format Time: 0.0069 seconds] --><p>If we run the code above, the console outputs:</p><!-- Crayon Syntax Highlighter v2.3.0 --><!-- [Format Time: 0.0005 seconds] --><p>We are now transferring our data from the background Web Worker to the main UI thread.</p><h5>Responsive use cases</h5><p>As we said earlier, Web Workers are commonly used today to perform expensive/synchronous tasks in the background. This allows you as a developer to perform expensive computations in the background, without causing the UI to lock so that your application stays always responsive.</p><p>Here is below a few use cases:</p><ul>
<li>Generating or parsing/rendering a PDF.</li>
<li>Compressing an image to a custom file format (JPEG, etc.).</li>
<li>Compute an A* path inside a game.</li>
<li>Lookup a word in a database for a spell checker in a text editor.</li>
<li>Load and parse some resources inside a game.</li>
<li>Perform general complex computations in the background and log that remotely.</li>
<li>And many others…</li>
</ul><p>For these, message cloning works just fine, because low-latency is acceptable. All you need is to pass your data back to the UI thread and that’s it, you don’t need to pass messages at a high frequency</p><h5>Concurrency and the future of the web</h5><p>As you can see, Web Workers are very easy to use and pretty powerful. The message passing model is simple and easy and they can be leveraged today on desktop and mobile to make your application more responsive and snappier. So, are we done with them or could they be improved? We will see in the following section that there is room for a few improvements that could really move the web forward.</p><h6>Parallelization</h6><p>So far, we have covered techniques to offload expensive computations to a background worker, using message cloning and transfer of ownership, but we have not discussed the parallelization use cases. Instead of relying on a single Web Worker to perform a computation in the background, the idea of parallelization is to have multiple Web Workers run in parallel and working on solving the same task but faster, given that we distribute the task to multiple threads. Microsoft has posted <a title="Web Workers and image manipulation" href="http://blogs.msdn.com/b/eternalcoding/archive/2012/09/20/using-web-workers-to-improve-performance-of-image-manipulation.aspx" target="_blank">a good example</a>&nbsp;about this for image manipulation.</p><p>As we have seen, two communication models currently exist for Web Workers, <strong>cloning</strong> and <strong>ownership transfer</strong>, unfortunately, both do not work well today for parallelization. The former does not, giving data ownership to one Web Worker at a time. The latter allows you to parallelize tasks by duplicating data when needed, but the cloning has real overhead and that can become limiting in some scenarios. In my tests, passing an array of 100 JSON objects over a few frames brought the performance to a crawl. Being able to truly share some memory (like a simple TypedArray) between workers would be fast, but it would expose some additional complexity to web developers, like having to deal with synchronization of data.</p><p>Most of the time, the idea of shared memory makes people worried about nasty things we usually don’t want to deal with, like data races and locks leading to memory corruption. I actually agree that within the context of low-level languages, this is pretty scary, but with a managed language like JavaScript, I would argue that it is not as bad. In addition, the main UI thread and Web Workers have been designed so that blocking cannot happen when one is waiting for the other and blocking the UI can already happen today with a simple while (true) sitting on the main thread.</p><p>So, really, I am not sure a shared memory model with Web Workers would necessarily hurt the web, but I agree that there is probably a better solution than exposing plain simple shared memory. This would expose to web developers some additional complexity, like dealing with conditions and mutexes, and there’s gotta be something better for web developers. Anyway, I am following discussions about bringing a better message passing model to Web Workers with great passion.</p><h6>Shared resources (WebGL)</h6><p>Web Workers also offer some great potential when it comes to GPU programming. The most exciting one to me, is the idea of <a title="Shared Resources" href="http://www.khronos.org/webgl/wiki/SharedResouces" target="_blank">shared resources</a> for WebGL relying on Web Workers. Today, when you are programming with WebGL, all the initialization work required to initialize WebGL, like shader programs initialization and texture uploads happen on the UI thread. In other words, to see something on screen, WebGL requires you to upload your textures and programs (vertex/fragments shaders) and all of this still happens on the main UI thread. In addition. two things usually required when working with GPU APIs have always been slow historically and most importantly blocking operations: texture upload and texture readback.</p><p>This is a big limitation, as you obviously need to upload textures and this will once again lock the UI if expensive, making your game/application feel janky. Same thing for texture readback (which means copying the texture uploaded on the GPU back to RAM) to perform other computations on the CPU. With shared resources support for WebGL, multiple contexts could be created across Web Workers to perform some of the tasks mentioned earlier in other threads, allowing developers to produce lock-free, snappy, super responsive GPU experiences.</p><h5>Additional Web Workers resources</h5><p>I hope you enjoyed reading these additional details on Web Workers!</p><small>
	Posted on <a href="http://typedarray.org/2013/07/">July 1, 2013</a>
	by <a href="http://typedarray.org/author/admin/">Thibault Imbert</a>
	·
	<span rel="69 http://typedarray.org/?p=69">21 comments</span>
</small><span>
									Tags: <a href="http://typedarray.org/tag/asynchronous/">asynchronous</a>, <a href="http://typedarray.org/tag/concurrency/">concurrency</a>, <a href="http://typedarray.org/tag/threading/">threading</a>, <a href="http://typedarray.org/tag/workers/">workers</a>. 

								</span><!-- Required by wordpress --></div></div>
</body>
</html>