
        <!doctype html>
        <html>
        <head>
            <meta charset="utf-8"/>
            <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
            <title>【第469期】Hybrid APP架构设计思路</title>
            <link rel="stylesheet" href="../css/article.css" />;
        </head>
        <body>
            <div class="m-content">
                <h1>【第469期】Hybrid APP架构设计思路</h1>
                <div class="rich_media_content " id="js_content"><span>
                        

                        
                        
                        </span><p><span>前言</span></p><p><span>这篇技术文有点长，需要点耐心看，相信你一定可以的。</span></p><p><span><span>Ok</span><span>，现在移动端的趋势是很明显的，但有一个很明显的弊端会是随着功能的开发，</span><span>App</span><span>会越来越大，那一般的做法是把一些时效性或试验性的功能以</span><span>webapp</span><span>的形式开发出来，那这篇就是来说这个的。</span></span></p><p><span>正文从这开始～</span></p><p><span><span>关于</span><span>Hybrid</span><span>模式开发</span><span>app</span><span>的好处，网络上已有很多文章阐述了，这里不展开。</span></span></p><p><span><span>本文将从以下几个方面阐述</span><span>Hybrid app</span><span>架构设计的一些经验和思考。</span></span></p><p><span><strong><span>通讯</span></strong></span></p><p><span><span>作为一种跨语言开发模式，通讯层是</span><span>Hybrid</span><span>架构首先应该考虑和设计的，往后所有的逻辑都是基于通讯层展开。</span></span></p><p><span><span>Native</span><span>（以</span><span>Android</span><span>为例）和</span><span>H5</span><span>通讯，基本原理：</span></span></p><p><span><span>Android</span><span>调用</span><span>H5</span><span>：通过</span><span>webview</span><span>类的</span><span>loadUrl</span><span>方法可以直接执行</span><span>js</span><span>代码，类似浏览器地址栏输入一段</span><span>js</span><span>一样的效果</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5r9YNSneKibV16VEvPXsV6aOylvGWtgYKC5SM8HrNPadk4k5TB7TpFew/0?wx_fmt=jpeg" data-ratio="0.12" data-w=""><br></p><p><span><span>H5</span><span>调用</span><span>Android</span><span>：</span><span>webview</span><span>可以拦截</span><span>H5</span><span>发起的任意</span><span>url</span><span>请求，</span><span>webview</span><span>通过约定的规则对拦截到的</span><span>url</span><span>进行处理（消费），即可实现</span><span>H5</span><span>调用</span><span>Android</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5K6fNAoTsCg7FHOPYNWbjBEGR1ZiaCHicNRm8ibEa2J6BND00H6icU4JlgA/0?wx_fmt=jpeg" data-ratio="0.14363636363636365" data-w=""><br></p><p><span><span>JSBridge</span><span>即我们通常说的桥协议，基本的通讯原理很简单，接下来就是桥协议具体实现</span></span><span>。</span></p><p><span><span>P.S</span><span>：注册私有协议的做法很常见，我们经常遇到的在网页里拉起一个系统</span><span>app</span><span>就是采用私有协议实现的。</span><span>app</span><span>在安装完成之后会注册私有协议到</span><span>OS</span><span>，浏览器发现自身不能识别的协议（</span><span>http</span><span>、</span><span>https</span><span>、</span><span>file</span><span>等）时，会将链接抛给</span><span>OS</span><span>，</span><span>OS</span><span>会寻找可识别此协议的</span><span>app</span><span>并用该</span><span>app</span><span>处理链接。比如在网页里以</span><span>itunes://</span><span>开头的链接是</span><span>Apple Store</span><span>的私有协议，点击后可以启动</span><span>Apple Store</span><span>并且跳转到相应的界面。国内软件开发商也经常这么做，比如支付宝的私有协议</span><span>alipay://</span><span>，腾讯的</span><span>tencent://</span><span>等等。</span></span></p><p><span><strong><span>桥协议的具体实现</span></strong></span></p><p><span><span>由于</span><span>JavaScript</span><span>语言自身的特殊性（单进程），为了不阻塞主进程并且保证</span><span>H5</span><span>调用的有序性，与</span><span>Native</span><span>通讯时对于需要获取结果的接口（</span><span>GET</span><span>类），采用类似于</span><span>JSONP</span><span>的设计理念</span><span>:</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5VPTxLP85IXBpB5aTaoKbia4TNKicz9LTI7zMMko13JiagSwU2UibrTIBOg/0?wx_fmt=jpeg" data-ratio="0.6145454545454545" data-w=""><br></p><p><span><span>类比</span><span>HTTP</span><span>的</span><span>request</span><span>和</span><span>response</span><span>对象，调用方会将调用的</span><span>api</span><span>、参数、以及请求签名（由调用方生成）带上传给被调用方，被调用方处理完之后会吧结果以及请求签名回传调用方，调用方再根据请求签名找到本次请求对应的回调函数并执行，至此完成了一次通讯闭环。</span></span></p><p><span><span>H5</span><span>调用</span><span>Native</span><span>（以</span><span>Android</span><span>为例）示意图：</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5xibdJDco9h2Yic39e4luoiaqpe1rHG1hEIsmDq4VNb2y68H1yNc0ENJZg/0?wx_fmt=jpeg" data-ratio="0.6563636363636364" data-w=""><br></p><p><span><span>Native</span><span>（以</span><span>Android</span><span>为例）调用</span><span>H5</span><span>示意图：</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb54FGSQnwCVQrjPAN1HJXjX3MZ6bGOwrCWlWuLy8D4GkpcZSVGicMXxrw/0?wx_fmt=jpeg" data-ratio="0.6509090909090909" data-w=""><br></p><p><span><strong><span><span>基于桥协议的</span><span>api</span><span>设计（</span><span>HybridApi</span><span>）</span></span></strong></span></p><p><span><span>jsbridge</span><span>作为一种通用私有协议，一般会在团队级或者公司级产品进行共享，所以需要和业务层进行解耦，将</span><span>jsbridge</span><span>的内部细节进行封装，对外暴露平台级的</span><span>API</span><span>。</span></span></p><p><span><span>以下是笔者剥离公司业务代码后抽象出的一份</span><span>HybridApi js</span><span>部分的实现，项目地址：</span></span><span><a>hybrid-js</a></span></p><p><span><span>另外，对于</span><span>Native</span><span>提供的各种接口，也可以简单封装下，使之更贴近前端工程师的使用习惯：</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5ibOeebdKvX5HqE86TZ8Df0tRvgaVC5nCT7bzJ5S1Db9l3Cibjld5IBXg/0?wx_fmt=jpeg" data-ratio="0.36" data-w=""><br></p><p><span><span>增加</span><span>api</span><span>：</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5xebqHrkzKtB4LfXROicH486EyPyzt6uguwwXttnMGPXQ0JtuWdwZmiaw/0?wx_fmt=jpeg" data-ratio="0.3290909090909091" data-w=""><br></p><p><span><span>H5</span><span>上层应用调用：</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5Znjg0XhuB79bHd4iapvXeyBASLPQucgxAYAaib1sVe0pFKMxGMA0ib6yg/0?wx_fmt=jpeg" data-ratio="0.13818181818181818" data-w=""><br></p><p><span><strong><span><span>界面与交互（</span><span>Native</span><span>与</span><span>H5</span><span>职责划分）</span></span></strong></span></p><p><span><span>本质上，</span><span>Native</span><span>和</span><span>H5</span><span>都能完成界面开发。几乎所有</span><span>hybrid</span><span>的开发模式都会碰到同样的一个问题：哪些由</span><span>Native</span><span>负责哪些由</span><span>H5</span><span>负责？</span></span></p><p><span><span>这个回到原始的问题上来：我们为什么要采用</span><span>hybrid</span><span>模式开发？简而言之就是同时利用</span><span>H5</span><span>的跨平台、快速迭代能力以及</span><span>Native</span><span>的流畅性、系统</span><span>API</span><span>调用能力。</span></span></p><p><span><span>根据这个原则，为了充分利用二者的优势，应该尽可能地将</span><span>app</span><span>内容使用</span><span>H5</span><span>来呈现，而对于</span><span>js</span><span>语言本身的缺陷，应该使用</span><span>Native</span><span>语言来弥补，如转场动画、多线程作业（密集型任务）、</span><span>IO</span><span>性能等。即总的原则是</span><span>H5</span><span>提供内容，</span><span>Native</span><span>提供容器，在有可能的条件下对</span><span>Android</span><span>原生</span><span>webview</span><span>进行优化和改造（参考阿里</span><span>Hybrid</span><span>容器的</span><span>JSM</span><span>），提升</span><span>H5</span><span>的渲染效率。</span></span></p><p><span><span>但是，在实际的项目中，将整个</span><span>app</span><span>所有界面都使用</span><span>H5</span><span>来开发也有不妥之处，根据经验，以下情形还是使用</span><span>Native</span><span>界面为好：</span></span></p><p><span><span>1）关键界面、交互性强的的界面使用</span><span>Native</span></span></p><p><span><span>2）因</span><span>H5</span><span>比较容易被恶意攻击，对于安全性要求比较高的界面，如注册界面、登陆、支付等界面，会采用</span><span>Native</span><span>来取代</span><span>H5</span><span>开发，保证数据的安全性，这些页面通常</span><span>UI</span><span>变更的频率也不高。</span></span></p><p><span><span>3）对于这些界面，降级的方案也有，就是</span><span>HTTPS</span><span>。但是想说的是在国内的若网络环境下，</span><span>HTTPS</span><span>的体验实在是不咋地（主要是慢），而且只能走现网不能走离线通道。</span></span></p><p><span><span>另外，</span><span>H5</span><span>本身的动画开发成本比较高，在低端机器上可能有些绕不过的性能坎，原生</span><span>js</span><span>对于手势的支持也比较弱，因此对于这些类型的界面，可以选择使用</span><span>Native</span><span>来实现，这也是</span><span>Native</span><span>本身的优势不是。比如要实现下面这个音乐播放界面，用</span><span>H5</span><span>开发门槛不小吧，留意下中间的波浪线背景，手指左右滑动可以切换动画。</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb52tLkFXzvpvd0icwMyXb0WThOJPLG6sIOaNK3tDFrxqxZiaW1PUGMBoicQ/0?wx_fmt=jpeg" data-ratio="1.7757575757575759" data-w="495"><br></p><p><span><strong><span><span>导航组件采用</span><span>Native</span></span></strong></span></p><p><span><span>导航组件，就是页面的头组件，左上角一般都是一个</span><span>back</span><span>键，中间一般都是界面的标题，右边的话有时是一个隐藏的悬浮菜单触发按钮有时则什么也没有。</span></span></p><p><span><span>移动端有一个特性就是界面下拉有个回弹效果，头不动</span><span>body</span><span>部分跟着滑动，这种效果</span><span>H5</span><span>比较难实现。</span></span></p><p><span><span>再者，也是最重要的一点，如果整个界面都是</span><span>H5</span><span>的，在</span><span>H5</span><span>加载过程中界面将是白屏，在弱网络下用户可能会很疑惑。</span></span></p><p><span><span>所以基于这两点，打开的界面都是</span><span>Native</span><span>的导航组件</span><span>+webview</span><span>来组成，这样即使</span><span>H5</span><span>加载失败或者太慢用户可以选择直接关闭。</span></span></p><p><span><span>在</span><span>API</span><span>层面，会相应的有一个接口来实现这一逻辑（例如叫</span><span>JSBridge.layout.setHeader</span><span>），下面代码演示定制一个只有</span><span>back</span><span>键和标题的导航组件</span><span>:</span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5PNJQ8jPXlX9iaHMiah2qH2186wnzJuICorNXHxqrvxkq9WUFXByDxg4w/0?wx_fmt=jpeg" data-ratio="0.7727272727272727" data-w=""><br></p><p><span><span>上面的接口，可以满足绝大多数的需求，但是还有一些特殊的界面，通过</span><span>H5</span><span>代码控制生成导航组件这种方式达不到需求：</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5z4ib0Wr17rYvaicHlPOFEGJRsP2oyXrhr3MOUypPI6qwZ5ZeNZD5WiaCw/0?wx_fmt=jpeg" data-ratio="1.7741935483870968" data-w="496"><br></p><p><span><span>如上图所示，界面含有</span><span>tab</span><span>，且可以左右滑动切换，</span><span>tab</span><span>标题的下划线会跟着手势左右滑动。大多见于</span><span>app</span><span>的首页（</span><span>mainActivity</span><span>）或者分频道首页，这种界面一般采用定制</span><span>webview</span><span>的做法：定制的导航组件和内容框架（为了支持左右滑动手势），</span><span>H5</span><span>打开此类界面一般也是开特殊的</span><span>API</span><span>：</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5spe2oSqWpuu8tee6xTZzelkgpoA1u1CfZ6uNhVBpHNCnxOaqgCfnKQ/0?wx_fmt=jpeg" data-ratio="0.15636363636363637" data-w=""><br></p><p><span><span>这种打开特殊的界面的</span><span>API</span><span>之所以特殊，是因为它内部要么是纯</span><span>Native</span><span>实现，要么是和某个约定的</span><span>html</span><span>文件绑定，调用时打开指定的</span><span>html</span><span>。假设这个例子中，</span><span>tab</span><span>内容是</span><span>H5</span><span>的，如果</span><span>H5</span><span>是</span><span>SPA</span><span>架构的那么</span><span>openMusic({'tab': 'personal'})</span><span>则对应</span><span>/music.html#personal</span><span>这个</span><span>url</span><span>，反之多页面的则可能对应</span><span>/mucic-personal.html</span><span>。</span></span></p><p><span>至于一般的打开新界面，则有两种可能：</span></p><p><span><span>1）app</span><span>内</span><span>H5</span><span>界面全选复制放进笔记指的是由</span><span>app</span><span>开发者开发的</span><span>H5</span><span>页面，也即是</span><span>app</span><span>的功能界面，一般互相跳转需要转场动画，打开方式是采用</span><span>Native</span><span>提供的接口打开，例如：</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb59uYzroQSEXtia0mWTmSzrwqZKF1QkibzhcwMAwf8pStDInBckfVyXKRg/0?wx_fmt=jpeg" data-ratio="0.24363636363636362" data-w=""><br></p><p><span><span>2）再配合下面即将提到的离线访问方式，基本可以做到模拟</span><span>Native</span><span>界面的效果。</span></span></p><p><span><span>第三方</span><span>H5</span><span>页面指的是</span><span>app</span><span>内嵌的第三方页面，一般由</span><span>`a`</span><span>标签直接打开，没有转场动画，但是要求打开</span><span>webview</span><span>默认的历史列表，以免打开多个链接后点回退直接回到</span><span>Native</span><span>主界面。</span></span></p><p><span><strong><span><span>系统级</span><span>UI</span><span>组件采用</span><span>Native</span></span></strong></span></p><p><span><span>基于以下原因，一些通用的</span><span>UI</span><span>组件，如</span><span>alert</span><span>、</span><span>toast</span><span>等将采用</span><span>Native</span><span>来实现：</span></span></p><p><span><span>1）H5</span><span>本身有这些组件，但是通常比较简陋，不能和</span><span>APP UI</span><span>风格统一，需要再定制，比如</span><span>alert</span><span>组件背景增加遮罩层</span></span></p><p><span><span>2）H5</span><span>来实现这些组件有时会存在坐标、尺寸计算误差，比如笔者之前遇到的是页面</span><span>load</span><span>异常需要调用对话框组件提示，但是这时候页面高度为</span><span>0</span><span>，所以会出现弹窗</span><span>“</span><span>消失</span><span>”</span><span>的现象</span></span></p><p><span><span>3）这些组件通常功能单一但是通用，适合做成公用组件整合到</span><span>HybridApi</span><span>里边</span></span></p><p><span><span>下面代码演示</span><span>H5</span><span>调用</span><span>Native</span><span>提供的</span><span>UI</span><span>组件：</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5ibicS2vaiaBhkh8vdGefehoShSPexFwj9k89dvIBy1l5w4YlMt9x1iamwQ/0?wx_fmt=jpeg" data-ratio="0.11272727272727273" data-w=""><br></p><p><span><strong><span><span>默认界面采用</span><span>Native</span></span></strong></span></p><p><span><span>由于</span><span>H5</span><span>是在</span><span>H5</span><span>容器里进行加载和渲染，所以</span><span>Native</span><span>很容易对</span><span>H5</span><span>页面的行为进行监控，包括进度条、</span><span>loading</span><span>动画、</span><span>404</span><span>监控、</span><span>5xx</span><span>监控、网络诊断等，并且在</span><span>H5</span><span>加载异常时提供默认界面供用户操作，防止</span><span>APP“</span><span>假死</span><span>”</span><span>。</span></span></p><p><span><span>下面是微信的</span><span>5xx</span><span>界面示意：</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5VAibW4YT35uYKLqYS58wHsjuOoibM0gVmMd9Qsn0Y4Y0JDkmP4oiafItQ/0?wx_fmt=jpeg" data-ratio="1.7955010224948875" data-w="489"><br></p><p><span><strong><span><span>设计</span><span>H5</span><span>容器</span></span></strong></span></p><p><span><span>Native</span><span>除了负责部分界面开发和公共</span><span>UI</span><span>组件设计之外，作为</span><span>H5</span><span>的</span><span>runtime</span><span>，</span><span>H5</span><span>容器是</span><span>hybrid</span><span>架构的核心部分，为了让</span><span>H5</span><span>运行更快速稳定和健壮，还应当提供并但不局限于下面几方面。</span></span></p><p><span><strong><span>H5</span><span>离线访问</span></strong></span></p><p><span><span>之所以选择</span><span>hybrid</span><span>方式来开发，其中一个原因就是要解决</span><span>webapp</span><span>访问慢的问题。即使我们的</span><span>H5</span><span>性能优化做的再好服务器在牛逼，碰到蜗牛一样的运营商网络你也没辙，有时候还会碰到流氓运营商再给</span><span>webapp</span><span>插点广告。。。哎说多了都是泪。</span></span></p><p><span><span>离线访问，顾名思义就是将</span><span>H5</span><span>预先放到用户手机，这样访问时就不会再走网络从而做到看起来和</span><span>Native APP</span><span>一样的快了。</span></span></p><p><span><span>但是离线机制绝不是把</span><span>H5</span><span>打包解压到手机</span><span>sd</span><span>卡这么简单粗暴，应该解决以下几个问题：</span></span></p><p><span><span>1）H5</span><span>应该有线上版本</span></span></p><p><span><span>作为访问离线资源的降级方案，当本地资源不存在的时候应该走现网去拉取对应资源，保证</span><span>H5</span><span>可用。另外就是，对于</span><span>H5</span><span>，我们不会把所有页面都使用离线访问，例如活动页面，这类快速上线又快速下线的页面，设计离线访问方式开发周期比较高，也有可能是页面完全是动态的，不同的用户在不同的时间看到的页面不一样，没法落地成静态页面，还有一类就是一些说明类的静态页面，更新频率很小的，也没必要做成离线占用手机存储空间。</span></span></p><p><span><span>2）开发调试</span><span>&amp;</span><span>抓包我们知道，基于</span><span>file</span><span>协议开发是完全基于开发机的，代码必须存放于物理机器，这意味着修改代码需要</span><span>push</span><span>到</span><span>sd</span><span>卡再看效果，虽然可以通过假链接访问开发机本地</span><span>server</span><span>发布时移除的方式，但是个人觉得还是太麻烦易出错。</span></span></p><p><span><span>3）为了实现同一资源的线上和离线访问，</span><span>Native</span><span>需要对</span><span>H5</span><span>的静态资源请求进行拦截判断，将静态资源</span><span>“</span><span>映射</span><span>”</span><span>到</span><span>sd</span><span>卡资源，即实现一个处理</span><span>H5</span><span>资源的本地路由，实现这一逻辑的模块暂且称之为</span><span>Local Url Router</span><span>，具体实现细节在文章后面。</span></span></p><p><span><strong><span><span>H5</span><span>离线动态更新机制</span></span></strong></span></p><p><span><span>将</span><span>H5</span><span>资源放置到本地离线访问，最大的挑战就是本地资源的动态更新如何设计，这部分可以说是最复杂的了，因为这同时涉及到</span><span>H5</span><span>、</span><span>Native</span><span>和服务器三方，覆盖式离线更新示意图如下：</span></span></p><p><span></span><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5ZKZERo5VSTBpOINbjzt3lNF7vU6oeQ54xDXKqYIbba7RjnQKF1iayrg/0?wx_fmt=png" data-ratio="0.7054545454545454" data-w=""><br></p><p><span><span>解释下上图，开发阶段</span><span>H5</span><span>代码可以通过手机设置</span><span>HTTP</span><span>代理方式直接访问开发机。完成开发之后，将</span><span>H5</span><span>代码推送到管理平台进行构建、打包，然后管理平台再通过事先设计好的长连接通道将</span><span>H5</span><span>新版本信息推送给客户端，客户端收到更新指令后开始下载新包、对包进行完整性校验、</span><span>merge</span><span>回本地对应的包，更新结束。</span></span></p><p><span><span>其中，管理平台推送给客户端的信息主要包括项目名（包名）、版本号、更新策略（增量</span><span>or</span><span>全量）、包</span><span>CDN</span><span>地址、</span><span>MD5</span><span>等。</span></span></p><p><span><span>通常来说，</span><span>H5</span><span>资源分为两种，经常更新的业务代码和不经常更新的框架、库代码和公用组件代码，为了实现离线资源的共享，在</span><span>H5</span><span>打包时可以采用分包的策略，将公用部分单独打包，在本地也是单独存放，分包及合并示意图：</span></span></p><p><span></span><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5S0AMXslPOk7gg65sE567kWZxDwqMpnmrLJ2nkqoj8EXKWiappQ2ReVg/0?wx_fmt=png" data-ratio="0.6927272727272727" data-w=""><br></p><p><span><strong><span>Local Url Router</span></strong></span></p><p><span>离线资源更新的问题解决了，剩下的就是如何使用离线资源了。</span></p><p><span><span>上面已经提到，对于</span><span>H5</span><span>的请求，线上和离线采用相同的</span><span>url</span><span>访问，这就需要</span><span>H5</span><span>容器对</span><span>H5</span><span>的资源请求进行拦截</span><span>“</span><span>映射</span><span>”</span><span>到本地，即</span><span>Local Url Router</span><span>。</span></span></p><p><span><span>Local Url Router</span><span>主要负责</span><span>H5</span><span>静态资源请求的分发（线上资源到</span><span>sd</span><span>卡资源的映射），但是不管是白名单还是过滤静态文件类型，</span><span>Native</span><span>拦截规则和映射规则将变得比较复杂。这里，</span><span><a><span>阿里去啊</span><span>app</span></a></span><span>的思路就比较赞，我们借鉴一下，将映射规则交给</span><span>H5</span><span>去生成：</span><span>H5</span><span>开发完成之后会扫描</span><span>H5</span><span>项目然后生成一份线上资源和离线资源路径的映射表（</span><span>souce-router.json</span><span>），</span><span>H5</span><span>容器只需负责解析这个映射表即可。</span></span></p><p><span><span>H5</span><span>资源包解压之后在本地的目录结构类似：</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5NjzFlxgYHXJe5QMjN8jEmlOXQ1a3VhsuAyYBSHhefWO1Lnq0berIZQ/0?wx_fmt=jpeg" data-ratio="0.4763636363636364" data-w=""><br></p><p><span><span>souce-router.json</span><span>的数据结构类似：</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5Gw2ibDMTzibf2sy7UkgT2hFaib9nqWF49IypJAdRINOR8N9uUY8K2Lia5w/0?wx_fmt=jpeg" data-ratio="0.4672727272727273" data-w=""><br></p><p><span><span>H5</span><span>容器拦截到静态资源请求时，如果本地有对应的文件则直接读取本地文件返回，否则发起</span><span>HTTP</span><span>请求获取线上资源，如果设计完整一点还可以考虑同时开启新线程去下载这个资源到本地，下次就走离线了。</span></span></p><p><span><span>下图演示资源在</span><span>app</span><span>内部的访问流程图：</span></span><img data-s="300,640" data-type="png" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb5LhRvwvLmfra2QL34rVzHVUWLibGgEiaibibGdqRdKFRZvVPhH9BRmzyQTA/0?wx_fmt=png" data-ratio="1.0145454545454546" data-w=""><br></p><p><span><span>其中</span><span>proxy</span><span>指的是开发时手机设置代理</span><span>http</span><span>代理到开发机。</span></span></p><p><span><strong><span>数据通道</span></strong></span></p><p><span>上报</span></p><p><span><span>由于界面由</span><span>H5</span><span>和</span><span>Native</span><span>共同完成，界面上的用户交互埋点数据最好由</span><span>H5</span><span>容器统一采集、上报，还有，由页面跳转产生的浏览轨迹（转化漏斗），也由</span><span>H5</span><span>容器记录和上报</span></span></p><p><span><span>ajax</span><span>代理</span></span></p><p><span><span>因</span><span>ajax</span><span>受同源策略限制，可以在</span><span>hybridApi</span><span>层对</span><span>ajax</span><span>进行统一封装，同时兼容</span><span>H5</span><span>容器和浏览器</span><span>runtime</span><span>，采用更高效的通讯通道加速</span><span>H5</span><span>的数据传输</span></span></p><p><span><span>Native</span><span>对</span><span>H5</span><span>的扩展</span></span></p><p><span><span>主要指扩展</span><span>H5</span><span>的硬件接口调用能力，比如屏幕旋转、摄像头、麦克风、位置服务等等，将</span><span>Native</span><span>的能力通过接口的形式提供给</span><span>H5</span><span>。</span></span></p><p><strong><span>综述</span></strong></p><p><span><span>最后来张图总结下，</span><span>hybrid</span><span>客户端整体架构图：</span></span></p><p><span></span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviaGHTaRiaHvKiaFX4nw5iapWb50DYeUia7lLmvqDMYaYdlyBVLvr2KbQyMzA7dQHouAJLOnBLAD08kEdw/0?wx_fmt=jpeg" data-ratio="0.5181818181818182" data-w=""><br></p><p><span><span>其中的</span><span>Synchronize Service</span><span>模块表示和服务器的长连接通信模块，用于接受服务器端各种推送，包括离线包等。</span><span>Source Merge Service</span><span>模块表示对解压后的</span><span>H5</span><span>资源进行更新，包括增加文件、以旧换新以及删除过期文件等。</span></span></p><p><span><span>可以看到，</span><span>hybrid</span><span>模式的</span><span>app</span><span>架构，最核心和最难的部分都是</span><span>H5</span><span>容器的设计。</span></span></p><p><font face="新細明體">关于本文</font></p><p><font face="新細明體">作者：@dmyang</font></p><p><font face="新細明體">原文链接：http://segmentfault.com/a/1190000004263182</font></p><p><font face="新細明體"><strong><span>长按图片识别图中二维码</span></strong></font></p><p><font face="新細明體"><strong><span><img data-s="300,640" data-type="jpeg" data-src="http://mmbiz.qpic.cn/mmbiz/meG6Vo0MeviagHx93mJX0lKcOj1viapEaeibLULic3Cy6sZAMTPUtH2jUeicOC64iaiaaD6fCAlLYoJ5MBtuDxgibwWQMA/0?wx_fmt=jpeg" data-ratio="1" data-w="430"><br></span></strong></font></p><span>
                    </span></div>
            </div>
            <script>var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-34802167-1']); _gaq.push(['_setDomainName', 'liuzhe.co']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();</script>
        </body>
        </html>