
        <!doctype html>
        <html>
        <head>
            <meta charset="utf-8"/>
            <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
            <title>Performance Calendar</title>
            <link rel="stylesheet" href="../css/article.css" />;
        </head>
        <body>
            <div class="m-content">
                <h1>Performance Calendar</h1>
                <div class="entry unit"><p>Most mobile carriers force all HTTP traffic to go through their proxies that—among other things—recompress images on the fly. This means that visitors of your website or mobile app may be getting images in much lower quality than you’re serving.</p><span>
</span><p><img src="http://calendar.perfplanet.com/wp-content/uploads/2013/12/proxies/on-the-fly-recompression.jpg" width="637" height="108" alt="Images become distorted and blocky after leaving your server."></p><span>
</span><p>I’ve decided to have a closer look at what exactly these proxies do to images and whether it can be improved. I’ve set up a <a href="http://geekhood.net/mob">test page</a> that downloads a set of sample images and re-uploads them back to my server for analysis. I’ve served 27 different images and got 231 unique files back.</p><span>
</span><p>It turns out that these proxies are not as bad as I expected, but quality of images they produce is rather low and cannot be relied upon. With few simple tweaks it’s possible to deliver images with even better compression and quality. Here’s what I’ve found:</p><span>
</span><ul>
<li>
<p>All proxies recompress all JPEG images. Unfortunately, even very low quality JPEGs are recompressed to have <em>even lower</em> quality. If you’re already using JPEGs at minimum acceptable quality (e.g. “compressive images” trick for high-dpi displays) you need to stop proxies from ruining them.</p>
</li>
<li>
<p>PNG images are very rarely recompressed. If you’re not using <a href="http://pngmini.com/lossypng.html">lossy PNG</a> yet—you really should!</p>
</li>
<li>
<p>Static GIF images are getting noticeably posterized/discolored/dithered. Fortunately, apart from nostalgia, there’s no reason to use GIF for images any more.</p>
<p> <img width="192" height="128" src="http://calendar.perfplanet.com/wp-content/uploads/2013/12/proxies/kodim23-o2uk.gif" title="O2 UK compressed" alt="dithered"> <img width="192" height="128" src="http://calendar.perfplanet.com/wp-content/uploads/2013/12/proxies/kodim23-sprint.gif" title="Sprint compressed" alt="posterized"></p>
</li>
<li>
<p>The standard HTTP header <code>Cache-Control: no-transform</code> which tells proxies not to modify responses was respected by all proxies I’ve encountered. This is amazing! It wins an award in the “Best Supported Obscure Header” category.</p>
</li>
</ul><span>
</span><h3>About proxies</h3><span>
</span><p><a href="http://www.citrix.com/products/bytemobile/overview.html">ByteMobile</a> proxy seems to be ISPs’ favorite. Sprint, Vodaphone.de, O2 (Telefonica), T-Mobile PL served bit-identical images that appear to be generated by this software. It also modifies HTML (and ignores MIME types and <a href="http://jonatkinson.co.uk/http1238bmi-int-jsbmijs/">breaks XML</a>) to inject <a href="http://pastie.org/8508600">a script</a> that allows users to reload images in original quality… with a <a href="http://www.geeky-gadgets.com/xskn-ikeyboard-for-the-iphone-04-09-2009/">keyboard shortcut</a>. The good news is that this proxy has a JPEG encoder tuned to perform relatively well on low quality images.</p><span>
</span><p>Centertel PL and openmobile.ne.jp use different software, but achieve similar results.</p><span>
</span><p>There was only one proxy that recompressed PNG images (it identifies itself as “bwo-c1s11 hpm/3.0”). It did OK job with opaque PNG files, but messed up transparency and made some PNGs larger.</p><span>
</span><h4>Opera Turbo &amp; Google Mobile Proxy</h4><span>
</span><p>These two proxies are not run by ISPs, but are integrated with Opera’s and Google’s browsers. They convert images to WebP and compress them very aggressively. They achieve smallest file sizes, but often also give lowest quality.</p><span>
</span><p>Google’s lossy WebP format is <a href="http://people.mozilla.org/~josh/lossy_compressed_image_study_october_2013/">not so good for high-quality images</a> (e.g. can’t store color at full resolution), but it’s strength is in low-quality range thanks to block prediction that can approximate edges and deblocking filter that blurs away some compression artifacts.</p><span>
</span><p>However, recompressing proxies are at a disadvantage, because they don’t have access to original high-quality images. They can only make bad quality worse, and lossy recompression of lossy format magnifies compression artifacts.</p><span>
</span><p>For example, a <a href="http://calendar.perfplanet.com/2013/mobile-isp-image-recompression/proxies/kodim19-26kb.jpg">26KB JPEG</a> image saved at “30%” quality was <em>losslessly</em> optimized to 24KB by openmobile.ne.jp. Google Proxy converted this image to a larger 24.7KB WebP that smudged away some details. Opera’s WebP settings blur even more:</p><span>
</span><table>
<tbody><tr>
<td><a href="http://calendar.perfplanet.com/2013/mobile-isp-image-recompression/proxies/kodim19-operaturbo.webp"><img width="192" height="192" src="http://calendar.perfplanet.com/wp-content/uploads/2013/12/proxies/kodim19-webp20kb.png" alt="blurred texture" title="Notice lack of texture on the wall and lack of red color on the cloud"></a>
</td><td><a href="http://calendar.perfplanet.com/2013/mobile-isp-image-recompression/proxies/kodim19-20kb.jpg"><img width="192" height="192" src="http://calendar.perfplanet.com/wp-content/uploads/2013/12/proxies/kodim19-jpeg20kb.png" alt="preserved detail" title="Details on the grass are preserved, altough sharpness caused false edge on the cloud"></a>
</td></tr><tr>
<td>20KB recompressed WebP
</td><td>20KB JPEG saved from source</td></tr></tbody></table><span>
</span><p>You’re better off optimizing images yourself from source files than relying on proxies to (re)compress for you.</p><span>
</span><h3>Other formats</h3><span>
</span><p>No proxy converts BMP or TIFF. These formats provide very weak or no compression, so it would be nice to protect users from such rare, but massive files. Similarly proxies miss out on converting uncompressed ICO files to PNG (tip: you can use PNG for <code>favicon.ico</code>—it works in all browsers including recent IE).</p><span>
</span><h4>Color profiles</h4><span>
</span><p>Only openmobile.ne.jp and Centertel PL support ICC color profiles. All other proxies misinterpreted colors as sRGB. Browser support for color profiles isn’t great either, so it’s best to <a href="http://imageoptim.com/color-profiles.html">use sRGB</a> from the start.</p><span>
</span><h4>GIF</h4><span>
</span><p>GIFs are converted to poorly chosen, posterized palettes with unused colors. Sadly no proxy converts them to PNG8, which would give bigger savings.</p><span>
</span><p>Animated GIFs are left unharmed, but you shouldn’t use them on mobile anyway. It may seem odd, but due to very inefficient compression and lack of hardware acceleration, GIFs are slower to download and may use more battery than high-end video codecs!</p><span>
</span><h3>Opting out</h3><span>
</span><p>Proxies cannot modify HTTPS traffic, so this is one way to bypass them. For insecure traffic, you can add an HTTP header.</p><span>
</span><p>In nginx:</p><span>
</span><pre><code>location ~* \.(png|jpg|jpeg|gif)$ { add_header "Cache-Control" "public, no-transform"; } </code></pre><span>
</span><p>Apache:</p><span>
</span><pre><code>&lt;IfModule mod_headers.c&gt; &lt;FilesMatch "\.(png|jpg|jpeg|gif)$"&gt; Header append Cache-Control "public, no-transform" &lt;/FilesMatch&gt; &lt;/IfModule&gt; </code></pre><span>
</span><p>Please opt out of recompression only if you’re heavily compressing and optimizing images yourself already. Keep in mind that there are still areas with 2G networks capped to 10KB/s. Recompressed ugly images are better than pretty images that won’t load before users lose patience and navigate away.</p><span>
</span><p>It’s also worth mentioning an unfortunate side-effect of HTTP proxies: <a href="http://blog.hekkers.net/2012/12/09/websockets-and-mobile-network-operators/">they break WebSocket connections</a> and there’s no easy “opt-out” for that. Instead you have to use WebSockets over HTTPS or switch to HTTP-compatible <a href="http://html5doctor.com/server-sent-events/">Server-Sent Events</a>.</p><span>
</span><h3>Takeaways</h3><span>
</span><ul>
<li>
<p>Make PNGs 70% smaller by converting them with a lossy PNG encoder. Check out <a href="http://pngmini.com/">ImageAlpha</a> or <a href="http://tinypng.org/">TinyPNG</a>.</p>
</li>
<li>
<p>Lower quality of JPEGs. “Quality” setting in JPEG is very misleading—it controls how much data is removed, but some images can tolerate much more compression than others. Tune it per image instead of using arbitrary high setting for all of them. Try <a href="http://jpegmini.com/">JPEGMini</a>/<ahref="https: github.com="" technopagan="" adept-jpg-compressor"="">Adept and <a href="http://imageoptim.com/">ImageOptim</a>.</ahref="https:></p>
</li>
<li>
<p>Serve well-optimized images over HTTPS or with <code>Cache-Control: no-transform</code> header to prevent further degradation.</p>
</li>
<li>
<p>Never use GIF, TIFF, BMP or other legacy formats.</p>
</li>
</ul><span>
</span><p>Merry compressing!</p><span>
</span><small>
<p>Icons by George Agpoon and Jaime Carrion from <a href="http://thenounproject.com/">The Noun Project</a>.</p>
</small><span>
</span></div>
            </div>
            <script>var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-34802167-1']); _gaq.push(['_setDomainName', 'liuzhe.co']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();</script>
        </body>
        </html>