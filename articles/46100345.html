<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"> 
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
	<title>Understanding hidden classes in v8 &raquo; Debuggable - Node.js Consulting</title>

	<link href="http://feeds.feedburner.com/debuggable" type="application/rss+xml" rel="alternate" title="RSS 2.0" />	<link rel="pingback" href="Debuggable.com/pingback" />
	<link rel="stylesheet" type="text/css" href="/css/aggregate/58a4727fb2207154ddd0739cbc3b15104ad6cd03/4026ee2275e22a4e5ec8aea13747c557.php" /></head>
	<body>
		<div class="container_16">
			<h1 id="logo-text"><a href="/">debuggable</a></h1>
			<ul id="navigation">
				<ul>
<li class=""><a href="/blog">Blog</a></li><li class="active"><a href="/">About</a></li></ul>			</ul>
			<div class="clear">&nbsp;</div>

			<div id="blueprint">
				<a href="/contact" class="contact">Contact Us</a>			</div>

			<div class="clear">&nbsp;</div>
			<div class="grid_11 alpha" id="content">
	<cake:nocache>
			<div class="messages empty"></div>
	</cake:nocache>
	<div class="post">
	<h2><a href="/posts/understanding-hidden-classes-in-v8:4c7e81e4-1330-4398-8bd2-761bcbdd56cb">Understanding hidden classes in v8</a></h2>	<div class="posted-on">
		<p>Posted on 1/9/10 by 
		<a href="/felix">Felix Geisend√∂rfer</a>				</p>
		<div class="thumb">
			<img alt="" src="/img/felix_thumb.jpg"/>		</div>
	</div>
	<div class="body">
				<p><strong>Update:</strong> As pointed out by mraleph from the v8 team in the comments, some of the analysis here is probably flawed. See his post for more details: <a href="http://mr-aleph.livejournal.com/288023.html">Understanding hidden classes in v8 - real picture</a></p>

<p>With <a href="http://jsconf.eu/">JSConf.eu</a> coming closer, I slowly have to start preparing my talk, which
mostly means hacking on <a href="http://github.com/felixge/node-dirty">node-dirty</a>.</p>

<p>I have a few goals for the project. My main interest is challenging a few
assumptions people have about the performance and complexity of database
systems. Most of that is material for another post and my talk itself, but
today I'd like to talk about hidden classes in v8.</p>

<p>One of the things that is really fast in v8 is property lookups. This is
due to an optimization that creates hidden classes for an object.</p>

<p>I could go into a lengthy explanation of how that works, but instead I'll
invite you to see for yourself.</p>

<p>Consider the following two examples and guess which runs faster, and by how much:</p>

<p>Example 1:</p>

<p><div class="clear"></div><div class="code debuggable_sh_js" style="white-space: wrap;white-space: nowrap;">
<span class="kw2">var</span> PROPERTIES = <span class="nu0">10000000</span>;<br />
<span class="kw2">var</span> o = <span class="br0">&#123;</span><span class="br0">&#125;</span>;<br />
<br />
<span class="kw2">var</span> start = +<span class="kw2">new</span> Date;<br />
<br />
<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw2">var</span> i = <span class="nu0">0</span>; i &lt; PROPERTIES; i++<span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; o<span class="br0">&#91;</span>i<span class="br0">&#93;</span> = i;<br />
<span class="br0">&#125;</span><br />
<br />
console.<span class="me1">log</span><span class="br0">&#40;</span>+<span class="kw2">new</span> Date - start<span class="br0">&#41;</span>;</div></p>

<p>Example 2:</p>

<p><div class="clear"></div><div class="code debuggable_sh_js" style="white-space: wrap;white-space: nowrap;">
<span class="kw2">var</span> PROPERTIES = <span class="nu0">10000000</span>;<br />
<br />
<span class="kw2">function</span> O<span class="br0">&#40;</span>size<span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; <span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw2">var</span> i = <span class="nu0">0</span>; i &lt; size; i++<span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; &nbsp; <span class="kw1">this</span><span class="br0">&#91;</span>i<span class="br0">&#93;</span> = <span class="kw2">null</span>;<br />
&nbsp; <span class="br0">&#125;</span><br />
<span class="br0">&#125;</span><br />
<br />
<span class="kw2">var</span> o = <span class="kw2">new</span> O<span class="br0">&#40;</span>PROPERTIES<span class="br0">&#41;</span>;<br />
<br />
<span class="kw2">var</span> start = +<span class="kw2">new</span> Date;<br />
<br />
<span class="kw1">for</span> <span class="br0">&#40;</span><span class="kw2">var</span> i = <span class="nu0">0</span>; i &lt; PROPERTIES; i++<span class="br0">&#41;</span> <span class="br0">&#123;</span><br />
&nbsp; o<span class="br0">&#91;</span>i<span class="br0">&#93;</span> = i;<br />
<span class="br0">&#125;</span><br />
<br />
console.<span class="me1">log</span><span class="br0">&#40;</span>+<span class="kw2">new</span> Date - start<span class="br0">&#41;</span>;</div></p>

<p>If you have guessed example 2, congratulations! Bonus points if you have also
guessed that example 2 is a nifty 10x faster than example 1.</p>

<p>For those familiar with v8, you probably already know what is going. For those
who don't, let me explain.</p>

<p>In example 1, every time you are setting a property on the <code>o</code> object, v8 is
creating a new hidden class that defines the "data structure" of the <code>o</code> object
to optimize property lookup performance.</p>

<p>In example 2, we are initializing these "hidden classes" the first time we create
our <code>o</code> object. So when we are overwriting these properties later on, it is blazing fast, because v8 already knows how to efficiently lookup those properties.</p>

<p>So if you're writing node.js code, the lesson learned here is that it is much faster to work with existing properties in v8, than to add new ones.</p>

<p>In my next version of dirty I am planning to take advantage of this behavior by pre-allocating properties before they are actually used. This will probably require a little trickery to map user-defined keys to pre-allocated properties, but it should result in an overall 10x performance boost for setting new keys.</p>

<p>Let me know what you think / if you have other clever v8 hacks to speed stuff up : ).</p>

<p>--fg</p>

<p>PS: You can read more about hidden classes in the <a href="http://code.google.com/apis/v8/design.html#prop_access">v8 docs</a>.</p>

<p><img style="display: none;" src="http://debuggable.com/posts/tick/4c7e81e4-1330-4398-8bd2-761bcbdd56cb"></p>
	</div>
	<div class="clear">&nbsp;</div>
	<div class="social">
	<p class="subscribe">Did you like this blog post? If so, please consider <a href="http://feeds.feedburner.com/debuggable">subscribing to the Blog RSS feed</a>.</p>

	<ul>
	<li class="sociablefirst">
				<a class="linkedin" title="LinkedIn" href="javascript:window.location='http://www.linkedin.com/shareArticle?mini=true&amp;url=http%3A%2F%2Fdebuggable.com%2Fposts%2Funderstanding-hidden-classes-in-v8%3A4c7e81e4-1330-4398-8bd2-761bcbdd56cb &amp;title=Understanding+hidden+classes+in+v8';" rel="nofollow">
			<img class="sociable-hovers" alt="Linked In" title="Linked In" src="/img/social_icons/linkedin.png"/>
		</a>
	</li>
	<li>
		<a class="sphinn" title="Sphinn" href="javascript:window.location='http://sphinn.com/index.php?c=post&amp;m=submit&amp;link=http%3A%2F%2Fdebuggable.com%2Fposts%2Funderstanding-hidden-classes-in-v8%3A4c7e81e4-1330-4398-8bd2-761bcbdd56cb';" rel="nofollow">
		<img class="sociable-hovers" alt="Sphinn" title="Sphinn" src="/img/social_icons/sphinn.png"/>
		</a>
	</li>
	<li>
		<a class="digg" title="Digg" href="javascript:window.location='http://digg.com/submit?url=http%3A%2F%2Fdebuggable.com%2Fposts%2Funderstanding-hidden-classes-in-v8%3A4c7e81e4-1330-4398-8bd2-761bcbdd56cb&amp;title=Understanding+hidden+classes+in+v8&amp;bodytext=+..&amp;media=News&amp;topic=Programming';" rel="nofollow">
		<img class="sociable-hovers" alt="Digg" title="Digg" src="/img/social_icons/digg.png"/>
		</a>
	</li>
	<li>
	<a class="del.icio.us" title="del.icio.us" href="javascript:window.location='http://delicious.com/post?url=