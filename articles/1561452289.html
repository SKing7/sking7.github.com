
        <!doctype html>
        <html>
        <head>
            <meta charset="utf-8"/>
            <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
            <title>一起脱去小程序的外套和内衣</title>
            <link rel="stylesheet" href="../css/article.css" />;
        </head>
        <body>
            <div class="m-content">
                <h1>一起脱去小程序的外套和内衣</h1>
                <div class="rich_media_content " id="js_content"><span>
                        

                        
                        
                        </span><p><span class="">| 导语</span><span>&nbsp;</span><span class="">微信小程序的公测掀起了学习小程序开发的浪潮，天生跨平台，即用即走、媲美原生体验、完善的文档、高效的开发框架，小程序给开发者带来了很多惊喜。通过这篇文章和大家一起分析小程序的架构，分享开发经验。</span></p><section class="tn-Powered-by-XIUMI"><span class="tn-Powered-by-XIUMI"><section class="tn-Powered-by-XIUMI">一、小程序介绍</section></span><section></section></section><p><strong><span>1、小程序特点</span></strong></p><p><img data-ratio="0.3875" data-s="300,640" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoW66B1pPl34Qfs4oMEiaX6PUvgoRF866npnicDaFq3Dft5LBxhsadPnzicg/640?wx_fmt=png" data-type="png" data-w="640"><br></p><p><strong><span>2、小程序演示</span></strong></p><p><span>视频地址：</span><a target="_blank">https://v.qq.com/x/page/w0353d7co6y.html &nbsp;</a></p><p><strong><span>3、小程序为什么那么快</span></strong></p><p><img data-s="300,640" data-type="png" data-ratio="0.8214904679376083" data-w="577" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoW4Fgt8Kicz96icVXFRa7Z8A4K6p9iaibIMvP3iasYhJTMZ4LwwDo8S6XJszA/0?"><br><span>&nbsp;</span></p><p><span>Page Frame</span></p><p><span>Native预先额外加载一个WebView<br>当打开指定页面时，用默认数据直接渲染，请求数据回来时局部更新<br>返回显示历史View<br>退出小程序，View状态不销毁</span></p><p><strong><span>4、小程序入口</span></strong></p><p><span>&nbsp;<img data-s="300,640" data-type="png" data-ratio="0.8266199649737302" data-w="571" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWa405kqibeWGDXTEGWhqdhCLiaPDEiabPsXYsxcBKW7AVUkho1hegHoTicA/0?"><br></span></p><p><span>扫码进入小程序</span></p><p><span>搜索小程序</span></p><p><span></span><span>小程序发送到桌面(Android)</span></p><p><span>发送给朋友</span></p><section class="tn-Powered-by-XIUMI"><span class="tn-Powered-by-XIUMI"><section class="tn-Powered-by-XIUMI">二、小程序架构</section></span><section></section></section><p>微信小程序的框架包含两部分View视图层、App Service逻辑层，View层用来渲染页面结构，AppService层用来逻辑处理、数据请求、接口调用，它们在两个线程里运行。</p><p>视图层使用WebView渲染，逻辑层使用JSCore运行。</p><p>视图层和逻辑层通过系统层的JSBridage进行通信，逻辑层把数据变化通知到视图层，触发视图层页面更新，视图层把触发的事件通知到逻辑层进行业务处理。</p><p><span><img data-ratio="0.5625" data-s="300,640" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWQRcemr99BvHUCMuy5byLNuOSDP6m1qUNek1I2T4s9T1VBeE4xNRN5A/640?wx_fmt=png" data-type="png" data-w="640"><br></span></p><p><span>小程序启动时会从CDN下载小程序的完整包&nbsp;</span></p><p><span><img data-ratio="0.5796875" data-s="300,640" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWseYVSialOYibZp3x8BenpeWcaZWmgMNico70lvfeb9tesWgRb6UAfGROA/640?wx_fmt=png" data-type="png" data-w="640">&nbsp;</span></p><section class="tn-Powered-by-XIUMI"><span class="tn-Powered-by-XIUMI"><section class="tn-Powered-by-XIUMI">三、View (页面视图)</section></span><section></section></section><p><span>视图层由 WXML 与 WXSS 编写，由组件来进行展示。</span></p><p><span>将逻辑层的数据反应成视图，同时将视图层的事件发送给逻辑层。</span></p><p><strong><span>1、View - WXML</span></strong></p><p><span>WXML（WeiXin Markup Language）</span></p><p><span>支持数据绑定</span></p><p><span>支持逻辑算术、运算</span></p><p><span>支持模板、引用</span></p><p><span>支持添加事件（bindtap）</span></p><p><span><img data-s="300,640" data-type="png" data-ratio="0.09956709956709957" data-w="1155" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWVOYPdRK8XcWmcnP8aKsu76jWpT4EUNM3FI7vxUs40r7yPrgt7OrSnQ/0?">&nbsp;</span></p><p><span>wxml编译器：wcc&nbsp; 把wxml文件 转为 js&nbsp; &nbsp;执行方式：wcc index.wxml&nbsp;&nbsp;</span></p><p><strong><span>2、View - WXSS</span></strong></p><p><span>WXSS(WeiXin Style Sheets)</span></p><p><span>支持大部分CSS特性</span></p><p><span>添加尺寸单位rpx，可根据屏幕宽度自适应</span></p><p><span>使用@import语句可以导入外联样式表</span></p><p><span>不支持多层选择器-避免被组件内结构破坏</span></p><p><span><img data-s="300,640" data-type="png" data-ratio="0.12655367231638417" data-w="885" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWNX9jlxmLp8mHRcyT5giauLuLefJJAX1TPh6hkMn8G7AVXxliciaABeR9g/0?"><br></span></p><p><span>wxss编译器：wcsc 把wxss文件转化为 js 执行方式： wcsc index.wxss</span></p><p><strong><span>3、View – WXSS Selectors</span></strong></p><p>WXSS目前支持如下选择器：</p><p><span><img data-s="300,640" data-type="png" data-ratio="0.5272391505078485" data-w="1083" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWDZTgIytWyF4IXcHFoyky9VBGqKUIK2shUWJG6QOQiaqbKAFERQNTPUg/0?"><br></span></p><p><strong><span>4、View - Component</span></strong></p><p>小程序提供了一系列组件用于开发业务功能，按照功能与HTML5的标签进行对比如下：</p><p><span><img data-ratio="0.7640625" data-s="300,640" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWeds3m0eqI0zzDlocXxfwkckOggrP2bD17Fp79STshKx74ZBdopwmJg/640?wx_fmt=png" data-type="png" data-w="640"><br></span></p><p><span>小程序的组件基于Web Component标准</span></p><p><span>使用Polymer框架实现Web Component</span></p><p><span><img data-ratio="1.0855263157894737" data-s="300,640" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWYOiaRjAEklPWWf66SicscVd6E7qz4eozAicxrhl1terSoR2kBAnvNOLaA/640?wx_fmt=png" data-type="png" data-w="456"><br></span></p><p><strong><span>5、View - Native Component</span></strong></p><p><span>目前Native实现的组件有&nbsp;&lt;canvas/&gt; &lt;video/&gt; &lt;map/&gt; &lt;textarea/&gt;</span></p><p><span>Native组件层在WebView层之上</span></p><p><span><img data-ratio="1.063613231552163" data-s="300,640" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWSvsnGezliap4qcicXtgtsZXcnMypVKy6dfB0KibvG4VicJgZyicwYujLlXQ/640?wx_fmt=png" data-type="png" data-w="393"><br></span></p><section class="tn-Powered-by-XIUMI"><span class="tn-Powered-by-XIUMI"><section class="tn-Powered-by-XIUMI">四、App Service(逻辑层)</section></span></section><p><span>逻辑层将数据进行处理后发送给视图层，同时接受视图层的事件反馈</span></p><p><span>1、App( ) 小程序的入口；Page( ) 页面的入口</span></p><p><span>3、提供丰富的 API，如微信用户数据，扫一扫，支付等微信特有能力。</span></p><p><span>4、每个页面有独立的作用域，并提供模块化能力。</span></p><p><span>5、数据绑定、事件分发、生命周期管理、路由管理</span></p><section class="tn-Powered-by-XIUMI"><span class="tn-Powered-by-XIUMI"><section class="tn-Powered-by-XIUMI">运行环境</section></span><section></section></section><p><span>IOS - JSCore</span></p><p><span>Android - X5 JS解析器</span></p><p><span>DevTool - nwjs Chrome 内核</span></p><p><strong><span>1、App Service - Binding</span></strong></p><p><span>数据绑定使用 Mustache 语法（双大括号）将变量包起来，动态数据均来自对应 Page 的 data，可以通过setData方法修改数据。</span></p><p><span><br>事件绑定的写法同组件的属性，以 key、value 的形式，key 以bind或catch开头，然后跟上事件的类型，如bindtap, catchtouchstart，value 是一个字符串，需要在对应的 Page 中定义同名的函数。&nbsp;</span></p><p><span><img data-ratio="0.14375" data-s="300,640" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWwNFbwXADuu9uGicVveF8ym4sOzSAMibibIIfFVZSsahfb7O7NupZsaHMA/640?wx_fmt=png" data-type="png" data-w="640"><br><img data-ratio="0.9569288389513109" data-s="300,640" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWCibFUNkIUTUvNHryaxKpN1ahmic3fwRbHwN8qHCmofUpWmFNut7yQdibQ/640?wx_fmt=png" data-type="png" data-w="534"><br></span></p><p><strong><span>2、App Service - Life Cylce</span></strong></p><p><span><img data-s="300,640" data-type="png" data-ratio="0.5021949078138718" data-w="1139" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWJoW8nvEgH7q4FgoonGpChsGyDTeIhOo84zZvicib6kr7ntSSia02seSpA/0?"></span></p><p><strong><span>3、App Service - API</span></strong></p><p><span>API通过JSBridge和Native 进行通信</span></p><p><span>&nbsp;<img data-ratio="0.6609375" data-s="300,640" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWjl2MP7JqhfMW8BiaaZuUM9plFqs62kXmZxQuBNGdhJTBddQ9GbQASbA/640?wx_fmt=png" data-type="png" data-w="640"><br></span></p><p><strong><span>4、App Service - Router</span></strong></p><p><strong><span>navigateTo(OBJECT)</span></strong></p><p><span>保留当前页面，跳转到应用内的某个页面，使用navigateBack可以返回到原页面。页面路径只能是五层</span></p><p><strong><span>redirectTo(OBJECT)</span></strong></p><p><span>关闭当前页面，跳转到应用内的某个页面。</span></p><p><strong><span>navigateBack(OBJECT)</span></strong></p><p><span>关闭当前页面，返回上一页面或多级页面。可通过 getCurrentPages()) 获取当前的页面栈，决定需要返回几层。</span></p><section class="tn-Powered-by-XIUMI"><span class="tn-Powered-by-XIUMI"><section class="tn-Powered-by-XIUMI">五、小程序开发经验</section></span><section></section></section><p><strong><span>1、小程序存在的问题</span></strong></p><p><span>小程序仍然使用WebView渲染，并非原生渲染</span></p><p><span><br>需要独立开发，不能在非微信环境运行</span><span>。</span></p><p><span>开发者不可以扩展新组件。</span></p><p><span><br>服务端接口返回的头无法执行，比如：Set-Cookie。</span></p><p><span><br>依赖浏览器环境的js库不能使用，因为是JSCore执行的，没有window、document对象。</span></p><p><span><br>WXSS中无法使用本地（图片、字体等）。</span></p><p><span><br>WXSS转化成js 而不是css，为了兼容rpx。</span></p><p><span><br>WXSS不支持级联选择器。</span></p><p><span><br>小程序无法打开页面，无法拉起APP。</span></p><p><span>小程序不能和公众号重名，于是小程序的名字就成了：自选股+、滴滴出行DiDi 。</span></p><p><strong><span>2、小程序可以借鉴的优点</span></strong></p><p><span>提前新建WebView，准备新页面渲染。</span></p><p><span><br>View层和逻辑层分离，通过数据驱动，不直接操作DOM。</span></p><p><span><br>使用Virtual DOM，进行局部更新。</span></p><p><span><br>全部使用https，确保传输中安全。</span></p><p><span><br>使用离线能力</span><span>。</span></p><p><span>前端组件化开发。</span></p><p><span><br>加入rpx单位，隔离设备尺寸，方便开发。</span></p><p><strong><span>3、脱离微信的“小程序”：PWA 渐进式应用</span></strong></p><p>PWA 全称是 Progressive Web Apps ，译成中文就是渐进式应用，是 Google 在 2015 年 6 月 15 日提出的概念。</p><p><br>Progressive Web Apps 是结合了 web 和 原生应用中最好功能的一种体验。对于首次访问的用户它是非常有利的, 用户可以直接在浏览器中进行访问，不需要安装应用。随着时间的推移当用户渐渐地和应用建立了联系，它将变得越来越强大。它能够快速地加载，即使在弱网络环境下，能够推送相关消息, 也可以像原生应用那样添加至主屏，能够有全屏浏览的体验。</p><p><img data-s="300,640" data-type="png" data-ratio="0.5235336712527154" data-w="1381" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWvTwfb7dRk4aznMMYuH6ddJHxEI6EFB96cWjZCyqicuBn2iaUFyyEsviag/0?"><br></p><p><br><strong>PWA具有如下特点：</strong><br></p><p><span>渐进增强</span>&nbsp;- 支持的新特性的浏览器获得更好的体验，不支持的保持原来的体验。</p><p><br><span>离线访问</span>&nbsp;- 通过 service workers 可以在离线或者网速差的环境下工作。</p><p><br><span>类原生应用&nbsp;</span>- 使用app shell model做到原生应用般的体验。</p><p><br><span>可安装</span>&nbsp;- 允许用户保留对他们有用的应用在主屏幕上，不需要通过应用商店。</p><p><br><span>容易分享</span>&nbsp;- 通过 URL 可以轻松分享应用。</p><p><br>持续更新&nbsp;- 受益于 service worker 的更新进程，应用能够始终保持更新。</p><p><br>安全&nbsp;- 通过 HTTPS 来提供服务来防止网络窥探，保证内容不被篡改。</p><p><br>可搜索&nbsp;- 得益于 W3C manifests 元数据和 service worker 的登记，让搜索引擎能够找到 web 应用。</p><p><br>再次访问&nbsp;- 通过消息推送等特性让用户再次访问变得容易。</p><section class="tn-Powered-by-XIUMI"><span class="tn-Powered-by-XIUMI"><section class="tn-Powered-by-XIUMI">Web App Manifest使Web更像Native</section></span><section></section></section><p><span></span><br>Web App Manifest以JSON的格式定义Web应用的相关配置（应用名称、图标或图像连接、启动URL、自定义特性、启动默认配置、全屏设置等）。<br></p><p><img data-s="300,640" data-type="png" data-ratio="0.6569250317662008" data-w="787" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWCokc7iajg5xfPe65dH5Xte0q1PIJJU8bf6EZazqbM12qUWHHjLhmgHQ/0?"><br></p><section class="tn-Powered-by-XIUMI"><span class="tn-Powered-by-XIUMI"><section class="tn-Powered-by-XIUMI">Service Workers增强Web能力</section></span><section></section></section><p>通过Service Works实现资源离线缓存和更新</p><p><img data-ratio="0.5734375" data-s="300,640" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWbRCBmwTPcdtVFWz32epibKGiciaiaiaJpicOjHNnd8XLE9p1qXIv1QCSvvrw/640?wx_fmt=png" data-type="png" data-w="640"><br></p><section class="tn-Powered-by-XIUMI"><span class="tn-Powered-by-XIUMI"><section class="tn-Powered-by-XIUMI">App Shell 提升显示效率</section></span><section></section></section><p>App Shell（应用外壳）是应用的用户界面所需的最基本的 HTML、CSS 和 JavaScript，首次加载后立刻被缓存下来，不需要每次使用时都被下载，而是只异步加载需要的数据，以达到UI保持本地化。</p><p><img data-ratio="0.5859375" data-s="300,640" data-src="http://mmbiz.qpic.cn/mmbiz_png/70ke266reibjRlKBMpdbibqCEUD5D5fNoWJtPZmiau7GicJhTeXianNn9YziaUkjVOBSZ7QNGfxDIksmQWLUJJLyDSibg/640?wx_fmt=png" data-type="png" data-w="640"><br></p><p>了解更多pwa资料：<br>https://developers.google.com/web/progressive-web-apps/</p><p><span>感谢jas、hulk提供的帮助。</span></p><p><span><strong>作者：渠宏伟</strong><span>，腾讯高级工程师，从事Web前端开发5年，先后负责企鹅电竞、腾讯视频VIP、腾讯OA开发框架、腾讯微信HR助手等项目。对Web前端架构、.NET架构有丰富的经验。</span></span></p><span>
                    </span></div>
            </div>
            <script>var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-34802167-1']); _gaq.push(['_setDomainName', 'liuzhe.co']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();</script>
        </body>
        </html>