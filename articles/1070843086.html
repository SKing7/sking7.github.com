
        <!doctype html>
        <html>
        <head>
            <meta charset="utf-8"/>
            <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
            <title>Why AMP HTML does not take full advantage of the preload scanner</title>
            <link rel="stylesheet" href="../css/article.css" />;
        </head>
        <body>
            <div class="m-content">
                <h1>Why AMP HTML does not take full advantage of the preload scanner</h1>
                <div class="section-content"><div class="section-inner layoutSingleColumn"><h3 name="e53b" id="e53b" class="graf--h3 graf--first">Why AMP HTML does not take full advantage of the preload scanner</h3><p name="9d33" id="9d33" class="graf--p graf-after--h3">One of the more controversial design decisions in <a href="https://www.ampproject.org/how-it-works/" data-href="https://www.ampproject.org/how-it-works/" class="markup--anchor markup--p-anchor" rel="nofollow">AMP HTML</a> is that it loads all external resources through custom elements. While this has some benefits (more on that later) it comes with one major problem: The browser’s <a href="http://gent.ilcore.com/2011/01/webkit-preloadscanner.html" data-href="http://gent.ilcore.com/2011/01/webkit-preloadscanner.html" class="markup--anchor markup--p-anchor" rel="nofollow">preload scanner</a> can no longer start downloading those resources very early in the document lifecycle and even worse: the browser needs to download a JavaScript file in order to be able to make those downloads.</p><p name="3271" id="3271" class="graf--p graf-after--p">The math here is easy: The earlier one starts with resource downloads the earlier they will be around. A very simple document that has a single image on it and nothing else will be much faster if it is not an AMP file.</p><figure name="1cd0" id="1cd0" class="graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked"><img class="graf-image" data-image-id="1*Nx0nb_5HJmJKj0rsQL823A.jpeg" data-width="2048" data-height="1536" data-action="zoom" data-action-value="1*Nx0nb_5HJmJKj0rsQL823A.jpeg" src="https://cdn-images-1.medium.com/max/800/1*Nx0nb_5HJmJKj0rsQL823A.jpeg"></div><figcaption class="imageCaption">A very slow scanner that is very unlike the preload scanner. Image: <a href="https://commons.wikimedia.org/wiki/File:Drum_scanner.jpg" data-href="https://commons.wikimedia.org/wiki/File:Drum_scanner.jpg" class="markup--anchor markup--figure-anchor" rel="nofollow">https://commons.wikimedia.org/wiki/File:Drum_scanner.jpg</a></figcaption></figure><p name="bb10" id="bb10" class="graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">So, why did AMP HTML disable this super important component of browser speed? — There are 2 primary reasons:</strong></p><h4 name="9cad" id="9cad" class="graf--h4 graf-after--p">Reason 1: The preload scanner’s impact is diminished in AMP</h4><p name="1c7b" id="1c7b" class="graf--p graf-after--h4">One of its core benefits is that it can start downloading resources before the document’s external stylesheets and synchronous JavaScript files located above the resource in the document hierarchy are downloaded. AMP doesn’t actually allow these, so that benefit goes away.</p><p name="bd96" id="bd96" class="graf--p graf-after--p">Additionally, because in AMP HTML the space that will be taken up for an image is always known without downloading it, the effect where a late image can impact page layout is eliminated.</p><h4 name="08bf" id="08bf" class="graf--h4 graf-after--p">Reason 2: Efficient prerendering[1]</h4><p name="391b" id="391b" class="graf--p graf-after--h4">While bare load time is important, AMP aims to support <em class="markup--em markup--p-em">instant</em> loading. This is achieved by prerendering documents. For prerendering an app may download and render a document before a user actually expresses the intent (aka tap, click or press) that they want to see the document. This requires that the app needs to guess which document the user will want to see. Guessing is significantly easier when one gets to make more guesses. In the best case all available documents can be prerendered.</p><blockquote name="d58c" id="d58c" class="graf--pullquote pullquote graf-after--p">Guessing is significantly easier when one gets to make more guesses</blockquote><p name="984e" id="984e" class="graf--p graf-after--pullquote">The main problem with prerendering is that it costs resources: both bandwidth and CPU. AMP HTML supports a special prerender mode for documents where only images are downloaded but no other resources and also only those images that are actually visible when the user first sees the document (aka above the fold). Ignoring CPU for a bit (and it is actually more important but harder to do math with) the following calculation can be done: Say a document typically has 4 large images, but only 1 of those is visible above the fold and download size is dominated by those images (because documents are small), then in AMP prerender-mode the browser can download and prerender 4 documents using the bandwidth that would have been required to prerender a single non-AMP document.</p><p name="585d" id="585d" class="graf--p graf-after--p">The consequence of this is that apps can prerender AMP HTML documents much more aggressively than they could prerender regular HTML documents.</p><h4 name="03fa" id="03fa" class="graf--h4 graf-after--p">Summary</h4><p name="b185" id="b185" class="graf--p graf-after--h4">AMP HTML works around the preload scanner because it somewhat paradoxically enables achieving the desired instant load effect. Even if not prerendering, AMP HTML’s document structure significantly offsets the benefits of the preload scanner, so loads are fast even when not prerendering.</p><ul class="postList"><li name="6849" id="6849" class="graf--li graf-after--p graf--last">[1] “Prerendering” in AMP is referring to an application concept instead of the <a href="https://en.wikipedia.org/wiki/Link_prefetching#HTML5_prefetching" data-href="https://en.wikipedia.org/wiki/Link_prefetching#HTML5_prefetching" class="markup--anchor markup--li-anchor" rel="nofollow">&lt;link rel=prerender&gt;</a> functionality that is available in some browsers. This may be implemented with a hidden iframe that renders the doc and gets displayed when the user requests it.</li></ul></div></div>
            </div>
            <script>var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-34802167-1']); _gaq.push(['_setDomainName', 'liuzhe.co']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();</script>
        </body>
        </html>