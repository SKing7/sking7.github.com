<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>EMC Community Network</title>
<link rel="stylesheet" href="../css/article.css" />
</head>
<body>
<div class="m-content">
<h1>EMC Community Network</h1>
<div class="WordSection1"><div><p class="MsoTitle"><strong><span lang="ZH-CN">一站式学习</span></strong><span><strong>Wireshark<span lang="ZH-CN">（四）：网络性能排查之</span>TCP<span lang="ZH-CN">重传与重复</span>ACK</strong></span></p></div><p class="MsoNormal"><span><strong><span lang="ZH-CN">转载请在文首保留原文出处：</span></strong></span><span><strong>EMC<span lang="ZH-CN">中文支持论坛</span></strong></span><a class="" href="https://community.emc.com/go/chinese"><span>https://community.emc.com/go/chinese</span></a><span> <span><a href=""><img alt="image001.gif" class="jive-image jiveImage" height="16" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86634/image001.gif" width="84" /></a></span></span></p><p class="MsoNormal"><span lang="ZH-CN">作为网络管理员，很多时间必然会耗费在修复慢速服务器和其他终端。但用户感到网络运行缓慢并不意味着就是网络问题。</span></p><p class="MsoNormal"><span lang="ZH-CN">解决网络性能问题，首先从</span><span>TCP<span lang="ZH-CN">错误恢复功能（</span>TCP<span lang="ZH-CN">重传与重复</span>ACK<span lang="ZH-CN">）和流控功能说起。之后阐述如何发现网络慢速之源。最后，对网络各组成部分上的数据流进行概况分析。这几张内容将会帮助读者识别，诊断，以及排查慢速网络。</span></span></p><p class="MsoNormal"><a name="OLE_LINK2"></a><a name="OLE_LINK1"></a><span lang="ZH-CN">接下来的内容，较多是黑白图片了</span><span lang="ZH-CN">。虽然看起来有点不爽，但还是很值得一看。</span></p><p class="MsoNormal"><a name="OLE_LINK4"></a><a name="OLE_LINK3"></a><span><strong>TCP<span lang="ZH-CN">错误恢复功能：</span></strong></span></p><p class="MsoNormal"><span>TCP<span lang="ZH-CN">的错误恢复功能是定位，诊断及修复网络延时的最佳工具。</span></span></p><p class="MsoNormal"><span lang="ZH-CN">延时可以在单程也可以往返方向测量。高延时是网络管理员的头号大敌。本节我们讨论</span><span>TCP<span lang="ZH-CN">高延时是如何导致序列号和确认号乱序的。</span></span></p><p class="MsoNormal"><a name="OLE_LINK9"></a><a name="OLE_LINK8"></a><span><strong>TCP<span lang="ZH-CN">重传：</span></strong></span></p><p class="MsoNormal"><span lang="ZH-CN">主机报文重传是</span><span>TCP<span lang="ZH-CN">最基本的错误恢复功能，它的目的是防止报文丢失。</span></span></p><p class="MsoNormal"><span lang="ZH-CN">报文丢失的可能因素有很多种，包括应用故障，路由设备过载，或暂时的服务宕机。报文级别速度是很高的，而通常报文丢失是暂时的，因此</span><span>TCP<span lang="ZH-CN">能够发现和恢复报文丢失显得尤为重要。</span></span></p><p class="MsoNormal"><span lang="ZH-CN">决定报文是否有必要重传的主要机制是重传计时器（</span><span>retransmission timer<span lang="ZH-CN">），它的主要功能是维护重传超时（</span>RTO<span lang="ZH-CN">）值。当报文使用</span>TCP<span lang="ZH-CN">传输时，重传计时器启动，收到</span>ACK<span lang="ZH-CN">时计时器停止。报文发送至接收到</span>ACK<span lang="ZH-CN">的时间称为往返时间（</span>RTT<span lang="ZH-CN">）。对若干次时间取平均值，该值用于确定最终</span>RTO<span lang="ZH-CN">值。在最终</span>RTO<span lang="ZH-CN">值确定之前，确定每一次报文传输是否有丢包发生使用重传计时器，下图说明了</span>TCP<span lang="ZH-CN">重传过程。</span></span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86613/image001.jpg"><img alt="image001.jpg" class="jive-image" height="331" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86613/image001.jpg" width="549" /></a></p><p class="MsoNormal"><span lang="ZH-CN">当报文发送之后，但接收方尚未发送</span><span>TCP ACK<span lang="ZH-CN">报文，发送方假设源报文丢失并将其重传。重传之后，</span>RTO<span lang="ZH-CN">值加倍；如果在</span>2<span lang="ZH-CN">倍</span>RTO<span lang="ZH-CN">值到达之前还是没有收到</span>ACK<span lang="ZH-CN">报文，就再次重传。如果仍然没有收到</span>ACK<span lang="ZH-CN">，那么</span>RTO<span lang="ZH-CN">值再次加倍。如此持续下去，每次重传</span>RTO<span lang="ZH-CN">都翻倍，直到收到</span>ACK<span lang="ZH-CN">报文或发送方达到配置的最大重传次数。</span></span></p><p class="MsoNormal"><span lang="ZH-CN">最大重传次数取决于发送操作系统的配置值。默认情况下，</span><span>Windows<span lang="ZH-CN">主机默认重传</span>5<span lang="ZH-CN">次。大多数</span>Linux<span lang="ZH-CN">系统默认最大</span>15<span lang="ZH-CN">次。两种操作系统都可配置。</span></span></p><p class="MsoNormal"><span lang="ZH-CN">示例如下图：</span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86614/image002.png"><img alt="image002.png" class="jive-image" height="364" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86614/670-364/image002.png" width="670" /></a></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86615/image003.png"><img alt="image003.png" class="jive-image" height="487" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86615/670-487/image003.png" width="670" /></a></p><p class="MsoNormal"><span>TCP<span lang="ZH-CN">重传过程发送的第一个报文如下图所示（图片不很清楚，已经尽力了）：</span></span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86619/image004.jpg"><img alt="image004.jpg" class="jive-image" height="301" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86619/image004.jpg" width="657" /></a></p><p class="MsoNormal"><span lang="ZH-CN">这是一个</span><span>TCP PSH/ACK<span lang="ZH-CN">报文</span></span><span><span lang="ZH-CN">①</span></span><span><span lang="ZH-CN">，包含</span>648<span lang="ZH-CN">字节数据</span></span><span><span lang="ZH-CN">②</span></span><span><span lang="ZH-CN">，从</span>10.3.30.1<span lang="ZH-CN">发送至</span>10.3.71.7<span lang="ZH-CN">。这是一个典型的数据报文。</span></span></p><p class="MsoNormal"><span lang="ZH-CN">在通常情况下，第一个报文发送之后很快会收到</span><span>TCP ACK<span lang="ZH-CN">报文。然而，在这个</span>case<span lang="ZH-CN">里，第二个是重传报文。可以在</span>Packet list<span lang="ZH-CN">面板里看到。</span>Info<span lang="ZH-CN">栏清楚的标明“</span>TCP Retransmission<span lang="ZH-CN">”，报文以黑色背景红色字体标出。下图是</span>Packet List<span lang="ZH-CN">面板中的重传示例（仍然不清楚，但可参见上图）：</span></span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86620/image005.jpg"><img alt="image005.jpg" class="jive-image" height="64" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86620/670-64/image005.jpg" width="670" /></a></p><p class="MsoNormal"><span lang="ZH-CN">也可以在</span><span>Packet Details<span lang="ZH-CN">和</span>Packet Bytes<span lang="ZH-CN">面板中查看来确定是否是重传报文，如下图所示：</span></span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86621/image006.jpg"><img alt="image006.jpg" class="jive-image" height="330" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86621/image006.jpg" width="653" /></a></p><p class="MsoNormal"><span lang="ZH-CN">注意此报文与源报文相同（除了</span><a name="OLE_LINK7"></a><a name="OLE_LINK6"></a><span lang="EN">IP</span><span lang="ZH-CN">标识和</span><span lang="EN">checksum</span><span lang="ZH-CN">字段）。要验证这一点，比较两个报文的</span><span lang="EN">Packet Bytes</span><span lang="ZH-CN">①</span><span lang="ZH-CN">。</span></p><p class="MsoNormal"><span lang="ZH-CN">在</span><span lang="EN">Packet Details</span><span lang="ZH-CN">面板，注意到重传报文在</span><a name="OLE_LINK5"></a><span lang="EN">SEQ/ACK Analysis</span><span lang="ZH-CN">下面有些额外的信息</span><span lang="ZH-CN">②</span><span lang="ZH-CN">。这些信息是由</span><span lang="EN">Wireshark</span><span lang="ZH-CN">提供的而并非报文本身。</span><span lang="EN">SEQ/ACK Analysis</span><span lang="ZH-CN">告诉我们这确实是一个重传报文，</span><span lang="EN">RTO</span><span lang="ZH-CN">值是</span><span lang="EN">0.206</span><span lang="ZH-CN">秒，此时的</span><span lang="EN">RTO</span><span lang="ZH-CN">是基于报文</span><span lang="EN">1</span><span lang="ZH-CN">的时间增量。</span></p><p class="MsoNormal"><span lang="ZH-CN">检查剩下的报文会得到类似的结果，不同之处只有</span><span lang="EN">IP</span><span lang="ZH-CN">标识和</span><span lang="EN">checksum</span><span lang="ZH-CN">，以及</span><span lang="EN">RTO</span><span lang="ZH-CN">值。要使报文之间的时间间隔形象化，在</span><span lang="EN">Packet List</span><span lang="ZH-CN">面板中查看</span><span lang="EN">Time</span><span lang="ZH-CN">栏，如下图所示。这里可以看到</span><span lang="EN">RTO</span><span lang="ZH-CN">值的翻倍增长关系。</span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86625/image007.png"><img alt="image007.png" class="jive-image" height="121" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86625/image007.png" width="134" /></a></p><p class="MsoNormal"><span><strong>TCP<span lang="ZH-CN">重复</span>ACK<span lang="ZH-CN">以及快速重传：</span></strong></span></p><p class="MsoNormal"><span lang="ZH-CN">重复</span><span>ACK<span lang="ZH-CN">是指在接收方收到乱序报文时，所发出的一类</span>TCP<span lang="ZH-CN">报文。</span>TCP<span lang="ZH-CN">使用报文头的序列号和确认号以有效保证数据按照发送的顺序接收和重组。</span></span></p><p class="MsoNormal"><span lang="ZH-CN">当</span><span>TCP<span lang="ZH-CN">连接建立以后，握手过程中交换的一个最重要的信息是初始序列号（</span>ISN<span lang="ZH-CN">）。一旦连接双方设定了</span>ISN<span lang="ZH-CN">之后，接下来发送的报文所包含的序列号增加一个数据载荷值。</span></span></p><p class="MsoNormal"><span lang="ZH-CN">假设有个主机</span><span>ISN<span lang="ZH-CN">是</span>5000<span lang="ZH-CN">，发送</span>500<span lang="ZH-CN">字节报文至接收方。一旦报文接收之后，接收端回复一个</span>ACK<span lang="ZH-CN">号为</span>5500<span lang="ZH-CN">的</span>TCP ACK<span lang="ZH-CN">报文，基于以下公式：</span></span></p><p class="MsoNormal"><span>Sequence Number In + Bytes of Data Received = Acknowledgment Number Out</span></p><p class="MsoNormal"><span lang="ZH-CN">按照上述计算结果，返回发送端的确认编号实际上是接收端希望收到的序列号。示例如下图：</span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86626/image008.jpg"><img alt="image008.jpg" class="jive-image" height="247" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86626/image008.jpg" width="549" /></a></p><p class="MsoNormal"><span lang="ZH-CN">数据接收方通过序列号来检查报文丢失。接收方通过追踪接收到的序列号，能够确认序列号是否乱序。当接收方收到一个不正常的序列号，它会假设传输过程中有报文丢失。为了正确重传数据，接收方必须拥有丢失报文，所以它发送包含有丢失报文正确序列号的</span><span>ACK<span lang="ZH-CN">报文，以便发送方重传此报文。</span></span></p><p class="MsoNormal"><span lang="ZH-CN">当重传主机从发送端接收到</span><span>3<span lang="ZH-CN">个重复</span>ACK<span lang="ZH-CN">时，它会假设此报文确实在传送中丢失，并且立即发送一个快速重传。一旦触发了快速重传，所有正在传输的其他报文都被放入队列中，直到快速重传报文发送为止。过程如下图所示：</span></span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86627/image009.jpg"><img alt="image009.jpg" class="jive-image" height="343" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86627/image009.jpg" width="549" /></a></p><p class="MsoNormal"><span lang="ZH-CN">承接上文的彩图：</span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86628/image010.png"><img alt="image010.png" class="jive-image" height="420" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86628/670-420/image010.png" width="670" /></a></p><p class="MsoNormal"><span lang="ZH-CN">本例中第一个报文如下图：</span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86629/image011.jpg"><img alt="image011.jpg" class="jive-image" height="234" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86629/image011.jpg" width="663" /></a></p><p class="MsoNormal"><span lang="ZH-CN">这是一个</span><span>TCP ACK<span lang="ZH-CN">报文，从数据接收端（</span>172.31.136.85<span lang="ZH-CN">）发给发送端（</span>195.81.202.68<span lang="ZH-CN">）</span></span><span><span lang="ZH-CN">①</span></span><span><span lang="ZH-CN">，确认前一个报文所发送的数据。</span></span></p><p class="MsoNormal"><span lang="ZH-CN">此报文中的确认编号是</span><span>1310973186</span><span><span lang="ZH-CN">②</span></span><span><span lang="ZH-CN">，应当是下一个接收报文的序列号，如下图所示：</span></span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86630/image012.jpg"><img alt="image012.jpg" class="jive-image" height="266" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86630/image012.jpg" width="661" /></a></p><p class="MsoNormal"><span lang="ZH-CN">不幸的是接收端的序列号是</span><span>1310984130</span><span><span lang="ZH-CN">①</span></span><span><span lang="ZH-CN">，并不是所期望的值。这意味着报文在传送中丢失。接收端注意到报文乱序，并且在第三个报文中发送重复</span>ACK<span lang="ZH-CN">，如下图所示：</span></span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86631/image013.jpg"><img alt="image013.jpg" class="jive-image" height="289" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86631/image013.jpg" width="654" /></a></p><p class="MsoNormal"><span lang="ZH-CN">可以通过以下两种方式之一来确认这是一个重复</span><span>ACK<span lang="ZH-CN">：</span></span></p><p class="MsoNormal"><span lang="ZH-CN">在</span><span>Packet Detaisl<span lang="ZH-CN">面板中的</span>Info<span lang="ZH-CN">栏。报文呈现黑色背景红色字体。</span></span></p><p class="MsoNormal"><a name="OLE_LINK13"></a><a name="OLE_LINK12"></a><span>SEQ/ACK Analysis</span><span lang="ZH-CN">下的</span><span>Packet Deatails<span lang="ZH-CN">面板。扩展这一栏会发现报文显示为</span>duplicate ACK<span lang="ZH-CN">。接下来几个报文重复此过程。如下图所示：</span></span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86632/image014.jpg"><img alt="image014.jpg" class="jive-image" height="78" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86632/670-78/image014.jpg" width="670" /></a></p><p class="MsoNormal"><span lang="ZH-CN">此文件中的第四个报文是发送端所发出具有错误序列号</span><span lang="ZH-CN">①</span><span lang="ZH-CN">的另一个数据块。因此，接收端发送第二个重复</span><span lang="EN">ACK</span><span lang="ZH-CN">②</span><span lang="ZH-CN">。接收端又收到一个乱序报文</span><span lang="ZH-CN">③</span><span lang="ZH-CN">。从而触发了第三以及最后一个重复</span><span lang="EN">ACK</span><span lang="ZH-CN">④</span><span lang="EN">.</span></p><p class="MsoNormal"><span lang="ZH-CN">一旦发送方接收到接收方所发来的第三个重复</span><span lang="EN">ACK</span><span lang="ZH-CN">，它就会暂停所有传输报文并且重传丢失报文，下图显示了快速重传过程：</span></p><p class="MsoNormal"><a href="https://community.emc.com/servlet/JiveServlet/showImage/2-819924-86633/image015.jpg"><img alt="image015.jpg" class="jive-image" height="288" src="https://community.emc.com/servlet/JiveServlet/downloadImage/2-819924-86633/image015.jpg" width="653" /></a></p><p class="MsoNormal"><span lang="ZH-CN">重传报文同样可以通过</span><span lang="EN">Packet List</span><span lang="ZH-CN">面板的</span><span lang="EN">Info</span><span lang="ZH-CN">栏观察到。</span><span lang="ZH-CN">报文呈现黑色背景红色字体。这个报文的</span><span>SEQ/ACK Analysis<span lang="ZH-CN">截面告诉我们这可能是一个快速重传帧。（标识报文为快速重传的信息不是报文本身所包含的内容，而是</span>Wireshark<span lang="ZH-CN">的功能）。最后一个报文是接收到快速重传的</span>ACK<span lang="ZH-CN">。</span></span></p></div></div>
<script>var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-34802167-1']); _gaq.push(['_setDomainName', 'liuzhe.co']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();</script></body>
</html>