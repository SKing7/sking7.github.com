<!doctype html> 
<!--[if IEMobile 7 ]> <html lang="en-US"class="no-js iem7"> <![endif]-->
<!--[if lt IE 7 ]> <html lang="en-US" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en-US" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en-US" class="no-js ie8"> <![endif]-->
<!--[if (gte IE 9)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html lang="en-US" class="no-js"><!--<![endif]-->
	
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		
		<title>
			  CSS Preload Scanner in WebKit 
		</title>
				
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		
		<!-- icons & favicons -->
		<!-- For iPhone 4 -->
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/images/icons/h/apple-touch-icon.png">
		<!-- For iPad 1-->
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/images/icons/m/apple-touch-icon.png">
		<!-- For iPhone 3G, iPod Touch and Android -->
		<link rel="apple-touch-icon-precomposed" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/images/icons/l/apple-touch-icon-precomposed.png">
		<!-- For Nokia -->
		<link rel="shortcut icon" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/images/icons/l/apple-touch-icon.png">
		<!-- For everything else -->
		<!-- <link rel="shortcut icon" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/favicon.ico"> -->
				
		<!-- media-queries.js (fallback) -->
		<!--[if lt IE 9]>
			<script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>			
		<![endif]-->

		<!-- html5.js -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		
  		<link rel="pingback" href="http://ariya.ofilabs.com/xmlrpc.php">

  		<link rel="stylesheet/less" type="text/css" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/less/bootstrap.less">
  		<link rel="stylesheet/less" type="text/css" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/less/responsive.less">

		<!-- wordpress head functions -->
		<link rel='stylesheet' id='wp-syntax-css-css'  href='http://ariya.ofilabs.com/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='jetpack-widgets-css'  href='http://ariya.ofilabs.com/wp-content/plugins/jetpack/modules/widgets/widgets.css?ver=20121003' type='text/css' media='all' />
<link rel='stylesheet' id='bootstrap-css'  href='http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/css/bootstrap.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='bootstrap-responsive-css'  href='http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/css/responsive.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='wp-bootstrap-css'  href='http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/style.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='sharedaddy-css'  href='http://ariya.ofilabs.com/wp-content/plugins/jetpack/modules/sharedaddy/sharing.css?ver=2.5' type='text/css' media='all' />
<script type='text/javascript' src='http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/js/libs/jquery-1.7.1.min.js?ver=1.7.1'></script>
<script type='text/javascript' src='http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/js/bootstrap.min.js?ver=3.6.1'></script>
<script type='text/javascript' src='http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/js/scripts.js?ver=3.6.1'></script>
<script type='text/javascript' src='http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/js/modernizr.full.min.js?ver=3.6.1'></script>
<script type='text/javascript' src='http://ariya.ofilabs.com/wp-includes/js/comment-reply.min.js?ver=3.6.1'></script>
<link rel='canonical' href='http://ariya.ofilabs.com/2013/04/css-preload-scanner-in-webkit.html' />
<link rel='shortlink' href='http://wp.me/p2lzjD-gV' />
<link rel="stylesheet" type="text/css" href="http://ariya.ofilabs.com/wp-content/plugins/microkids-related-posts/microkids-related-posts-default.css" />
<!-- Simple Google Analytics Begin -->
<script type="text/javascript">
var _gaq = [['_setAccount','UA-24809129-1'],['_setDomainName','ariya.ofilabs.com'],['_trackPageLoadTime'],['_trackPageview']];(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
<!-- Simple Google Analytics End -->

<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="CSS Preload Scanner in WebKit" />
<meta property="og:url" content="http://ariya.ofilabs.com/2013/04/css-preload-scanner-in-webkit.html" />
<meta property="og:description" content="In WebKit world, preload scanner refers to a side parser which kicks in if the main HTML parser is halted by a blocking script loading. Because this preload scanner can see what other resources (e...." />
<meta property="og:site_name" content="don&#039;t code today what you can&#039;t debug tomorrow" />
<meta name="twitter:site" content="@jetpack" />
<meta name="twitter:card" content="summary" />
		<link rel="stylesheet" id="custom-css-css" type="text/css" href="http://ariya.ofilabs.com/?custom-css=1&#038;csblog=1&#038;cscache=6&#038;csrev=31" />
				<!-- end of wordpress head -->

		<!-- theme options from options panel -->
		<style>
        h1, h2, h3, h4, h5, h6{ 
          font-family: "Helvetica Neue",Helvetica,Arial,sans-serif; 
          font-weight: bold; 
          color: #404040; 
        }
        body{ 
          font-family: "Helvetica Neue",Helvetica,Arial,sans-serif; 
          font-weight: normal; 
          color: #404040; 
        }
        .navbar-inner, .navbar .fill { 
          background-color: #222222;
        }#222222
        .navbar-inner, .navbar .fill {
          background-image: -khtml-gradient(linear, left top, left bottom, from(#222222), to(#333333));
          background-image: -moz-linear-gradient(top, #222222, #333333);
          background-image: -ms-linear-gradient(top, #222222, #333333);
          background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #222222), color-stop(100%, #333333));
          background-image: -webkit-linear-gradient(top, #222222, #3333332);
          background-image: -o-linear-gradient(top, #222222, #333333);
          background-image: linear-gradient(top, #222222, #333333);
          filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#222222', endColorstr='#3333332', GradientType=0);
        }
        .navbar .nav li a { 
          color: #BFBFBF;
        }
        .navbar .nav li a:hover { 
          color: #FFFFFF;
        }
          .dropdown-menu li > a:hover, .dropdown-menu .active > a, .dropdown-menu .active > a:hover {
            background-color: #0088CC;
          }
        
          .dropdown-menu a{
            color: #555555 !important;
          }
        
        .hero-unit { 
          background-color: #F5F5F5;
        }
        #main article {
          border-bottom: none;
        }h1.h2 {
letter-spacing: -1px;
font-weight: normal;
}

div.postauthor &gt; div {
padding-right: 25px;
}

blockquote p {
font-size: 13px;
}

h1.singletitle {
letter-spacing: -1px;
font-weight: normal;
}

pre {
border: none;
padding: 2px;
background-color: transparent;
}

code {
color: black;
}

.related-posts {
margin-top: 20px;
}
        </style>
						
	</head>
	
	<body class="single single-post postid-1049 single-format-standard">
				
		<header role="banner">
		
			<div id="inner-header" class="clearfix">
				
				<div class="navbar navbar-fixed-top">
					<div class="navbar-inner">
						<div class="container-fluid nav-container">
							<nav role="navigation">
								<a class="brand" id="logo" title="" href="http://ariya.ofilabs.com">don&#039;t code today what you can&#039;t debug tomorrow</a>
								
								<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
							        <span class="icon-bar"></span>
							        <span class="icon-bar"></span>
							        <span class="icon-bar"></span>
								</a>
								
								<div class="nav-collapse">
									<ul id="menu-nav" class="nav"><li id="menu-item-970" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://ariya.ofilabs.com/about">About</a></li>
<li id="menu-item-1025" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://ariya.ofilabs.com/highlights">Highlights</a></li>
<li id="menu-item-972" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://ariya.ofilabs.com/projects">Projects</a></li>
<li id="menu-item-971" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://ariya.ofilabs.com/talks">Talks</a></li>
</ul>								</div>
								
							</nav>
							
														
						</div>
					</div>
				</div>
			
			</div> <!-- end #inner-header -->
		
		</header> <!-- end header -->
		
		<div class="container-fluid">			
			<div id="content" class="clearfix row-fluid">
			
				<div id="main" class="span8 clearfix" role="main">

										
					<article id="post-1049" class="post-1049 post type-post status-publish format-standard hentry category-uncategorized tag-css tag-optimization tag-web tag-webkit clearfix" role="article" itemscope itemtype="http://schema.org/BlogPosting">
						
						<header>
						
														
							<div class="page-header"><h1 class="single-title" itemprop="headline">CSS Preload Scanner in WebKit</h1></div>
							
							<p class="meta"><time datetime="2013-04-9" pubdate>April 9, 2013</time>.</p>
							<p class="tags"><span class="tags-title">Tags:</span> <a href="http://ariya.ofilabs.com/tag/css" rel="tag">css</a> <a href="http://ariya.ofilabs.com/tag/optimization" rel="tag">optimization</a> <a href="http://ariya.ofilabs.com/tag/web" rel="tag">web</a> <a href="http://ariya.ofilabs.com/tag/webkit" rel="tag">webkit</a></p>							

						
						</header> <!-- end article header -->
					
						<section class="post_content clearfix" itemprop="articleBody">
							<p class="lead">In WebKit world, <a href="https://www.webkit.org/blog/166/optimizing-page-loading-in-web-browser/">preload scanner</a> refers to a side parser which kicks in if the main HTML parser is halted by a blocking script loading. Because this preload scanner can see what <a href="https://github.com/WebKit/webkit/blob/master/Source/WebCore/html/parser/HTMLPreloadScanner.cpp#L89">other resources</a> (e.g. stylesheets, images, inputs) are to be fetched, it can trigger the associated network requests as early as possible, without waiting for the main parser to finish, thereby <a href="http://gent.ilcore.com/2011/01/webkit-preloadscanner.html">improving the overall loading time</a>. Now, what about speculatively loading dependent resources on a stylesheet instead of the main HTML file? Fortunately, WebKit has something called <em>CSS Preload Scanner</em>.</p>
<p>During the <a href="https://www.webkit.org/blog/1273/the-html5-parsing-algorithm/">implementation</a> of a standard-compliant HTML5 parser in WebKit, the preload scanner <a href="http://trac.webkit.org/changeset/61366">got cleaned up</a>. While the bulk of the scanning still resides in the main <code>HTMLPreloadScanner</code>, a small portion went into its own <code>CSSPreloadScanner</code>. Like its HTML cousin, the job of CSS Preload Scanner is to scan the stylesheet for resources which can be fetched early. For now, it only supports CSS <a href="http://www.w3.org/TR/CSS21/cascade.html#at-import">@import rule</a>.</p>
<p>Let us have a look at the following example. In this fragment (not the best practice, only for illustration purposes), we see a script element and a stylesheet:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="html" style="font-family:monospace;">&lt;p&gt;The quick brown fox jumps over the lazy dog.&lt;/p&gt;
&lt;script&gt;setTimeout(function() { document.title = document.title }, 1000);&lt;/script&gt;
&lt;p&gt;The quick brown fox jumps over the lazy dog.&lt;/p&gt;
&lt;style&gt;
@import url(&quot;another-style.css&quot;);
body { background-color: white }
&lt;/style&gt;</pre></td></tr></table></div>

<p>Due to the <code>script</code> element, WebKit parser will invoke the preload scanner, both HTML and CSS flavors. The preload scanner quickly realizes that there is this particular URL within <code>@import</code>. It then schedules the process of fetching <code>another-style.css</code> (the actual request will be tackled by the network stack).</p>
<p>Because CSS preload scanner is pretty simple (it does not need to understand the full CSS grammar), it does the job pretty well. In fact, there was an optimization so that it <a href="http://trac.webkit.org/changeset/82916">bails out</a> quickly if <code>@import</code> is not found early in the stylesheet. This is important so that the CPU cycles are not wasted on large CSS files.</p>
<p>The use of <code>@import</code> is often discouraged (see Steve Souder&#8217;s <a href="http://www.stevesouders.com/blog/2009/04/09/dont-use-import/">don&#8217;t use @import</a>). With the current and future improvements inside the browser engine, such a best practice needs to be evaluated again from time to time. Of course, I wouldn&#8217;t recommend sprinkling <code>@import</code> everywhere on your web sites. Use the tools available to you (e.g. Web Inspector) to <a href="http://www.igvita.com/2013/01/15/faster-websites-crash-course-on-web-performance/">analyze the network performance</a> and then you will be in the position to make an informed decision.</p>
<p>Like in <em>Hamlet</em>, &#8220;To import, or not to import&#8221;.</p>
<p><strong>Note</strong>: Special thanks to <a href="http://www.igvita.com/">Ilya Grigorik</a> for reviewing the draft of this blog post.</p>
							
												
						</section> <!-- end article section -->
						
						<footer>
			
														
						</footer> <!-- end article footer -->
					
					</article> <!-- end article -->
					
					
<div id="disqus_thread">
                    <div id="dsq-content">


            <ul id="dsq-comments">
                    <li class="comment even thread-even depth-1" id="dsq-comment-4031">
        <div id="dsq-comment-header-4031" class="dsq-comment-header">
            <cite id="dsq-cite-4031">
                <span id="dsq-author-user-4031">Steve Souders</span>
            </cite>
        </div>
        <div id="dsq-comment-body-4031" class="dsq-comment-body">
            <div id="dsq-comment-message-4031" class="dsq-comment-message"><p>Hi, Ariya. Your example uses an inline style block, whereas my warning focuses on the extra roundtrip delay from using @import in an external stylesheet. Does the CSS preload scanner address that situation, perhaps by doing streaming parsing of external stylesheets? </p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-4032">
        <div id="dsq-comment-header-4032" class="dsq-comment-header">
            <cite id="dsq-cite-4032">
http://ariya.ofilabs.com/                <span id="dsq-author-user-4032">Ariya Hidayat</span>
            </cite>
        </div>
        <div id="dsq-comment-body-4032" class="dsq-comment-body">
            <div id="dsq-comment-message-4032" class="dsq-comment-message"><p>Hi, Steve.</p>
<p>Right now CSS Preload Scanner only understands inline style and it does not scan any external stylesheets. Tony Gentilcore&#8217;s blog post (which I linked above) also alluded the external stylesheets scanning as a possible area of improvement. I think it would be wonderful to have it, I can&#8217;t w