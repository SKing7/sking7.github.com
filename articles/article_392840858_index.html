<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <title></title>
  </head>
  <body>
        <!-- MAIN CONTENT -->
        <div id="main_content_wrap" class="outer">
        <textarea style="visibility:none" id="html-area">
<!DOCTYPE html&gt;<html&gt;<head&gt;<title&gt;使用ImageMagick为你的网站减重（2） - Hooopo</title&gt;<meta content="width=device-width, initial-scale=1.0" name="viewport" /&gt;<link href="https://secure.gravatar.com/avatar/e9ed4664dfd7ea664ccc5813de4d1fd7.png?r=PG&amp;s=100" rel="shortcut icon" /&gt;<link href="/feed.rss" rel="alternate" type="application/rss+xml" /&gt;<script data-turbolinks-track="true" src="/assets/site-d7abba4e505acb964a3ba782eefdccc3.js"&gt;</script&gt;<link data-turbolinks-track="true" href="/assets/site-75b3803e592cb3afbf80590c2d3d548a.css" media="screen" rel="stylesheet" /&gt;<meta content="authenticity_token" name="csrf-param" /&gt;
<meta content="L5FfhXKhqtDcEa3nf7QDA1Vje+pYQ1+Me0Wde6xUcno=" name="csrf-token" /&gt;<meta content="UA-43027624-1" name="google-analytics" /&gt;</head&gt;<body id="articles-show"&gt;<header class="clearfix" id="topbar"&gt;<a class="topbar-button pull-left" href="/"&gt;<i class="icon-chevron-left"&gt;</i&gt;首页</a&gt;<div class="dropdown pull-right"&gt;<a class="topbar-button dropdown-toggle no-arrow"&gt;<i class="icon-share-alt"&gt;</i&gt;</a&gt;<ul class="dropdown-menu align-right"&gt;<li&gt;<a href="https://twitter.com/share?url=http://hooopo.writings.io/articles/5-generate-progressive-jpeg-with-carrierwave-and-mini-magick&text=使用ImageMagick为你的网站减重（2）" target="_blank"&gt;<i class="icon-twitter"&gt;</i&gt; Twitter</a&gt;</li&gt;<li&gt;<a href="http://service.weibo.com/share/share.php?url=http://hooopo.writings.io/articles/5-generate-progressive-jpeg-with-carrierwave-and-mini-magick&title=使用ImageMagick为你的网站减重（2）" target="_blank"&gt;<i class="icon-weibo"&gt;</i&gt; <span class="translation_missing" title="translation missing: zh-CN.site.articles.show.weibo"&gt;Weibo</span&gt;</a&gt;</li&gt;<li&gt;<a href="https://plus.google.com/share?url=http://hooopo.writings.io/articles/5-generate-progressive-jpeg-with-carrierwave-and-mini-magick" target="_blank"&gt;<i class="icon-google-plus"&gt;</i&gt; Google+</a&gt;</li&gt;<li&gt;<a href="https://www.facebook.com/sharer/sharer.php?u=http://hooopo.writings.io/articles/5-generate-progressive-jpeg-with-carrierwave-and-mini-magick" target="_blank"&gt;<i class="icon-facebook"&gt;</i&gt; Facebook</a&gt;</li&gt;</ul&gt;</div&gt;</header&gt;<section id="article"&gt;<div class="container"&gt;<div class="inner"&gt;<article&gt;<h1&gt;使用ImageMagick为你的网站减重（2）</h1&gt;<p&gt;以前写过一篇博客《<a href="http://hooopo.iteye.com/blog/620498"&gt;使用ImageMagick为你的网站减重</a&gt;》，涉及到的手段是：</p&gt;<ol&gt;<li&gt;在服务器端把图片缩放到合适的尺寸，避免在前端用css缩放图片。</li&gt;<li&gt;用imagemagick的strip功能移出图片里的EXIF等多余信息。</li&gt;<li&gt;压缩JPEG图片的质量，减少图片体积。</li&gt;</ol&gt;<h2&gt;Lossless Compress With <a href="https://github.com/toy/image_optim"&gt;image_optim</a&gt;</h2&gt;<p&gt;上面的手段都是针对用户上传的JPEG图片。对于网站自身的banner或logo等图片也可以通过各种工具进行无损压缩来减少图片体积。</p&gt;<p&gt;<a href="https://github.com/toy/image_optim"&gt;image_optim</a&gt;&nbsp;是一个Ruby的gem，可以组合调用<b&gt;&nbsp;</b&gt;<b&gt;<a href="http://advancemame.sourceforge.net/doc-advpng.html"&gt;advpng</a&gt;&nbsp;</b&gt;<a href="http://www.lcdf.org/gifsicle/"&gt;<b&gt;gifsicle</b&gt;</a&gt;<b&gt;&nbsp;</b&gt;<b&gt;jpegoptim jpegtran</b&gt;<b&gt;&nbsp;</b&gt;<a href="http://optipng.sourceforge.net/"&gt;<b&gt;optipng</b&gt;</a&gt;<b&gt;&nbsp;</b&gt;<a href="http://pmt.sourceforge.net/pngcrush/"&gt;<b&gt;pngcrush</b&gt;</a&gt;<b&gt;&nbsp;</b&gt;<b&gt;<a href="http://www.advsys.net/ken/util/pngout.htm"&gt;pngout</a&gt;&nbsp;</b&gt;等图片优化工具。使用方法非常简单，并且可以看到每个图片优化的大小：</p&gt;<pre&gt;<code&gt;image_optim app/assets/images/*.{jpg,png,gif}
</code&gt;</pre&gt;







<h3&gt;Baseline vs. progressive JPEGs</h3&gt;<ol&gt;<li&gt;浏览器在渲染普通的Baseline类型JPEG是从上到下的。<img src="https://writingsio.s3.amazonaws.com/attachments/51d96c4e4017a4b25f00006c/cdcec6ed0d280d476753032f03c5fa76/6a0120a85dcdae970b0128776fcab6970c.gif"&gt;</li&gt;<li&gt;而在渲染Progressive类型JPEG是渐进式的，在整个图片还没有加载完，就可以显示整个轮廓，逐渐变清晰，直到最后整张图片渲染完成。<img src="https://writingsio.s3.amazonaws.com/attachments/51d96c754017a4b25f00006d/6dde4e35df0f1bfb19d68c69e050042e/6a0120a85dcdae970b0128776fcadb970c.gif"&gt;</li&gt;</ol&gt;<h2&gt;使用Imagemagick转换Baseline JPEG为Progressive JPEG</h2&gt;<p&gt;从上面的两张gif图片演示的效果可以看出，Progressive JPEG渲染的更快，体验更好(个人认为瀑布流网站使用Baseline方式渲染体验更好，因为看起来更像瀑布......)。但是，Baseline JPEG是默认的方式，如果需要Progressive只能强制转换。</p&gt;<pre&gt;<code&gt;convert -interlace plane baseline.jpg progressive.jpg #转换成Progressive JPEG
exiftool progressive.jpg |grep Encoding # 检测转换的结果,如果为Progressive DCT, Huffman coding就说明转换成功。
</code&gt;</pre&gt;<p&gt;carrierwave mini_magick processor:</p&gt;<pre&gt;<code&gt;def optimize
  manipulate! do |img|
&nbsp; &nbsp; img.strip
&nbsp; &nbsp; img.combine_options do |c|
&nbsp; &nbsp; &nbsp; c.quality "80"
&nbsp; &nbsp; &nbsp; # Use Progressive DCT Instead of Baseline DCT.
&nbsp; &nbsp; &nbsp; c.interlace "plane"
&nbsp; &nbsp; &nbsp; c.colorspace "rgb" #据说cmyk在IE下有问题，没试过..
&nbsp; &nbsp; end
&nbsp; &nbsp; img
end
</code&gt;</pre&gt;<h2&gt;How to Detect Progressive JPEG</h2&gt;<p&gt;有一种说法是用file或identify命令获取到图片的类型为JFIF即是Progressive JPEG，但是经过多次试验，这个结论不靠谱，最靠谱的是上面使用的exiftool。</p&gt;<h3&gt;相关链接</h3&gt;<ol&gt;<li&gt;http://www.codinghorror.com/blog/2005/12/progressive-image-rendering.html<br&gt;</li&gt;<li&gt;http://www.zhangxinxu.com/wordpress/2013/01/progressive-jpeg-image-and-so-on/<br&gt;</li&gt;<li&gt;http://www.yuiblog.com/blog/2008/12/05/imageopt-4/<br&gt;</li&gt;<li&gt;http://hooopo.iteye.com/blog/620498<br&gt;</li&gt;<li&gt;http://imageoptim.com/<br&gt;</li&gt;</ol&gt;</article&gt;</div&gt;</div&gt;</section&gt;<section id="date"&gt;<div class="container"&gt;<div class="inner"&gt;2013-07-07</div&gt;</div&gt;</section&gt;<section id="profile"&gt;<div class="container"&gt;<div class="inner"&gt;<div class="profile"&gt;<div class="avatar"&gt;<a href="/authors/hooopo"&gt;<img alt="E9ed4664dfd7ea664ccc5813de4d1fd7" src="https://secure.gravatar.com/avatar/e9ed4664dfd7ea664ccc5813de4d1fd7.png?r=PG&amp;s=120" /&gt;</a&gt;</div&gt;<div class="info"&gt;<h1&gt;<a href="/authors/hooopo"&gt;Hooopo</a&gt;</h1&gt;<div class="description"&gt;<p&gt;Hooopo means Hope.</p&gt;</div&gt;</div&gt;</div&gt;</div&gt;</div&gt;</section&gt;<div id="comments"&gt;<div class="container"&gt;<div class="inner"&gt;<div id="disqus_thread"&gt;</div&gt;<script type="text/javascript"&gt;var disqus_shortname = 'hooopo';
var disqus_identifier = '5';
var disqus_url = 'http://hooopo.writings.io/articles/5-generate-progressive-jpeg-with-carrierwave-and-mini-magick';

(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script&gt;</div&gt;</div&gt;</div&gt;<footer id="footer"&gt;<div class="logo"&gt;<a href="https://writings.io"&gt;Writings</a&gt;</div&gt;</footer&gt;</body&gt;</html&gt;
        </textarea>
        </div>
        <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
        <script src="../js/clearly.js"></script>
        <script>
            var html = window.__getMyClearlyResults().html;
            $('#main_content_wrap').html(html);
        </script>
  </body>
</html>
