<!DOCTYPE html><html><head><title>使用ImageMagick为你的网站减重（2） - Hooopo</title><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="https://secure.gravatar.com/avatar/e9ed4664dfd7ea664ccc5813de4d1fd7.png?r=PG&amp;s=100" rel="shortcut icon" /><link href="/feed.rss" rel="alternate" type="application/rss+xml" /><script data-turbolinks-track="true" src="/assets/site-d7abba4e505acb964a3ba782eefdccc3.js"></script><link data-turbolinks-track="true" href="/assets/site-75b3803e592cb3afbf80590c2d3d548a.css" media="screen" rel="stylesheet" /><meta content="authenticity_token" name="csrf-param" />
<meta content="ytPNjhJTQaMw5BlMNRMlRUkDC6xVvajV4D3SIMmB20Y=" name="csrf-token" /><meta content="UA-43027624-1" name="google-analytics" /></head><body id="articles-show"><header class="clearfix" id="topbar"><a class="topbar-button pull-left" href="/"><i class="icon-chevron-left"></i>首页</a><div class="dropdown pull-right"><a class="topbar-button dropdown-toggle no-arrow"><i class="icon-share-alt"></i></a><ul class="dropdown-menu align-right"><li><a href="https://twitter.com/share?url=http://hooopo.writings.io/articles/5-generate-progressive-jpeg-with-carrierwave-and-mini-magick&text=使用ImageMagick为你的网站减重（2）" target="_blank"><i class="icon-twitter"></i> Twitter</a></li><li><a href="http://service.weibo.com/share/share.php?url=http://hooopo.writings.io/articles/5-generate-progressive-jpeg-with-carrierwave-and-mini-magick&title=使用ImageMagick为你的网站减重（2）" target="_blank"><i class="icon-weibo"></i> <span class="translation_missing" title="translation missing: zh-CN.site.articles.show.weibo">Weibo</span></a></li><li><a href="https://plus.google.com/share?url=http://hooopo.writings.io/articles/5-generate-progressive-jpeg-with-carrierwave-and-mini-magick" target="_blank"><i class="icon-google-plus"></i> Google+</a></li><li><a href="https://www.facebook.com/sharer/sharer.php?u=http://hooopo.writings.io/articles/5-generate-progressive-jpeg-with-carrierwave-and-mini-magick" target="_blank"><i class="icon-facebook"></i> Facebook</a></li></ul></div></header><section id="article"><div class="container"><div class="inner"><article><h1>使用ImageMagick为你的网站减重（2）</h1><p>以前写过一篇博客《<a href="http://hooopo.iteye.com/blog/620498">使用ImageMagick为你的网站减重</a>》，涉及到的手段是：</p><ol><li>在服务器端把图片缩放到合适的尺寸，避免在前端用css缩放图片。</li><li>用imagemagick的strip功能移出图片里的EXIF等多余信息。</li><li>压缩JPEG图片的质量，减少图片体积。</li></ol><h2>Lossless Compress With <a href="https://github.com/toy/image_optim">image_optim</a></h2><p>上面的手段都是针对用户上传的JPEG图片。对于网站自身的banner或logo等图片也可以通过各种工具进行无损压缩来减少图片体积。</p><p><a href="https://github.com/toy/image_optim">image_optim</a>&nbsp;是一个Ruby的gem，可以组合调用<b>&nbsp;</b><b><a href="http://advancemame.sourceforge.net/doc-advpng.html">advpng</a>&nbsp;</b><a href="http://www.lcdf.org/gifsicle/"><b>gifsicle</b></a><b>&nbsp;</b><b>jpegoptim jpegtran</b><b>&nbsp;</b><a href="http://optipng.sourceforge.net/"><b>optipng</b></a><b>&nbsp;</b><a href="http://pmt.sourceforge.net/pngcrush/"><b>pngcrush</b></a><b>&nbsp;</b><b><a href="http://www.advsys.net/ken/util/pngout.htm">pngout</a>&nbsp;</b>等图片优化工具。使用方法非常简单，并且可以看到每个图片优化的大小：</p><pre><code>image_optim app/assets/images/*.{jpg,png,gif}
</code></pre>







<h3>Baseline vs. progressive JPEGs</h3><ol><li>浏览器在渲染普通的Baseline类型JPEG是从上到下的。<img src="https://writingsio.s3.amazonaws.com/attachments/51d96c4e4017a4b25f00006c/cdcec6ed0d280d476753032f03c5fa76/6a0120a85dcdae970b0128776fcab6970c.gif"></li><li>而在渲染Progressive类型JPEG是渐进式的，在整个图片还没有加载完，就可以显示整个轮廓，逐渐变清晰，直到最后整张图片渲染完成。<img src="https://writingsio.s3.amazonaws.com/attachments/51d96c754017a4b25f00006d/6dde4e35df0f1bfb19d68c69e050042e/6a0120a85dcdae970b0128776fcadb970c.gif"></li></ol><h2>使用Imagemagick转换Baseline JPEG为Progressive JPEG</h2><p>从上面的两张gif图片演示的效果可以看出，Progressive JPEG渲染的更快，体验更好(个人认为瀑布流网站使用Baseline方式渲染体验更好，因为看起来更像瀑布......)。但是，Baseline JPEG是默认的方式，如果需要Progressive只能强制转换。</p><pre><code>convert -interlace plane baseline.jpg progressive.jpg #转换成Progressive JPEG
exiftool progressive.jpg |grep Encoding # 检测转换的结果,如果为Progressive DCT, Huffman coding就说明转换成功。
</code></pre><p>carrierwave mini_magick processor:</p><pre><code>def optimize
  manipulate! do |img|
&nbsp; &nbsp; img.strip
&nbsp; &nbsp; img.combine_options do |c|
&nbsp; &nbsp; &nbsp; c.quality "80"
&nbsp; &nbsp; &nbsp; # Use Progressive DCT Instead of Baseline DCT.
&nbsp; &nbsp; &nbsp; c.interlace "plane"
&nbsp; &nbsp; &nbsp; c.colorspace "rgb" #据说cmyk在IE下有问题，没试过..
&nbsp; &nbsp; end
&nbsp; &nbsp; img
end
</code></pre><h2>How to Detect Progressive JPEG</h2><p>有一种说法是用file或identify命令获取到图片的类型为JFIF即是Progressive JPEG，但是经过多次试验，这个结论不靠谱，最靠谱的是上面使用的exiftool。</p><h3>相关链接</h3><ol><li>http://www.codinghorror.com/blog/2005/12/progressive-image-rendering.html<br></li><li>http://www.zhangxinxu.com/wordpress/2013/01/progressive-jpeg-image-and-so-on/<br></li><li>http://www.yuiblog.com/blog/2008/12/05/imageopt-4/<br></li><li>http://hooopo.iteye.com/blog/620498<br></li><li>http://imageoptim.com/<br></li></ol></article></div></div></section><section id="date"><div class="container"><div class="inner">2013-07-07</div></div></section><section id="profile"><div class="container"><div class="inner"><div class="profile"><div class="avatar"><a href="/authors/hooopo"><img alt="E9ed4664dfd7ea664ccc5813de4d1fd7" src="https://secure.gravatar.com/avatar/e9ed4664dfd7ea664ccc5813de4d1fd7.png?r=PG&amp;s=120" /></a></div><div class="info"><h1><a href="/authors/hooopo">Hooopo</a></h1><div class="description"><p>Hooopo means Hope.</p></div></div></div></div></div></section><div id="comments"><div class="container"><div class="inner"><div id="disqus_thread"></div><script type="text/javascript">var disqus_shortname = 'hooopo';
var disqus_identifier = '5';
var disqus_url = 'http://hooopo.writings.io/articles/5-generate-progressive-jpeg-with-carrierwave-and-mini-magick';

(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script></div></div></div><footer id="footer"><div class="logo"><a href="https://writings.io">Writings</a></div></footer></body></html>