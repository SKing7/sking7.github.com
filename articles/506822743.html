<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>A really simple Javascript router</title>
<link rel="stylesheet" href="../css/article.css" />
</head>
<body>
<div class="m-content">
<h1>A really simple Javascript router</h1>
<div><p><span>&lt;!DOCTYPE html&gt;</span></p><p><span>&lt;html&gt;</span></p><p><span>&lt;head&gt;</span></p><p>  <span>&lt;meta</span> <span>charset=</span><span>"utf-8"</span><span>&gt;</span></p><p>  <span>&lt;title&gt;</span>Building a router<span>&lt;/title&gt;</span></p><p>  <span>&lt;script&gt;</span></p><p>    <span>// Put John's template engine code here...</span></p><p>    <span>(</span><span>function</span> <span>()</span> <span>{</span></p><p>      <span>// A hash to store our routes:</span></p><p>      <span>var</span> <span>routes</span> <span>=</span> <span>{};</span></p><p>      <span>// The route registering function:</span></p><p>      <span>function</span> <span>route</span> <span>(</span><span>path</span><span>,</span> <span>templateId</span><span>,</span> <span>controller</span><span>)</span> <span>{</span></p><p>        <span>// Allow route(path, controller) for template less routes:</span></p><p>        <span>if</span> <span>(</span><span>typeof</span> <span>templateId</span> <span>===</span> <span>'function'</span><span>)</span> <span>{</span></p><p>          <span>controller</span> <span>=</span> <span>templateId</span><span>;</span></p><p>          <span>templateId</span> <span>=</span> <span>null</span><span>;</span></p><p>        <span>}</span></p><p>        <span>routes</span><span>[</span><span>path</span><span>]</span> <span>=</span> <span>{</span><span>templateId</span><span>:</span> <span>templateId</span><span>,</span> <span>controller</span><span>:</span> <span>controller</span><span>};</span></p><p>      <span>}</span></p><p>      <span>var</span> <span>el</span> <span>=</span> <span>null</span><span>,</span> <span>current</span> <span>=</span> <span>null</span><span>;</span></p><p>      <span>function</span> <span>router</span> <span>()</span> <span>{</span></p><p>        <span>// Current route url (getting rid of '#' in hash as well):</span></p><p>        <span>var</span> <span>url</span> <span>=</span> <span>location</span><span>.</span><span>hash</span><span>.</span><span>slice</span><span>(</span><span>1</span><span>)</span> <span>||</span> <span>'/'</span><span>;</span></p><p>        <span>// Get route by url:</span></p><p>        <span>var</span> <span>route</span> <span>=</span> <span>routes</span><span>[</span><span>url</span><span>];</span></p><p>        <span>// Is it a route without template?</span></p><p>        <span>if</span> <span>(</span><span>route</span> <span>&amp;&amp;</span> <span>!</span><span>route</span><span>.</span><span>templateId</span><span>)</span> <span>{</span></p><p>          <span>// Just initiate controller:</span></p><p>          <span>return</span> <span>route</span><span>.</span><span>controller</span> <span>?</span> <span>new</span> <span>route</span><span>.</span><span>controller</span> <span>:</span> <span>null</span><span>;</span></p><p>        <span>}</span></p><p>        <span>// Lazy load view element:</span></p><p>        <span>el</span> <span>=</span> <span>el</span> <span>||</span> <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>'view'</span><span>);</span></p><p>        <span>// Clear existing observer:</span></p><p>        <span>if</span> <span>(</span><span>current</span><span>)</span> <span>{</span></p><p>          <span>Object</span><span>.</span><span>unobserve</span><span>(</span><span>current</span><span>.</span><span>controller</span><span>,</span> <span>current</span><span>.</span><span>render</span><span>);</span></p><p>          <span>current</span> <span>=</span> <span>null</span><span>;</span></p><p>        <span>}</span></p><p>        <span>// Do we have both a view and a route?</span></p><p>        <span>if</span> <span>(</span><span>el</span> <span>&amp;&amp;</span> <span>route</span> <span>&amp;&amp;</span> <span>route</span><span>.</span><span>controller</span><span>)</span> <span>{</span></p><p>          <span>// Set current route information:</span></p><p>          <span>current</span> <span>=</span> <span>{</span></p><p>            <span>controller</span><span>:</span> <span>new</span> <span>route</span><span>.</span><span>controller</span><span>,</span></p><p>            <span>template</span><span>:</span> <span>tmpl</span><span>(</span><span>route</span><span>.</span><span>templateId</span><span>),</span></p><p>            <span>render</span><span>:</span> <span>function</span> <span>()</span> <span>{</span></p><p>              <span>// Render route template with John Resig's template engine:</span></p><p>              <span>el</span><span>.</span><span>innerHTML</span> <span>=</span> <span>this</span><span>.</span><span>template</span><span>(</span><span>this</span><span>.</span><span>controller</span><span>);</span></p><p>            <span>}</span></p><p>          <span>};</span></p><p>          <span>// Render directly:</span></p><p>          <span>current</span><span>.</span><span>render</span><span>();</span></p><p>          <span>// And observe for changes:</span></p><p>          <span>Object</span><span>.</span><span>observe</span><span>(</span><span>current</span><span>.</span><span>controller</span><span>,</span> <span>current</span><span>.</span><span>render</span><span>.</span><span>bind</span><span>(</span><span>current</span><span>));</span></p><p>        <span>}</span></p><p>      <span>}</span></p><p>      <span>// Listen on hash change:</span></p><p>      <span>this</span><span>.</span><span>addEventListener</span><span>(</span><span>'hashchange'</span><span>,</span> <span>router</span><span>);</span></p><p>      <span>// Listen on page load:</span></p><p>      <span>this</span><span>.</span><span>addEventListener</span><span>(</span><span>'load'</span><span>,</span> <span>router</span><span>);</span></p><p>      <span>// Expose the route register function:</span></p><p>      <span>this</span><span>.</span><span>route</span> <span>=</span> <span>route</span><span>;</span></p><p>    <span>})();</span></p><p>  <span>&lt;/script&gt;</span></p><p>  <span>&lt;script </span><span>type=</span><span>"text/html"</span> <span>id=</span><span>"home"</span><span>&gt;</span></p><p>    <span>&lt;</span><span>h1</span><span>&gt;</span><span>Router</span> <span>FTW</span><span>!&lt;</span><span>/h1&gt;</span></p><p>  <span>&lt;/script&gt;</span></p><p>  <span>&lt;script </span><span>type=</span><span>"text/html"</span> <span>id=</span><span>"template1"</span><span>&gt;</span></p><p>    <span>&lt;</span><span>h1</span><span>&gt;</span><span>Page</span> <span>1</span><span>:</span> <span>&lt;%=</span> <span>greeting</span> <span>%&gt;&lt;</span><span>/h1&gt;</span></p><p>    <span>&lt;</span><span>p</span><span>&gt;&lt;%=</span> <span>moreText</span> <span>%&gt;&lt;</span><span>/p&gt;</span></p><p>  <span>&lt;/script&gt;</span></p><p>  <span>&lt;script </span><span>type=</span><span>"text/html"</span> <span>id=</span><span>"template2"</span><span>&gt;</span></p><p>    <span>&lt;</span><span>h1</span><span>&gt;</span><span>Page</span> <span>2</span><span>:</span> <span>&lt;%=</span> <span>heading</span> <span>%&gt;&lt;</span><span>/h1&gt;</span></p><p>    <span>&lt;</span><span>p</span><span>&gt;</span><span>Lorem</span> <span>ipsum</span><span>...</span><span>&lt;</span><span>/p&gt;</span></p><p>  <span>&lt;/script&gt;</span></p><p><span>&lt;/head&gt;</span></p><p><span>&lt;body&gt;</span></p><p>  <span>&lt;ul&gt;</span></p><p>    <span>&lt;li&gt;&lt;a</span> <span>href=</span><span>"#"</span><span>&gt;</span>Home<span>&lt;/a&gt;&lt;/li&gt;</span></p><p>    <span>&lt;li&gt;&lt;a</span> <span>href=</span><span>"#/page1"</span><span>&gt;</span>Page 1<span>&lt;/a&gt;&lt;/li&gt;</span></p><p>    <span>&lt;li&gt;&lt;a</span> <span>href=</span><span>"#/page2"</span><span>&gt;</span>Page 2<span>&lt;/a&gt;&lt;/li&gt;</span></p><p>  <span>&lt;/ul&gt;</span></p><p>  <span>&lt;div</span> <span>id=</span><span>"view"</span><span>&gt;&lt;/div&gt;</span></p><p>  <span>&lt;script&gt;</span></p><p>    <span>route</span><span>(</span><span>'/'</span><span>,</span> <span>'home'</span><span>,</span> <span>function</span> <span>()</span> <span>{});</span></p><p>    <span>route</span><span>(</span><span>'/page1'</span><span>,</span> <span>'template1'</span><span>,</span> <span>function</span> <span>()</span> <span>{</span></p><p>      <span>this</span><span>.</span><span>greeting</span> <span>=</span> <span>'Hello world!'</span><span>;</span></p><p>      <span>this</span><span>.</span><span>moreText</span> <span>=</span> <span>'Loading...'</span><span>;</span></p><p>      <span>// Simulating an Ajax call which take 0.5 s</span></p><p>      <span>setTimeout</span><span>(</span><span>function</span> <span>()</span> <span>{</span></p><p>        <span>this</span><span>.</span><span>moreText</span> <span>=</span> <span>'Bacon ipsum...'</span><span>;</span></p><p>      <span>}.</span><span>bind</span><span>(</span><span>this</span><span>),</span> <span>500</span><span>);</span></p><p>    <span>});</span></p><p>    <span>route</span><span>(</span><span>'/page2'</span><span>,</span> <span>'template2'</span><span>,</span> <span>function</span> <span>()</span> <span>{</span></p><p>      <span>this</span><span>.</span><span>heading</span> <span>=</span> <span>'I\'m page two!'</span><span>;</span></p><p>    <span>});</span></p><p>  <span>&lt;/script&gt;</span></p><p><span>&lt;/body&gt;</span></p><p><span>&lt;/html&gt;</span></p></div></div>
<script>var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-34802167-1']); _gaq.push(['_setDomainName', 'liuzhe.co']); _gaq.push(['_trackPageview']); (function() { var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true; ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js'; var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s); })();</script></body>
</html>