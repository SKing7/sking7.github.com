<html><!--<![endif]-->
	
	<head>
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		
		<title>
			  Lazy Parsing in JavaScript Engines 
		</title>
				
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		
		<!-- icons & favicons -->
		<!-- For iPhone 4 -->
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/images/icons/h/apple-touch-icon.png" />
		<!-- For iPad 1-->
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/images/icons/m/apple-touch-icon.png" />
		<!-- For iPhone 3G, iPod Touch and Android -->
		<link rel="apple-touch-icon-precomposed" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/images/icons/l/apple-touch-icon-precomposed.png" />
		<!-- For Nokia -->
		<link rel="shortcut icon" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/images/icons/l/apple-touch-icon.png" />
		<!-- For everything else -->
		<!-- <link rel="shortcut icon" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/favicon.ico"> -->
				
		<!-- media-queries.js (fallback) -->
		<!--[if lt IE 9]>
			<script src="http://css3-mediaqueries-js.googlecode.com/svn/trunk/css3-mediaqueries.js"></script>			
		<![endif]-->

		<!-- html5.js -->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->
		
  		<link rel="pingback" href="http://ariya.ofilabs.com/xmlrpc.php" />

  		<link rel="stylesheet/less" type="text/css" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/less/bootstrap.less" />
  		<link rel="stylesheet/less" type="text/css" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/less/responsive.less" />

		<!-- wordpress head functions -->
		<link rel="stylesheet" id="wp-syntax-css-css" href="http://ariya.ofilabs.com/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0" type="text/css" media="all" />
<link rel="stylesheet" id="jetpack-widgets-css" href="http://ariya.ofilabs.com/wp-content/plugins/jetpack/modules/widgets/widgets.css?ver=20121003" type="text/css" media="all" />
<link rel="stylesheet" id="bootstrap-css" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/css/bootstrap.css?ver=1.0" type="text/css" media="all" />
<link rel="stylesheet" id="bootstrap-responsive-css" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/css/responsive.css?ver=1.0" type="text/css" media="all" />
<link rel="stylesheet" id="wp-bootstrap-css" href="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/style.css?ver=1.0" type="text/css" media="all" />
<link rel="stylesheet" id="sharedaddy-css" href="http://ariya.ofilabs.com/wp-content/plugins/jetpack/modules/sharedaddy/sharing.css?ver=2.5" type="text/css" media="all" />
<script type="text/javascript" src="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/js/libs/jquery-1.7.1.min.js?ver=1.7.1"></script>
<script type="text/javascript" src="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/js/bootstrap.min.js?ver=3.6.1"></script>
<script type="text/javascript" src="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/js/scripts.js?ver=3.6.1"></script>
<script type="text/javascript" src="http://ariya.ofilabs.com/wp-content/themes/wordpress-bootstrap/library/js/modernizr.full.min.js?ver=3.6.1"></script>
<script type="text/javascript" src="http://ariya.ofilabs.com/wp-includes/js/comment-reply.min.js?ver=3.6.1"></script>
<link rel="canonical" href="http://ariya.ofilabs.com/2012/07/lazy-parsing-in-javascript-engines.html" />
<link rel="shortlink" href="http://wp.me/p2lzjD-dz" />
<link rel="stylesheet" type="text/css" href="http://ariya.ofilabs.com/wp-content/plugins/microkids-related-posts/microkids-related-posts-default.css" />
<!-- Simple Google Analytics Begin -->
<script type="text/javascript">
var _gaq = [['_setAccount','UA-24809129-1'],['_setDomainName','ariya.ofilabs.com'],['_trackPageLoadTime'],['_trackPageview']];(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
<!-- Simple Google Analytics End -->

<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="article" />
<meta property="og:title" content="Lazy Parsing in JavaScript Engines" />
<meta property="og:url" content="http://ariya.ofilabs.com/2012/07/lazy-parsing-in-javascript-engines.html" />
<meta property="og:description" content="Modern JavaScript engines can defer the parsing process of a function body until it is completely needed. Why is this done and how does this work? The last blog post titled Advances in JavaScript P..." />
<meta property="og:site_name" content="don't code today what you can't debug tomorrow" />
<meta name="twitter:site" content="@jetpack" />
<meta name="twitter:card" content="summary" />
		<link rel="stylesheet" id="custom-css-css" type="text/css" href="http://ariya.ofilabs.com/?custom-css=1&amp;csblog=1&amp;cscache=6&amp;csrev=31" />
				<!-- end of wordpress head -->

		<!-- theme options from options panel -->
		<style>
        h1, h2, h3, h4, h5, h6{ 
          font-family: "Helvetica Neue",Helvetica,Arial,sans-serif; 
          font-weight: bold; 
          color: #404040; 
        }
        body{ 
          font-family: "Helvetica Neue",Helvetica,Arial,sans-serif; 
          font-weight: normal; 
          color: #404040; 
        }
        .navbar-inner, .navbar .fill { 
          background-color: #222222;
        }#222222
        .navbar-inner, .navbar .fill {
          background-image: -khtml-gradient(linear, left top, left bottom, from(#222222), to(#333333));
          background-image: -moz-linear-gradient(top, #222222, #333333);
          background-image: -ms-linear-gradient(top, #222222, #333333);
          background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #222222), color-stop(100%, #333333));
          background-image: -webkit-linear-gradient(top, #222222, #3333332);
          background-image: -o-linear-gradient(top, #222222, #333333);
          background-image: linear-gradient(top, #222222, #333333);
          filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#222222', endColorstr='#3333332', GradientType=0);
        }
        .navbar .nav li a { 
          color: #BFBFBF;
        }
        .navbar .nav li a:hover { 
          color: #FFFFFF;
        }
          .dropdown-menu li > a:hover, .dropdown-menu .active > a, .dropdown-menu .active > a:hover {
            background-color: #0088CC;
          }
        
          .dropdown-menu a{
            color: #555555 !important;
          }
        
        .hero-unit { 
          background-color: #F5F5F5;
        }
        #main article {
          border-bottom: none;
        }h1.h2 {
letter-spacing: -1px;
font-weight: normal;
}

div.postauthor &gt; div {
padding-right: 25px;
}

blockquote p {
font-size: 13px;
}

h1.singletitle {
letter-spacing: -1px;
font-weight: normal;
}

pre {
border: none;
padding: 2px;
background-color: transparent;
}

code {
color: black;
}

.related-posts {
margin-top: 20px;
}
        </style>
						
	</head>
	
	<body class="single single-post postid-841 single-format-standard">
				
		<header role="banner">
		
			<div id="inner-header" class="clearfix">
				
				<div class="navbar navbar-fixed-top">
					<div class="navbar-inner">
						<div class="container-fluid nav-container">
							<nav role="navigation">
								<a class="brand" id="logo" title="" href="http://ariya.ofilabs.com">don't code today what you can't debug tomorrow</a>
								
								<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
							        <span class="icon-bar"></span>
							        <span class="icon-bar"></span>
							        <span class="icon-bar"></span>
								</a>
								
								<div class="nav-collapse">
									<ul id="menu-nav" class="nav"><li id="menu-item-970" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://ariya.ofilabs.com/about">About</a></li>
<li id="menu-item-1025" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://ariya.ofilabs.com/highlights">Highlights</a></li>
<li id="menu-item-972" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://ariya.ofilabs.com/projects">Projects</a></li>
<li id="menu-item-971" class="menu-item menu-item-type-post_type menu-item-object-page"><a href="http://ariya.ofilabs.com/talks">Talks</a></li>
</ul>								</div>
								
							</nav>
							
														
						</div>
					</div>
				</div>
			
			</div> <!-- end #inner-header -->
		
		</header> <!-- end header -->
		
		<div class="container-fluid">			
			<div id="content" class="clearfix row-fluid">
			
				<div id="main" class="span8 clearfix" role="main">

										
					<article id="post-841" class="post-841 post type-post status-publish format-standard hentry category-uncategorized tag-javascript tag-javascriptcore tag-optimization tag-spidermonkey tag-v8 clearfix" role="article" itemscope="" itemtype="http://schema.org/BlogPosting">
						
						<header>
						
														
							<div class="page-header"><h1 class="single-title" itemprop="headline">Lazy Parsing in JavaScript Engines</h1></div>
							
							<p class="meta"><time datetime="2012-07-3" pubdate="">July 3, 2012</time>.</p>
							<p class="tags"><span class="tags-title">Tags:</span> <a href="http://ariya.ofilabs.com/tag/javascript" rel="tag">javascript</a> <a href="http://ariya.ofilabs.com/tag/javascriptcore" rel="tag">javascriptcore</a> <a href="http://ariya.ofilabs.com/tag/optimization" rel="tag">optimization</a> <a href="http://ariya.ofilabs.com/tag/spidermonkey" rel="tag">spidermonkey</a> <a href="http://ariya.ofilabs.com/tag/v8" rel="tag">v8</a></p>							

						
						</header> <!-- end article header -->
					
						<section class="post_content clearfix" itemprop="articleBody">
							<p class="lead">Modern JavaScript engines can defer the parsing process of a function body until it is completely needed. Why is this done and how does this work?</p>
<p>The last blog post titled <a href="http://blogs.msdn.com/b/ie/archive/2012/06/13/advances-in-javascript-performance-in-ie10-and-windows-8.aspx">Advances in JavaScript Performance in IE10 and Windows 8</a> from the Internet Explorer team mentions the use of deferred parsing to improve the performance. In fact, the stable IE 9 already implements such optimization while IE 10 improves it further to take account the popular module pattern. According to team (Chakra refers to the JavaScript engine used in IE):</p>
<blockquote><p>
To further reduce the time to first executed instruction, Chakra processes and emits bytecode only for functions that are about to be executed using a mechanism called deferred parsing.
</p></blockquote>
<p>Let’s have a simplified example to see how this works. Supposed your web application looks like the following JavaScript code.</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #000066; font-weight: bold;">function</span> add<span style="color: #009900;">(</span>x<span style="color: #339933;">,</span> y<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> <span style="color: #000066; font-weight: bold;">return</span> x <span style="color: #339933;">+</span> y<span style="color: #339933;">;</span> <span style="color: #009900;">}</span>
<span style="color: #000066; font-weight: bold;">function</span> mul<span style="color: #009900;">(</span>x<span style="color: #339933;">,</span> y<span style="color: #009900;">)</span> <span style="color: #009900;">{</span> <span style="color: #000066; font-weight: bold;">return</span> x <span style="color: #339933;">*</span> y<span style="color: #339933;">;</span> <span style="color: #009900;">}</span>
alert<span style="color: #009900;">(</span>add<span style="color: #009900;">(</span><span style="color: #CC0000;">40</span><span style="color: #339933;">,</span> <span style="color: #CC0000;">2</span><span style="color: #009900;">)</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre></td></tr></table></div>

<p>Before the engine can execute the code, it has to feed the source into its <a href="http://en.wikipedia.org/wiki/Parser">parser</a>. The purpose of the parser is to perform the syntactic analysis and to produce an <a href="http://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract syntax tree</a> (AST). For an illustrative example on how the syntax tree may look like, you can use the online <a href="http://esprima.org/demo/parse.html">parser demo</a> of Esprima (a JavaScript parser project I have <a href="http://ariya.ofilabs.com/2011/12/introducing-esprima.html" title="introducing esprima: blazing-fast javascript parser">started</a> some months ago). The full syntax tree will be quite complex, but if we translate the work of the parser to plain English, this is what happens:</p>
<blockquote><p>
Declare a function called <em>add</em>. It accepts x and y as the arguments. It has one statement, a return statement.The return value is a binary operation + of x and y.<br />
Declare a function called <em>mul</em>. It accepts x and y as the arguments. It has one statement, a return statement. The return value is a binary operation * of x and y.<br />
Create a function call to <em>alert</em>. The argument is the result of function <em>add</em> with 40 and 2 as the arguments.
</p></blockquote>
<p>Based on this syntax tree, some more magic occurs. At the end of the day, when the interpreter executes your code, it pops-up the dialog with <a href="http://en.wikipedia.org/wiki/Phrases_from_The_Hitchhiker's_Guide_to_the_Galaxy#The_number_42">the answer</a>. Now, if you pay attention carefully, there is a wasted step from the above work of the parser, namely the effort to parse function <em>mul</em> because it is not being called at all, the later <em>alert</em> only invokes function <em>add</em>. While this example might be really simple and obvious, in real-world (according to Microsoft <a href="http://research.microsoft.com/en-us/projects/jsmeter/">JSMeter research</a>), a lot of declared functions are never called at all.</p>
<p>Instead of dutifully parsing everything at one, modern JavaScript engine uses the <strong>lazy parsing</strong> approach. The work of the parser changes into something like:</p>
<blockquote><p>
Declare a function call <em>add</em> with the function body “{ return x + y; }”.<br />
Declare a function call <em>mul</em> with the function body “{ return x * y; }”.<br />
Call <em>alert</em> with the result of function add with 40 and 2 as the arguments.
</p></blockquote>
<p>Here the parser does not bother to go deep into the statements of each and every function. At the execution stage, the sequence continues:</p>
<blockquote><p>
Call function <em>add</em>. Hmm, it is not parsed yet. Call the real parser for “{ return x + y; }”.<br />
  It accepts x and y as the arguments. The return value is a binary operation + of x and y.
</p></blockquote>
<p>Basically the task of parsing the source for that function is <em>deferred</em>, it is only carried out when it is necessary, right before executing it. The lazy parser still needs to parse the incoming source because it needs to locate the entire function body. If you see <code>function add(x, y) {</code> then you need to locate the matching <code>}</code> which ends the function body. It can’t be done by regular expression or any form of scanning, the parser needs to consume the code as if it is a real code. The good news is that the parser does not need to do much beside trying to find that closing curly brace. This means it can optimize a certain thing. For a start, we do not need the syntax tree because it is not going to be processed by anyone. In addition, the code path does not need to use any memory from the heap. Allocating memory eats the system resource, avoiding it will lead to a speed-up.</p>
<p>Here is an analogy in real-life. You stumble upon a nice article (maybe this blog post) but then you realize that you only want to read it later when you need it. You decide to stash the text (digitally of course) in your note. You still have to scan the blog post to find out where it starts and where it ends, though you can do this scanning rather quickly (faster than reading the entire text). Once you get the start and the end markers, you can just select the text, copy it to the clipboard, switch to the note application, and finally paste the content. When it is finally the time to use the information in to the article, you open the note and complete the reading.</p>
<p>Let’s compare some hypothetical code to parse a <em>while</em> statement. As you already know, this statement has the following grammar:</p>
<blockquote><p>
‘while’ ‘(‘ Expression ‘)’ Statement
</p></blockquote>
<p>The real parser needs to understand this and produce an abstract syntax tree (AST) which represents the construct. The code for doing that, if it would have been in JavaScript, may look like:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #000066; font-weight: bold;">function</span> realParseWhileStatement<span style="color: #009900;">(</span><span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
  expect<span style="color: #009900;">(</span><span style="color: #3366CC;">'while'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  expect<span style="color: #009900;">(</span><span style="color: #3366CC;">'('</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #000066; font-weight: bold;">var</span> expression <span style="color: #339933;">=</span> parseExpression<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  expect<span style="color: #009900;">(</span><span style="color: #3366CC;">')'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  <span style="color: #000066; font-weight: bold;">var</span> statement <span style="color: #339933;">=</span> parseStatement<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
&nbsp;
  <span style="color: #006600; font-style: italic;">// node for the AST</span>
  <span style="color: #000066; font-weight: bold;">return</span> <span style="color: #009900;">{</span>
    type<span style="color: #339933;">:</span> <span style="color: #3366CC;">'WhileStatement'</span><span style="color: #339933;">,</span>
    test<span style="color: #339933;">:</span> expression<span style="color: #339933;">,</span>
    body<span style="color: #339933;">:</span> statement
  <span style="color: #009900;">}</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td></tr></table></div>

<p>In the case of lazy parsing, we don’t care about the result and thus the code is simplified to:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #000066; font-weight: bold;">function</span> lazyParseWhileStatement<span style="color: #009900;">(</span><span style="color: #009900;">)</span>
<span style="color: #009900;">{</span>
  expect<span style="color: #009900;">(</span><span style="color: #3366CC;">'while'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  expect<span style="color: #009900;">(</span><span style="color: #3366CC;">'('</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  parseExpression<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  expect<span style="color: #009900;">(</span><span style="color: #3366CC;">')'</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
  parseStatement<span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span>
<span style="color: #009900;">}</span></pre></td></tr></table></div>

<p>Obviously there are other functions to parse various constructs as specified in the grammar. The bottom line is that the parser has to consume all the tokens and advances as farther as it can until the function body is completed. That way, it knows where is the closing curly brace to to match the opening curly brace that starts the function body.</p>
<p>What if during lazy parsing we stumble upon another nested function declaration? The same rule applies and therefore that function will be lazily parsed. <em>Function Inception</em>, anyone?</p>
<p>In reality, lazy parser can be slightly complicated, this involves handling strict mode properly, making sure parsing error is taken care, avoiding stack overflow (for recursive descent parser), and many other delicate situations.</p>
<p>Let’s see how this lazy parsing approach is implemented in two popular JavaScript engines.</p>
<p>First, we look at <strong><a href="http://trac.webkit.org/wiki/JavaScriptCore">JavaScriptCore</a></strong> (JSC), the engine used in WebKit and powers the popular Apple Safari browser (desktop and mobile). The source code for JavaScriptCore resides in <code>Source/JavaScriptCore</code> subdirectory, if you check out WebKit code. The files relevant to the lazy parsers are:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="make" style="font-family:monospace;">parser<span style="color: #004400;">/</span>Parser<span style="color: #004400;">.</span>h
parser<span style="color: #004400;">/</span>Parser<span style="color: #004400;">.</span>cpp
parser<span style="color: #004400;">/</span>SyntaxChecker<span style="color: #004400;">.</span>h</pre></td></tr></table></div>

<p>The normal parser and the lazy parser in JavaScriptCore are essentially the same code, the specialization is done through C++ template. The parser itself does not construct a syntax tree, the job is delegated to a <code>TreeBuilder</code>. There are two builders available, <code>ASTBuilder</code> and <code>SyntaxChecker</code>. The latter essentially does nothing, but since it is driven by the parser, the parser can go forward and consume the constructs to any point it wants to stop. It acts as some kind of syntax checker, hence the name.</p>
<p>JSC parser uses the SyntaxChecker builder whenever it needs to parse a function body, see <code>parseFunctionBody</code>, which gets called from <code>parseFunctionInfo</code> (this leads to a funny variable name in the code, <em>FunctionBodyBuilder</em>). After the syntax checker stops at then of the function body, the range which scopes the curly braces will be stored, this is needed when the real parsing kicks in at some later stage, i.e. when that function is invoked. Because JSC keeps the entire source, storing the range is sufficient and there is no need to copy the source string.</p>
<p>The situation is similar in <strong><a href="https://code.google.com/p/v8/">V8</a></strong>, the JavaScript engine used in Google Chrome and Node.js. Files related to the lazy parsing in V8 source code are:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="make" style="font-family:monospace;">src<span style="color: #004400;">/</span>preparser<span style="color: #004400;">.</span>cc
src<span style="color: #004400;">/</span>preparser<span style="color: #004400;">.</span>h
src<span style="color: #004400;">/</span>preparser<span style="color: #004400;">-</span>api<span style="color: #004400;">.</span>cc</pre></td></tr></table></div>

<p>Unlike JSC, V8 has two different code base (but with similar interface) for the normal parser and the lazy parser. The latter is called <em>PreParser</em> in V8 terminology. This PreParser kicks in when V8 encounters a function body during the parsing, i.e <code>Parser::ParseFunctionLiteral</code>. Interesting enough, V8 does an optimization for a special case. This is the case for <a href="http://benalman.com/news/2010/11/immediately-invoked-function-expression/">immediately invoked function expression</a>, a pattern popular to provide better <a href="http://addyosmani.com/blog/essential-js-namespacing/">namespacing</a> without polluting the global and therefore perfect to implement a module, e.g.:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="javascript" style="font-family:monospace;"><span style="color: #000066; font-weight: bold;">var</span> foobar <span style="color: #339933;">=</span> <span style="color: #009900;">(</span><span style="color: #000066; font-weight: bold;">function</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span> <span style="color: #009900;">{</span>
    <span style="color: #006600; font-style: italic;">//  do something</span>
    <span style="color: #006600; font-style: italic;">//  return the module object</span>
<span style="color: #009900;">}</span><span style="color: #009900;">)</span><span style="color: #009900;">(</span><span style="color: #009900;">)</span><span style="color: #339933;">;</span></pre></td></tr></table></div>

<p>Because this pattern is quite common nowadays, V8 detects the usage using a simple heuristic: if there is <code>(</code> before <code>function</code>, then forget the lazy parsing and do the real parsing. In the above example, V8 will produce a syntax tree for the statements inside the function.</p>
<p>What about <strong><a href="https://developer.mozilla.org/en/SpiderMonkey">SpiderMonkey</a></strong>, Mozilla JavaScript engine used in Firefox? Lazy parsing is not there yet but it is being implemented, just track Mozilla <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=678037">bug 678037</a>. This will be another awesome move to improve Firefox performance.</p>
<p>Last but not least, since this blog post is quite long, you might just quickly scan it and read it later. That’s called deferred reading!</p>
<div class="related-posts">
<div id="related-posts-MRP_all" class="related-posts-type">
<h4>Related Posts:</h4>
<ul>
<li><a href="http://ariya.ofilabs.com/2013/04/automatic-inlining-in-javascript-engines.html">Automatic Inlining in JavaScript Engines</a></li>
<li><a href="http://ariya.ofilabs.com/2012/11/optimization-journey-vs-destination.html">Optimization: Journey vs Destination</a></li>
<li><a href="http://ariya.ofilabs.com/2012/08/determining-objects-in-a-set-examples-in-javascript.html">Determining Objects in a Set: Examples in JavaScript </a></li>
<li><a href="http://ariya.ofilabs.com/2011/12/introducing-esprima.html">introducing esprima: blazing-fast javascript parser</a></li>
<li><a href="http://ariya.ofilabs.com/2011/08/math-evaluator-in-javascript-part-2.html">math expression evaluator in javascript: part 2 (parser)</a></li>
</ul></div>
</div>							
												
						</section> <!-- end article section -->
						
						<footer>
			
														
						</footer> <!-- end article footer -->
					
					</article> <!-- end article -->
					
					
<div id="disqus_thread">
                    <div id="dsq-content">


            <ul id="dsq-comments">
                    <li class="comment even thread-even depth-1" id="dsq-comment-3709">
        <div id="dsq-comment-header-3709" class="dsq-comment-header">
            <cite id="dsq-cite-3709">
                <span id="dsq-author-user-3709">Bertjan</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3709" class="dsq-comment-body">
            <div id="dsq-comment-message-3709" class="dsq-comment-message"><p>Nitpick:</p>
<p>Declare a function call&nbsp;mul&nbsp;with the function body “{ return x + y; }”.&nbsp;</p>
<p>That must be a * in stead of +. Other than that, interesting read!</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-3710">
        <div id="dsq-comment-header-3710" class="dsq-comment-header">
            <cite id="dsq-cite-3710">
http://ariya.ofilabs.com/                <span id="dsq-author-user-3710">Ariya Hidayat</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3710" class="dsq-comment-body">
            <div id="dsq-comment-message-3710" class="dsq-comment-message"><p>Fixed! Thanks for the notice.</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-3711">
        <div id="dsq-comment-header-3711" class="dsq-comment-header">
            <cite id="dsq-cite-3711">
                <span id="dsq-author-user-3711">Nicolás Granelli</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3711" class="dsq-comment-body">
            <div id="dsq-comment-message-3711" class="dsq-comment-message"><p>I will ask you a question somewhat related (I hope you can give me your opinion):&nbsp;</p>
<p>I started to build a complex javascript application that in some parts needs to generate javascript code. Right now I’m just doing a prototype, and I found 2 ways of generating the code: the first one is with a simple underscore template, and the second one is using esprima and&nbsp;escodegen. In the second case I think the&nbsp;easiest way is to generate a tree with the parsing demo, and then based on that tree generate the code.&nbsp;</p>
<p>What do you think? what is the best option in the long run? is any other way I don’t know about?</p>
<p>Thanks <img src="http://ariya.ofilabs.com/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley" /> &nbsp;</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-3712">
        <div id="dsq-comment-header-3712" class="dsq-comment-header">
            <cite id="dsq-cite-3712">
http://ariya.ofilabs.com/                <span id="dsq-author-user-3712">Ariya Hidayat</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3712" class="dsq-comment-body">
            <div id="dsq-comment-message-3712" class="dsq-comment-message"><p>I believe using a syntax tree as an intermediate step will be better. If something is wrong, you can debug it easily.</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-even depth-1" id="dsq-comment-3714">
        <div id="dsq-comment-header-3714" class="dsq-comment-header">
            <cite id="dsq-cite-3714">
http://about.me/kpobococ                <span id="dsq-author-user-3714">Anton Suprun</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3714" class="dsq-comment-body">
            <div id="dsq-comment-message-3714" class="dsq-comment-message"><p>&gt; expect(‘)’;</p>
<p>NO! <img src="http://ariya.ofilabs.com/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley" /> </p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-3717">
        <div id="dsq-comment-header-3717" class="dsq-comment-header">
            <cite id="dsq-cite-3717">
http://twitter.com/ariyahidayat                <span id="dsq-author-user-3717">Ariya Hidayat</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3717" class="dsq-comment-body">
            <div id="dsq-comment-message-3717" class="dsq-comment-message"><p>Corrected. Thanks for the notice!</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-3715">
        <div id="dsq-comment-header-3715" class="dsq-comment-header">
            <cite id="dsq-cite-3715">
                <span id="dsq-author-user-3715">Zack</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3715" class="dsq-comment-body">
            <div id="dsq-comment-message-3715" class="dsq-comment-message"><p>Nitpick:</p>
<p>Your immediately invoked function expression snippet is missing the invocation, and is merely an expression. You would need something like</p>
<p>`(function () { /* … */ })()`</p>
<p>Or, to avoid the syntax ugliness Crockford calls “dog balls”:</p>
<p>`(function () { /* … */ }())`</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-3716">
        <div id="dsq-comment-header-3716" class="dsq-comment-header">
            <cite id="dsq-cite-3716">
http://twitter.com/ariyahidayat                <span id="dsq-author-user-3716">Ariya Hidayat</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3716" class="dsq-comment-body">
            <div id="dsq-comment-message-3716" class="dsq-comment-message"><p>Fixed. Thanks for the notice!</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-even depth-1" id="dsq-comment-3802">
        <div id="dsq-comment-header-3802" class="dsq-comment-header">
            <cite id="dsq-cite-3802">
                <span id="dsq-author-user-3802">Peter van der Zee</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3802" class="dsq-comment-body">
            <div id="dsq-comment-message-3802" class="dsq-comment-message"><p>I would be surprised if they really throw away the results of pre-parsing function bodies. You need to go through the functions (both for validation of early errors and to properly find the range of the function body). This means you’re already doing some of the hard expensive parts of the code, anyways. If they would throw away that, they’d have to do the work twice for functions.</p>
<p>I would instead expect them to cache a simple parse tree and leave out the static analysis until first call (or until such time that the browser is considered idle when not called before). Then the parse tree can be fed to whatever deep analysis/JIT engine and would not have to parse the source code anymore but work with tokens and assume an at least validated structure.</p>
<p>I’m always confused by the text in the spec about unparsed functions. You have to parse the source to get to the end. You can’t just “guess” the end. Sigh.</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-3887">
        <div id="dsq-comment-header-3887" class="dsq-comment-header">
            <cite id="dsq-cite-3887">
http://ariya.ofilabs.com/                <span id="dsq-author-user-3887">Ariya Hidayat</span>
            </cite>
        </div>
        <div id="dsq-comment-body-3887" class="dsq-comment-body">
            <div id="dsq-comment-message-3887" class="dsq-comment-message"><p>What I wrote in the blog post is exactly what happens with JavaScriptCore and V8. There is no cached syntax tree. Beside, validating a function body is fast because there is no need to allocate memory from heap. If there is a syntax error, you need to bail out immediately anyway.</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
    <li class="comment even thread-odd thread-alt depth-1" id="dsq-comment-4068">
        <div id="dsq-comment-header-4068" class="dsq-comment-header">
            <cite id="dsq-cite-4068">
                <span id="dsq-author-user-4068">ziyunfei</span>
            </cite>
        </div>
        <div id="dsq-comment-body-4068" class="dsq-comment-body">
            <div id="dsq-comment-message-4068" class="dsq-comment-message"><p>I don’t really understand,each function(lazy parsed) is parsed twice?it’s just the first time doesn’t save that function’s AST</p>
</div>
        </div>

    <ul class="children">
    <li class="comment odd alt depth-2" id="dsq-comment-4069">
        <div id="dsq-comment-header-4069" class="dsq-comment-header">
            <cite id="dsq-cite-4069">
http://ariya.ofilabs.com/                <span id="dsq-author-user-4069">Ariya Hidayat</span>
            </cite>
        </div>
        <div id="dsq-comment-body-4069" class="dsq-comment-body">
            <div id="dsq-comment-message-4069" class="dsq-comment-message"><p>That’s correct. The first parsing was very simplified.</p>
</div>
        </div>

    </li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
            </ul>


        </div>

    </div>

<script type="text/javascript">
/* <![CDATA[ */
    var disqus_url = 'http://ariya.ofilabs.com/2012/07/lazy-parsing-in-javascript-engines.html';
    var disqus_identifier = '841 http://ariya.ofilabs.com/?p=841';
    var disqus_container_id = 'disqus_thread';
    var disqus_domain = 'disqus.com';
    var disqus_shortname = 'ariya';
    var disqus_title = "Lazy Parsing in JavaScript Engines";
        var disqus_config = function () {
        var config = this; // Access to the config object
        config.language = '';

        /*
           All currently supported events:
            * preData — fires just before we request for initial data
            * preInit - fires after we get initial data but before we load any dependencies
            * onInit  - fires when all dependencies are resolved but before dtpl template is rendered
            * afterRender - fires when template is rendered but before we show it
            * onReady - everything is done
         */

        config.callbacks.preData.push(function() {
            // clear out the container (its filled for SEO/legacy purposes)
            document.getElementById(disqus_container_id).innerHTML = '';
        });
                config.callbacks.onReady.push(function() {
            // sync comments in the background so we don't block the page
            var script = document.createElement('script');
            script.async = true;
            script.src = '?cf_action=sync_comments&post_id=841';

            var firstScript = document.getElementsByTagName( "script" )[0];
            firstScript.parentNode.insertBefore(script, firstScript);
        });
                    };
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
    var DsqLocal = {
        'trackbacks': [
        ],
        'trackback_url': "http:\/\/ariya.ofilabs.com\/2012\/07\/lazy-parsing-in-javascript-engines.html\/trackback"    };
/* ]]> */
</script>

<script type="text/javascript">
/* <![CDATA[ */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.' + 'disqus.com' + '/embed.js?pname=wordpress&pver=2.74';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
/* ]]> */
</script>
					
								
					
								
				</div> <!-- end #main -->
    
								<div id="sidebar1" class="fluid-sidebar sidebar span4" role="complementary">
				
					
						<div id="search-2" class="widget widget_search"><form role="search" method="get" id="searchform" action="http://ariya.ofilabs.com/">
    <label class="screen-reader-text" for="s">Search for:</label>
    <input type="text" value="" name="s" id="s" placeholder="Search the Site..." />
    <input type="submit" id="searchsubmit" value="Search" />
    </form></div><div id="text-3" class="widget widget_text"><h4 class="widgettitle">whoami</h4>			<div class="textwidget"><p>My name is <strong>Ariya Hidayat</strong>. These days, I promote <strong>software craftsmanship</strong>, JavaScript, HTML5, CSS3, and general web technologies. I <a href="/highlights">write</a> blog posts regularly and <a href="/talks">speak</a> at developer events from time to time.</p>
<p>I am a <a href="/about">big believer</a> in sharing and openness. I have been involved with FOSS (free/open-source software), contributing code to projects such as KDE, Qt, and WebKit. In my little spare time, I also run <a href="/projects">projects</a> such as <a href="http://phantomjs.org">PhantomJS</a> (browser automation) and <a href="http://esprima.org">Esprima</a> (JavaScript parser).</p>
</div>
		</div>		<div id="recent-posts-2" class="widget widget_recent_entries">		<h4 class="widgettitle">Recent Posts</h4>		<ul>
					<li>
				<a href="http://ariya.ofilabs.com/2013/09/the-fabulous-edge-new-york-2013.html" title="The Fabulous Edge New York 2013">The Fabulous Edge New York 2013</a>
						</li>
					<li>
				<a href="http://ariya.ofilabs.com/2013/09/fast-forward-git-merge.html" title="Fast-Forward Git Merge">Fast-Forward Git Merge</a>
						</li>
					<li>
				<a href="http://ariya.ofilabs.com/2013/09/scope-analysis-for-javascript-code.html" title="Scope Analysis for JavaScript Code">Scope Analysis for JavaScript Code</a>
						</li>
					<li>
				<a href="http://ariya.ofilabs.com/2013/09/autumn-2013-conferences.html" title="Autumn 2013 Conferences">Autumn 2013 Conferences</a>
						</li>
					<li>
				<a href="http://ariya.ofilabs.com/2013/08/2013-nexus-7-javascript-performance-quick-check.html" title="2013 Nexus 7 JavaScript Performance Quick Check">2013 Nexus 7 JavaScript Performance Quick Check</a>
						</li>
					<li>
				<a href="http://ariya.ofilabs.com/2013/08/searching-with-array-prototype-some.html" title="Searching with Array.prototype.some">Searching with Array.prototype.some</a>
						</li>
					<li>
				<a href="http://ariya.ofilabs.com/2013/08/javascript-kinetic-scrolling-part-1.html" title="JavaScript Kinetic Scrolling: Part 1">JavaScript Kinetic Scrolling: Part 1</a>
						</li>
					<li>
				<a href="http://ariya.ofilabs.com/2013/08/continuous-painting-mode-in-chrome.html" title="Continuous Painting Mode in Chrome">Continuous Painting Mode in Chrome</a>
						</li>
					<li>
				<a href="http://ariya.ofilabs.com/2013/07/encouraging-shorter-tech-talk.html" title="Encouraging Shorter Tech Talk">Encouraging Shorter Tech Talk</a>
						</li>
					<li>
				<a href="http://ariya.ofilabs.com/2013/07/profile-guided-javascript-optimization.html" title="Profile-Guided JavaScript Optimization">Profile-Guided JavaScript Optimization</a>
						</li>
				</ul>
		</div><div id="rss_links-2" class="widget widget_rss_links"><p><a href="http://ariya.ofilabs.com/feed" title="Subscribe to Posts"><img src="http://ariya.ofilabs.com/wp-content/plugins/jetpack/_inc/images/rss/green-small.png" alt="RSS Feed" /></a>&nbsp;<a href="http://ariya.ofilabs.com/feed" title="Subscribe to Posts">RSS - Posts</a></p>
</div><div id="text-4" class="widget widget_text"><h4 class="widgettitle">Notice</h4>			<div class="textwidget">This blog is my personal space. Unless otherwise noted, I don't discuss activities related to my professional work. All opinions expressed in this blog are my own and do not necessarily represent the official view of my employer.
</div>
		</div><div id="calendar-3" class="widget widget_calendar"><div id="calendar_wrap"><table id="wp-calendar">
	<caption>July 2012</caption>
	<thead>
	<tr>
		<th scope="col" title="Monday">M</th>
		<th scope="col" title="Tuesday">T</th>
		<th scope="col" title="Wednesday">W</th>
		<th scope="col" title="Thursday">T</th>
		<th scope="col" title="Friday">F</th>
		<th scope="col" title="Saturday">S</th>
		<th scope="col" title="Sunday">S</th>
	</tr>
	</thead>

	<tfoot>
	<tr>
		<td colspan="3" id="prev"><a href="http://ariya.ofilabs.com/2012/06" title="View posts for June 2012">« Jun</a></td>
		<td class="pad">&nbsp;</td>
		<td colspan="3" id="next"><a href="http://ariya.ofilabs.com/2012/08" title="View posts for August 2012">Aug »</a></td>
	</tr>
	</tfoot>

	<tbody>
	<tr>
		<td colspan="6" class="pad">&nbsp;</td><td>1</td>
	</tr>
	<tr>
		<td>2</td><td><a href="http://ariya.ofilabs.com/2012/07/03" title="Lazy Parsing in JavaScript Engines">3</a></td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td>
	</tr>
	<tr>
		<td>9</td><td><a href="http://ariya.ofilabs.com/2012/07/10" title="JavaScript Code Editing with Autocompletion in Eclipse Orion">10</a></td><td>11</td><td><a href="http://ariya.ofilabs.com/2012/07/12" title="Mac OS X: Tracking Disk I/O Activities">12</a></td><td>13</td><td>14</td><td>15</td>
	</tr>
	<tr>
		<td>16</td><td><a href="http://ariya.ofilabs.com/2012/07/17" title="Dolphin Engine for Android: First Look">17</a></td><td><a href="http://ariya.ofilabs.com/2012/07/18" title="Behind Esprima: Fast, Readable, Heavily Tested, Error Tolerant, Forward Looking">18</a></td><td>19</td><td>20</td><td>21</td><td>22</td>
	</tr>
	<tr>
		<td><a href="http://ariya.ofilabs.com/2012/07/23" title="Most Popular JavaScript Tokens">23</a></td><td>24</td><td>25</td><td>26</td><td>27</td><td>28</td><td>29</td>
	</tr>
	<tr>
		<td><a href="http://ariya.ofilabs.com/2012/07/30" title="Cloud PhantomJS with IronWorker">30</a></td><td>31</td>
		<td class="pad" colspan="5">&nbsp;</td>
	</tr>
	</tbody>
	</table></div></div>
					
				</div>    
			</div> <!-- end #content -->

			<footer role="contentinfo">
			
				<div id="inner-footer" class="clearfix">
		          <hr />
		          <div id="widget-footer" class="clearfix row-fluid">
		            		<div id="recent-posts-3" class="widget span4 widget_recent_entries">		<h4 class="widgettitle">Recent Posts</h4>		<ul>
					<li>
				<a href="http://ariya.ofilabs.com/2013/09/the-fabulous-edge-new-york-2013.html" title="The Fabulous Edge New York 2013">The Fabulous Edge New York 2013</a>
						</li>
					<li>
				<a href="http://ariya.ofilabs.com/2013/09/fast-forward-git-merge.html" title="Fast-Forward Git Merge">Fast-Forward Git Merge</a>
						</li>
					<li>
				<a href="http://ariya.ofilabs.com/2013/09/scope-analysis-for-javascript-code.html" title="Scope Analysis for JavaScript Code">Scope Analysis for JavaScript Code</a>
						</li>
					<li>
				<a href="http://ariya.ofilabs.com/2013/09/autumn-2013-conferences.html" title="Autumn 2013 Conferences">Autumn 2013 Conferences</a>
						</li>
					<li>
				<a href="http://ariya.ofilabs.com/2013/08/2013-nexus-7-javascript-performance-quick-check.html" title="2013 Nexus 7 JavaScript Performance Quick Check">2013 Nexus 7 JavaScript Performance Quick Check</a>
						</li>
				</ul>
		</div>		            <div id="text-5" class="widget span4 widget_text"><h4 class="widgettitle">Imprint</h4>			<div class="textwidget">Certain links, including hypertext links, in my blog will take you outside my blog. Links are provided for your convenience and inclusion of any link does not imply endorsement or approval of the linked site, its operator or its content. I am not responsible for the content of any website outside of my blog.</div>
		</div>		            <div id="blog_subscription-2" class="widget span4 jetpack_subscription_widget"><h4 class="widgettitle"><label for="subscribe-field">Subscribe</label></h4>
		<form action="" method="post" accept-charset="utf-8" id="subscribe-blog-blog_subscription-2">
			<p>Enter your email address to subscribe to this blog and receive notifications of new posts by email.</p>
			<p><input type="text" name="email" style="width: 95%; padding: 1px 2px" value="Email Address" id="subscribe-field" onclick="if ( this.value == 'Email Address' ) { this.value = ''; }" onblur="if ( this.value == '' ) { this.value = 'Email Address'; }" /></p>

			<p>
				<input type="hidden" name="action" value="subscribe" />
				<input type="hidden" name="source" value="http://ariya.ofilabs.com/2012/07/lazy-parsing-in-javascript-engines.html" />
				<input type="hidden" name="sub-type" value="widget" />
				<input type="hidden" name="redirect_fragment" value="blog_subscription-2" />
								<input type="submit" value="Subscribe" name="jetpack_subscriptions_widget" />
			</p>
		</form>

		
</div>		          </div>
					
					<nav class="clearfix">
											</nav>
					
					<p class="pull-right"><a href="http://320press.com" id="credit320" title="By the dudes of 320press">320press</a></p>
			
					<p class="attribution">© 2005-2013 Ariya Hidayat</p>
				
				</div> <!-- end #inner-footer -->
				
			</footer> <!-- end footer -->
		
		</div> <!-- end #container -->
				
		<!--[if lt IE 7 ]>
  			<script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
  			<script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
		<![endif]-->
		
			<div style="display:none">
	</div>
<script type="text/javascript" src="http://s0.wp.com/wp-content/js/devicepx-jetpack.js?ver=201340"></script>
<script type="text/javascript" src="http://s.gravatar.com/js/gprofiles.js?ver=2013Octaa"></script>
<script type="text/javascript">
/* <![CDATA[ */
var WPGroHo = {"my_hash":""};
/* ]]> */
</script>
<script type="text/javascript" src="http://ariya.ofilabs.com/wp-content/plugins/jetpack/modules/wpgroho.js?ver=3.6.1"></script>

	<script src="http://stats.wordpress.com/e-201340.js" type="text/javascript"></script>
	<script type="text/javascript">
	st_go({v:'ext',j:'1:2.5',blog:'34693317',post:'841',tz:'-7'});
	var load_cmc = function(){linktracker_init(34693317,841,2);};
	if ( typeof addLoadEvent != 'undefined' ) addLoadEvent(load_cmc);
	else load_cmc();
	</script>
	<div>
<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
<script src="../js/clearly.js"></script>
<script>var html = window.__getMyClearlyResults().html;$("html").html(html);$("html").show()</script>
</div></body>

</html>